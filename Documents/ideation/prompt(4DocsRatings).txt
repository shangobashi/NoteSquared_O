<prompt>
<instruction>

'''
Rate these 4 Documents repo created in order to enable a Software Engineering team made of AI Agents to create an MVP for an App. The idea of the app is provided in a pdf file for you to check. Rate on a scale of 10. Explain the reason of your ratings. 
'''

</instruction>
<exampleAlpha>

Project Codename: Note By Note
Objective: Build a cross-platform MVP (iOS & Web) that automates post-lesson documentation for music teachers using Audio AI.

1. Product Requirements Document (PRD)
1.1. Problem Statement
Music teachers face a critical administrative bottleneck: they spend hours after lessons writing notes, practice plans, and parent emails. This leads to burnout and unpaid labor late into the night.





1.2. Solution Overview
A mobile and web application that listens to the lesson, transcribes it, and automatically generates three distinct outputs for the teacher to review and send.


1.3. User Personas

Solo Teacher: Needs quick efficiency; pricing model $49/month.


Studio Owner: Needs multi-student management; pricing model $99/month.

1.4. Core Functional Requirements (MVP)

Audio Capture: One-tap recording functionality on mobile and web.



AI Transcription: Utilize OpenAI Whisper to transcribe the audio session.


Intelligence Layer: An LLM processes the transcript to extract specific musical data (mistakes, techniques, tempo targets, assignments).

Generation Engine: Automatically generate three specific documents per session:


Student Recap: Highlights wins and areas for improvement.


Practice Plan: Broken down into daily assignments (e.g., "Monday: C major scales").



Parent Email: A summary of progress and gentle nudges.



Review Flow: A clean interface ("Output Screen") allowing the teacher to edit generated text before finalizing.

Historical Storage: Database of past lessons and students.

1.5. Non-Functional Requirements
UI/UX: "Sleek and clean" aesthetic. Dark mode is mandatory (teachers work late at night).

Latency: Transcription + Generation should take < 60 seconds for a standard lesson segment.

Test Coverage: Minimum 80% unit and integration test coverage.

2. System Architecture & Tech Stack
To maximize efficiency and reach the "Elegant" UI goal, the AI team will utilize a unified codebase for frontend and a robust backend for AI processing.

Frontend (Mobile + Web): React Native (via Expo).

Reasoning: Allows deploying to iOS and Web from a single codebase (Efficiency). Expo Router for navigation.

UI Library: Tamagui or NativeWind (Tailwind for React Native) to ensure professional, sleek styling.

Backend API: FastAPI (Python).

Reasoning: Native support for AI libraries and high performance.

Database: PostgreSQL (via Supabase).

AI Services:


Transcription: OpenAI Whisper API.

Reasoning/Generation: OpenAI GPT-4o.

DevOps/CI: GitHub Actions for automated testing.

3. AI Agent Implementation Steps (The "How-To")
The AI agents should execute the following phases sequentially.

Phase 1: Foundation & Database Schema
Prompt for Database Agent: "Create a Supabase PostgreSQL schema. Tables required:


users (teachers) - differentiate between Solo and Studio tiers.

students (linked to users).

lessons (stores audio_url, transcript_text, timestamp).


outputs (stores the 3 generated text blocks: recap, plan, email).


templates (stores tone/style prompts tuned to how teachers talk)."

Phase 2: Backend Logic (FastAPI)
Prompt for Backend Agent: "Build a FastAPI service with an endpoint /process-lesson.

Accept audio file upload.

Send audio to OpenAI Whisper for transcription.

Feed transcript to LLM with a system prompt that extracts:

Mistakes corrected.

Techniques introduced.

Pieces assigned.

Tempo targets.

Return JSON containing three distinct fields: student_recap, practice_plan, parent_email.

Ensure 80% test coverage using pytest."

Phase 3: Frontend UI/UX (React Native/Expo)
Prompt for Frontend Agent: "Build a sleek mobile-first interface.

Home Screen: List of students.


Lesson Screen: A prominent, massive 'Record' button.

Review Screen: A clean output screen displaying the 3 generated text blocks. Each block must be editable text areas.

Style Guide: Use dark mode by default. Minimalist typography."

4. System Prompts for the LLM (The "Brain")
To ensure the app "listens so teachers don't have to write", the internal prompts must be precise.

File: prompts/music_teacher_generation.txt

Plaintext

ROLE: You are an expert music teacher assistant.
INPUT: A transcript of a music lesson.
TASK: Generate three distinct outputs based on the transcript.

1. STUDENT RECAP:
   - Tone: Encouraging but specific.
   - Highlight specific "wins" and "areas to work on".

2. PRACTICE PLAN:
   - Format: Broken into daily assignments.
   - Example style: "Monday: C major scales, 10 minutes. Tuesday: measures 5-8..."[cite: 3].
   - Include tempo targets if mentioned.

3. PARENT EMAIL:
   - Tone: Professional, summarising progress, gentle nudges[cite: 5].
   - Keep it brief.

CONSTRAINT: The output must sound like a human teacher, not a robot. Use the provided "Teacher Tone" templates.
5. Repository README.md
This file serves as the context anchor for the AI Agents to begin work.

Markdown

# Note By Note - AI Practice Plan Generator

## Overview
[cite_start]An AI-powered tool for music teachers to record lessons and automatically generate student recaps, practice plans, and parent emails[cite: 1, 8].

## Core Features
- [cite_start]**Audio Recording:** Simple record interface.
- [cite_start]**AI Processing:** Whisper Transcription + LLM Extraction[cite: 10, 11].
- [cite_start]**3-Output Generation:** Recap, Plan, Email.
- [cite_start]**Review Mode:** Edit outputs before sending.

## Tech Stack
- **Frontend:** React Native (Expo) - iOS & Web.
- **Backend:** Python FastAPI.
- **AI:** OpenAI Whisper & GPT-4o.

## Development Standards (Strict for AI Agents)
- **Testing:** All pull requests must maintain >80% test coverage.
- **UI:** Use "Sleek" design principles. No clutter.
- **Code Style:** PEP8 for Python, Prettier for JS/TS.

## Business Context
- [cite_start]Target Audience: 100,000+ private music instructors in the US[cite: 15].
- [cite_start]Goal: Reduce admin time from hours to seconds[cite: 2, 9].
6. Testing Strategy
To ensure the "Efficiency" requirement is met:

Unit Tests: Test the parsing logic. Does the LLM extractor correctly identify "Tempo targets" and "Pieces assigned"?.

Integration Tests: Simulate a file upload -> Transcription -> Generation pipeline.


UI Tests: Ensure the "Record" button is responsive and the "Edit" function on the output screen actually updates the state.


Real-World Validation: The system suggests comparing AI outputs to what teachers would have written manually to tune the templates.

This implementation uses FastAPI for high performance and strict typing, ensuring the "elegant and efficient" requirements are met. It includes the specific AI logic to transcribe audio and generate the three required outputs (Recap, Practice Plan, Email).


Architecture Flow
1. Dependency Setup (requirements.txt)
The AI agents will need these packages to build the environment.

Plaintext

fastapi>=0.100.0
uvicorn>=0.23.0
python-multipart>=0.0.6
openai>=1.0.0
pydantic>=2.0.0
python-dotenv>=1.0.0
pytest>=7.4.0
httpx>=0.24.0
2. The Application Core (main.py)
This file handles the audio upload, interacts with OpenAI's Whisper (transcription) and GPT-4 (reasoning), and structures the data exactly as requested in the PRD.

Python

import os
import shutil
import tempfile
from typing import List
from fastapi import FastAPI, UploadFile, File, HTTPException
from pydantic import BaseModel
from openai import OpenAI
from dotenv import load_dotenv

# Load environment variables
load_dotenv()

app = FastAPI(title="Note By Note API", version="1.0.0")

# Initialize OpenAI Client
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# --- Data Models ---
class LessonOutputs(BaseModel):
    student_recap: str
    practice_plan: str
    parent_email: str

class LessonResponse(BaseModel):
    transcript: str
    outputs: LessonOutputs

# --- Core Logic ---

def transcribe_audio(file_path: str) -> str:
    """
    Uses OpenAI Whisper to transcribe the lesson audio[cite: 10].
    """
    try:
        with open(file_path, "rb") as audio_file:
            transcript = client.audio.transcriptions.create(
                model="whisper-1",
                file=audio_file,
                response_format="text"
            )
        return transcript
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Transcription failed: {str(e)}")

def generate_teacher_notes(transcript: str) -> LessonOutputs:
    """
    Feeds the transcript to an LLM to extract musical instruction and 
    generate the 3 specific outputs[cite: 11, 12].
    """
    
    system_prompt = """
    You are an expert music teacher assistant. 
    Analyze the following lesson transcript.
    
    Extract specific details:
    - Mistakes corrected
    - Techniques introduced
    - Pieces assigned
    - Tempo targets mentioned [cite: 11]

    Generate a JSON response with exactly these three keys:
    1. 'student_recap': Highlights wins and areas to work on. Tone: Encouraging.
    2. 'practice_plan': Broken into daily assignments (e.g., "Monday: C major scales...").
    3. 'parent_email': A summary of progress and gentle nudges. [cite: 8]
    """

    try:
        response = client.chat.completions.create(
            model="gpt-4-1106-preview", # Using JSON mode capable model
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": f"Transcript: {transcript}"}
            ],
            response_format={"type": "json_object"}
        )
        
        # Parse JSON content from the LLM
        import json
        content = json.loads(response.choices[0].message.content)
        
        return LessonOutputs(
            student_recap=content.get("student_recap", ""),
            practice_plan=content.get("practice_plan", ""),
            parent_email=content.get("parent_email", "")
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Generation failed: {str(e)}")

# --- Endpoints ---

@app.post("/process-lesson", response_model=LessonResponse)
async def process_lesson(file: UploadFile = File(...)):
    """
    Main endpoint: Receives audio, returns structured notes.
    """
    # 1. Save generic UploadFile to a temporary file on disk
    with tempfile.NamedTemporaryFile(delete=False, suffix=".m4a") as temp_file:
        shutil.copyfileobj(file.file, temp_file)
        temp_path = temp_file.name

    try:
        # 2. Transcribe
        transcript_text = transcribe_audio(temp_path)

        # 3. Generate Outputs (Intelligence Layer)
        ai_outputs = generate_teacher_notes(transcript_text)

        return LessonResponse(
            transcript=transcript_text,
            outputs=ai_outputs
        )

    finally:
        # Cleanup temp file
        os.remove(temp_path)

@app.get("/health")
def health_check():
    return {"status": "active", "service": "Note By Note API"}
3. The Testing Suite (test_main.py)
To satisfy the "80% test coverage" requirement, we use unittest.mock to simulate OpenAI responses. This allows the CI/CD pipeline to run tests without incurring API costs.

Python

import pytest
from fastapi.testclient import TestClient
from unittest.mock import MagicMock, patch
from main import app

client = TestClient(app)

# Mock Data
MOCK_TRANSCRIPT = "Okay, play the C major scale. Good job on the tempo, but watch your thumb tuck."
MOCK_GPT_RESPONSE = {
    "student_recap": "Great job on tempo!",
    "practice_plan": "Monday: Thumb tuck drills.",
    "parent_email": "Dear Parent, good progress today."
}

def test_health_check():
    response = client.get("/health")
    assert response.status_code == 200
    assert response.json() == {"status": "active", "service": "Note By Note API"}

@patch("main.client.audio.transcriptions.create")
@patch("main.client.chat.completions.create")
def test_process_lesson_flow(mock_chat, mock_whisper):
    # 1. Setup Mocks
    mock_whisper.return_value = MOCK_TRANSCRIPT
    
    # Mocking the nested object structure of OpenAI response
    mock_choice = MagicMock()
    mock_choice.message.content = '{"student_recap": "Great job on tempo!", "practice_plan": "Monday: Thumb tuck drills.", "parent_email": "Dear Parent, good progress today."}'
    mock_chat.return_value.choices = [mock_choice]

    # 2. Create dummy audio file
    files = {'file': ('test_audio.m4a', b'fake audio data', 'audio/m4a')}

    # 3. Call Endpoint
    response = client.post("/process-lesson", files=files)

    # 4. Assertions
    assert response.status_code == 200
    json_data = response.json()
    
    # Verify Transcript
    assert json_data["transcript"] == MOCK_TRANSCRIPT
    
    # Verify AI Outputs
    assert json_data["outputs"]["student_recap"] == "Great job on tempo!"
    assert json_data["outputs"]["practice_plan"] == "Monday: Thumb tuck drills."
    
    # Ensure Mocks were called
    mock_whisper.assert_called_once()
    mock_chat.assert_called_once()

Here is the React Native (Expo) code designed for the AI Frontend Agent.

This implementation focuses on the "Sleek UI" and "Dark Mode" requirements to minimize eye strain for teachers working late. It utilizes expo-av for robust audio capture and axios to communicate with the Python backend built in the previous step.


1. Frontend Architecture & Dependencies
Prompt for Agent: "Install these specific dependencies to handle audio, file system operations, and safe area context."

JSON

// package.json dependencies
{
  "dependencies": {
    "expo": "~49.0.0",
    "expo-av": "~13.4.1",
    "expo-file-system": "~15.4.3",
    "axios": "^1.4.0",
    "react-native-safe-area-context": "4.6.3",
    "@react-navigation/native": "^6.0.0",
    "@react-navigation/stack": "^6.0.0"
  }
}
2. API Service Layer (services/api.js)
This module handles the file upload logic, bridging the mobile app to the FastAPI backend.

JavaScript

import axios from 'axios';
import * as FileSystem from 'expo-file-system';

// Replace with your local IP for testing (e.g., 192.168.1.x) or production URL
const API_URL = 'http://YOUR_LOCAL_IP:8000';

export const processLessonAudio = async (uri) => {
  const formData = new FormData();
  
  // Prepare the file for upload
  formData.append('file', {
    uri: uri,
    type: 'audio/m4a',
    name: 'lesson_recording.m4a',
  });

  try {
    const response = await axios.post(`${API_URL}/process-lesson`, formData, {
      headers: {
        'Content-Type': 'multipart/form-data',
      },
      // Increase timeout for longer transcriptions
      timeout: 60000, 
    });
    return response.data;
  } catch (error) {
    console.error('Upload failed:', error);
    throw error;
  }
};
3. Screen 1: The Recorder (screens/RecordScreen.js)
This screen features a minimalist design with a single, massive button to reduce cognitive load.

JavaScript

import React, { useState } from 'react';
import { View, Text, StyleSheet, TouchableOpacity, ActivityIndicator, Alert } from 'react-native';
import { Audio } from 'expo-av';
import { SafeAreaView } from 'react-native-safe-area-context';
import { processLessonAudio } from '../services/api';

export default function RecordScreen({ navigation }) {
  const [recording, setRecording] = useState(null);
  const [isProcessing, setIsProcessing] = useState(false);

  // --- Audio Logic ---
  async function startRecording() {
    try {
      await Audio.requestPermissionsAsync();
      await Audio.setAudioModeAsync({
        allowsRecordingIOS: true,
        playsInSilentModeIOS: true,
      });

      const { recording } = await Audio.Recording.createAsync(
        Audio.RecordingOptionsPresets.HIGH_QUALITY
      );
      setRecording(recording);
    } catch (err) {
      Alert.alert('Failed to start recording', err.message);
    }
  }

  async function stopRecording() {
    setIsProcessing(true);
    setRecording(undefined);
    
    await recording.stopAndUnloadAsync();
    const uri = recording.getURI();

    try {
      // Send to Backend
      const result = await processLessonAudio(uri);
      
      // Navigate to Review Screen with the generated data
      navigation.navigate('Review', { data: result });
    } catch (error) {
      Alert.alert('Error', 'Failed to process lesson. Please try again.');
    } finally {
      setIsProcessing(false);
    }
  }

  // --- UI Render ---
  return (
    <SafeAreaView style={styles.container}>
      <View style={styles.header}>
        <Text style={styles.title}>Note By Note</Text>
        <Text style={styles.subtitle}>Ready to listen.</Text>
      </View>

      <View style={styles.centerContainer}>
        {isProcessing ? (
          <View style={styles.loadingContainer}>
            <ActivityIndicator size="large" color="#4F46E5" />
            <Text style={styles.loadingText}>Generating Lesson Plan...</Text>
          </View>
        ) : (
          <TouchableOpacity
            style={[styles.recordButton, recording && styles.recordingActive]}
            onPress={recording ? stopRecording : startRecording}
          >
            <View style={[styles.innerCircle, recording && styles.innerCircleActive]} />
          </TouchableOpacity>
        )}
        
        <Text style={styles.statusText}>
          {recording ? 'Recording in progress...' : 'Tap to Record Lesson'}
        </Text>
      </View>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#111827', // Dark Slate (Sleek Dark Mode)
  },
  header: {
    padding: 24,
  },
  title: {
    fontSize: 28,
    fontWeight: '800',
    color: '#F9FAFB',
    letterSpacing: 0.5,
  },
  subtitle: {
    fontSize: 16,
    color: '#9CA3AF',
    marginTop: 4,
  },
  centerContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  recordButton: {
    width: 120,
    height: 120,
    borderRadius: 60,
    borderWidth: 4,
    borderColor: '#4F46E5', // Indigo Accent
    justifyContent: 'center',
    alignItems: 'center',
    marginBottom: 24,
  },
  recordingActive: {
    borderColor: '#EF4444', // Red when recording
  },
  innerCircle: {
    width: 100,
    height: 100,
    borderRadius: 50,
    backgroundColor: '#4F46E5',
  },
  innerCircleActive: {
    backgroundColor: '#EF4444',
    width: 60, // Animate to square ideally, but smaller circle for MVP
    height: 60,
    borderRadius: 8,
  },
  statusText: {
    color: '#E5E7EB',
    fontSize: 16,
    fontWeight: '500',
  },
  loadingText: {
    color: '#9CA3AF',
    marginTop: 16,
  },
});
4. Screen 2: The Review Output (screens/ReviewScreen.js)
This screen implements the requirement to allow teachers to "review and edit" the three generated outputs before sending.

JavaScript

import React, { useState } from 'react';
import { 
  View, Text, StyleSheet, ScrollView, TextInput, TouchableOpacity, KeyboardAvoidingView, Platform 
} from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';

export default function ReviewScreen({ route, navigation }) {
  const { data } = route.params; // Data from backend
  const outputs = data.outputs;

  // Local state for editing functionality
  const [recap, setRecap] = useState(outputs.student_recap);
  const [plan, setPlan] = useState(outputs.practice_plan);
  const [email, setEmail] = useState(outputs.parent_email);

  return (
    <SafeAreaView style={styles.container}>
      <KeyboardAvoidingView 
        behavior={Platform.OS === "ios" ? "padding" : "height"}
        style={{ flex: 1 }}
      >
        <ScrollView style={styles.scrollView}>
          <Text style={styles.headerTitle}>Lesson Review</Text>

          {/* Section 1: Student Recap */}
          <View style={styles.card}>
            <Text style={styles.label}>STUDENT RECAP</Text>
            <TextInput
              style={styles.textArea}
              multiline
              value={recap}
              onChangeText={setRecap}
              scrollEnabled={false}
            />
          </View>

          {/* Section 2: Practice Plan */}
          <View style={styles.card}>
            <Text style={styles.label}>PRACTICE PLAN</Text>
            <TextInput
              style={styles.textArea}
              multiline
              value={plan}
              onChangeText={setPlan}
              scrollEnabled={false}
            />
          </View>

          {/* Section 3: Parent Email */}
          <View style={styles.card}>
            <Text style={styles.label}>PARENT EMAIL</Text>
            <TextInput
              style={styles.textArea}
              multiline
              value={email}
              onChangeText={setEmail}
              scrollEnabled={false}
            />
          </View>

          {/* Action Buttons */}
          <TouchableOpacity style={styles.sendButton}>
            <Text style={styles.sendButtonText}>Finalize & Send</Text>
          </TouchableOpacity>

        </ScrollView>
      </KeyboardAvoidingView>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#111827',
  },
  scrollView: {
    padding: 16,
  },
  headerTitle: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#F9FAFB',
    marginBottom: 20,
  },
  card: {
    backgroundColor: '#1F2937', // Slightly lighter dark for cards
    borderRadius: 12,
    padding: 16,
    marginBottom: 16,
    borderWidth: 1,
    borderColor: '#374151',
  },
  label: {
    fontSize: 12,
    fontWeight: '700',
    color: '#9CA3AF', // Muted text
    marginBottom: 8,
    letterSpacing: 1,
  },
  textArea: {
    color: '#F3F4F6',
    fontSize: 16,
    lineHeight: 24,
    textAlignVertical: 'top', // Android fix
  },
  sendButton: {
    backgroundColor: '#4F46E5',
    padding: 18,
    borderRadius: 12,
    alignItems: 'center',
    marginBottom: 40,
    marginTop: 10,
  },
  sendButtonText: {
    color: 'white',
    fontSize: 18,
    fontWeight: '600',
  },
});
5. Implementation Notes for AI Agents
Navigation: Ensure App.js wraps these screens in a NavigationContainer with a Stack Navigator.

Permissions: The Info.plist (iOS) and AndroidManifest.xml (Android) must be updated to include Microphone usage descriptions.

Styling Strategy: The code uses hardcoded Hex values for the "Dark Mode" aesthetic. For a production app, the agent should extract these into a theme.js file.

This is the final piece of the engineering puzzle. These Pytest scripts are designed to validate the "Contract" between your Python backend and the React Native frontend.

They simulate the exact multipart/form-data request your mobile app sends and verify that the JSON response contains the specific fields (Recap, Plan, Email) defined in your PRD.

The Integration Testing Strategy
We will create two files:

conftest.py: Sets up the test environment and mocks OpenAI (to save money and speed up tests).

test_integration.py: Simulates the React Native client.

1. Test Configuration (tests/conftest.py)
This file ensures your tests are efficient by mocking external dependencies (OpenAI) while keeping the API logic intact.

Python

import pytest
from fastapi.testclient import TestClient
from unittest.mock import MagicMock, patch
import sys
import os

# Add the parent directory to sys.path so we can import 'main'
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from main import app

@pytest.fixture
def client():
    """
    Creates a TestClient instance that acts as the React Native app.
    """
    return TestClient(app)

@pytest.fixture
def mock_openai():
    """
    Mocks OpenAI responses to ensure we don't hit the real API
    during automated testing (Cost & Speed optimization).
    """
    with patch("main.client") as mock_client:
        # Mock Transcription (Whisper)
        mock_client.audio.transcriptions.create.return_value = "Mocked transcript of a C Major scale lesson."
        
        # Mock Chat Completion (GPT-4o)
        mock_choice = MagicMock()
        mock_choice.message.content = '''
        {
            "student_recap": "Excellent work on the C Major scale today. Your rhythm was steady.",
            "practice_plan": "Monday: C Major scale hands separate. Tuesday: Hands together at 60bpm.",
            "parent_email": "Dear Parent, brilliant progress today on the scales."
        }
        '''
        mock_client.chat.completions.create.return_value.choices = [mock_choice]
        
        yield mock_client
2. Integration Logic (tests/test_integration.py)
This script specifically validates the integration requirements from your MVP definition. It ensures the backend returns exactly what the frontend ReviewScreen.js expects to render.

Python

import pytest
from fastapi import status

# Define the contract: These keys MUST exist for the Frontend to work
# derived from the requirements in the text.
REQUIRED_KEYS = ["student_recap", "practice_plan", "parent_email"]

def test_upload_flow_integration(client, mock_openai):
    """
    Simulates the React Native 'processLessonAudio' function call.
    Verifies that the backend accepts the file and returns the correct JSON structure.
    """
    
    # 1. Simulate the React Native 'FormData' payload
    # The frontend sends a file named 'file' with mime type 'audio/m4a'
    files = {
        'file': ('lesson_recording.m4a', b'dummy_audio_bytes', 'audio/m4a')
    }

    # 2. Fire the request (mimicking axios.post)
    response = client.post("/process-lesson", files=files)

    # 3. Validate HTTP Status
    assert response.status_code == status.HTTP_200_OK, f"Expected 200, got {response.status_code}"

    # 4. Validate Data Structure (The Contract)
    data = response.json()
    
    # Check 1: Transcript is present [cite: 10]
    assert "transcript" in data
    assert len(data["transcript"]) > 0

    # Check 2: The 3 specific outputs required by the PRD 
    outputs = data.get("outputs", {})
    for key in REQUIRED_KEYS:
        assert key in outputs, f"Frontend expects key '{key}' but it was missing."
        assert isinstance(outputs[key], str), f"Expected '{key}' to be a string for the UI text input."

def test_upload_invalid_file_handling(client):
    """
    Ensures the backend doesn't crash if the frontend sends a bad file.
    """
    # Simulate sending a text file instead of audio
    files = {
        'file': ('malicious.txt', b'this is not audio', 'text/plain')
    }
    
    # Note: In a real integration, OpenAI might reject this, or your logic might.
    # We expect the system to handle it gracefully (likely 500 in current mock, or specific error).
    # This test ensures we get a JSON response, not a server crash.
    response = client.post("/process-lesson", files=files)
    
    # We generally expect an error or a handled exception
    assert response.status_code != 404 # Endpoint must exist

def test_performance_latency_simulation(client, mock_openai):
    """
    Validates that the response time is reasonable.
    Note: Since we mock OpenAI, this tests the overhead of FastAPI itself.
    """
    import time
    
    start_time = time.time()
    files = {'file': ('test.m4a', b'data', 'audio/m4a')}
    client.post("/process-lesson", files=files)
    duration = time.time() - start_time
    
    # processing overhead should be negligible (< 200ms) without the AI call
    assert duration < 0.2, "Backend routing overhead is too high!"
3. How to Run the Tests
Instruct your AI Agents (or human developers) to execute the following commands in the terminal:

Install Test Dependencies:

Bash

pip install pytest httpx
Run the Suite:

Bash

pytest tests/ -v
Why this confirms "Integration"
Protocol Matching: It uses multipart/form-data, strictly matching the FormData constructed in services/api.js.

Schema Validation: It iterates through student_recap, practice_plan, and parent_email. If any of these change on the backend, this test will fail, alerting you that the React Native app (which relies on outputs.student_recap, etc.) would break.


This is the final package. It is structured as a Project Scaffold that an AI Engineering Team (or a developer using AI tools) can ingest to build the entire Note By Note application immediately.

It includes the File Tree, the Master README, and the Environment Setup instructions.

Project Codename: Note By Note
1. The File Tree Structure
Copy this structure exactly. It separates concerns between the mobile frontend and the AI backend while keeping them in a single repository for easy management (Monorepo).

Plaintext

note-by-note/
â”œâ”€â”€ README.md                  <-- The Master Instruction File (Content Below)
â”œâ”€â”€ backend/                   <-- FastAPI Service
â”‚   â”œâ”€â”€ main.py                <-- Core Logic (Code provided previously)
â”‚   â”œâ”€â”€ requirements.txt       <-- Python Dependencies
â”‚   â”œâ”€â”€ .env                   <-- API Keys (OpenAI)
â”‚   â””â”€â”€ tests/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ conftest.py        <-- Test Config (Code provided previously)
â”‚       â””â”€â”€ test_integration.py<-- Integration Tests (Code provided previously)
â”œâ”€â”€ mobile/                    <-- React Native Expo App
â”‚   â”œâ”€â”€ App.js                 <-- Main Entry Point
â”‚   â”œâ”€â”€ app.json               <-- Expo Configuration
â”‚   â”œâ”€â”€ package.json           <-- JS Dependencies
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â””â”€â”€ api.js         <-- API Connection (Code provided previously)
â”‚   â”‚   â””â”€â”€ screens/
â”‚   â”‚       â”œâ”€â”€ RecordScreen.js<-- Recorder UI (Code provided previously)
â”‚   â”‚       â””â”€â”€ ReviewScreen.js<-- Output UI (Code provided previously)
â”‚   â””â”€â”€ assets/
â”‚       â””â”€â”€ icon.png
â””â”€â”€ docs/
    â””â”€â”€ PRD.md                 <-- Product Requirements (Content provided in Step 1)
2. Master README.md
Save this content as README.md at the root of your project. It acts as the "Brain" for any AI agent joining the project.

Markdown

# Note By Note - AI Music Teacher Assistant

## ðŸš€ Project Mission
[cite_start]To build an "elegant and efficient" AI tool that listens to music lessons and automatically generates **Student Recaps**, **Practice Plans**, and **Parent Emails**, saving teachers hours of admin work.

## ðŸ›  Tech Stack
* **Frontend:** React Native (Expo) - iOS & Web.
* **Backend:** Python FastAPI.
* **AI Engine:** OpenAI Whisper (Transcription) + GPT-4o (Reasoning).
* **Database:** Supabase (PostgreSQL).

## âš¡ Quick Start for AI Agents & Developers

### 1. Backend Setup (Python)
The backend handles audio processing and AI generation.
```bash
cd backend
python -m venv venv
source venv/bin/activate  # or venv\Scripts\activate on Windows
pip install -r requirements.txt
# Create a .env file with: OPENAI_API_KEY=sk-...
uvicorn main:app --reload --host 0.0.0.0 --port 8000
2. Frontend Setup (React Native)
The mobile app for recording and reviewing.

Bash

cd mobile
npm install
# Update src/services/api.js with your computer's local IP address
npx expo start
ðŸ§ª Testing Protocol (Strict Requirement)
We maintain 80% test coverage to ensure reliability.

Run Backend Tests:

Bash

cd backend
pytest tests/ -v
Critical Test Path: 1. test_upload_flow_integration: Simulates a file upload from the app. 2. test_process_lesson_flow: Mocks OpenAI to verify JSON parsing logic.

ðŸ“ Product Requirements (MVP)

Input: One-tap audio recording.


Processing: Transcribe via Whisper -> Extract via LLM.


Output: 3 distinct text blocks (Recap, Plan, Email).


UI: Dark mode, minimalist, "Sleek" aesthetic.

ðŸ“‚ Key Architecture Decisions
Monorepo: Both frontend and backend in one repo for speed.

JSON Mode: The Backend forces the LLM to reply in strict JSON to prevent UI crashes.

Expo AV: Used for high-quality audio capture (.m4a) compatible with Whisper.


---

### **3. Final Environment Setup (.env)**

Create a file named `.env` inside the `backend/` folder. This is the only file you cannot commit to Git.

```ini
# backend/.env
OPENAI_API_KEY=sk-YOUR_ACTUAL_OPEN_AI_KEY_HERE
ENV=development

</exampleAlpha>
<exampleBeta>

===== FILE: .coveragerc =====

[run]
branch = True
source =
    tools

[report]
show_missing = True
fail_under = 80


===== FILE: .github/workflows/ci.yml =====

name: ci

on:
  push:
  pull_request:

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run tests + coverage (>=80%)
        run: |
          coverage run -m pytest
          coverage report --fail-under=80


===== FILE: Makefile =====

.PHONY: test
.PHONY: golden

test:
	python -m pip install -r requirements-dev.txt
	coverage run -m pytest
	coverage report --fail-under=80

golden:
	python -m pip install -r requirements-dev.txt
	python tools/run_pipeline_on_fixture.py


===== FILE: requirements-dev.txt =====

pytest>=8.0
jsonschema>=4.21
deepdiff>=7.0
coverage>=7.0


===== FILE: pyproject.toml =====

[tool.pytest.ini_options]
testpaths = ["tests"]
addopts = "-q"

[tool.coverage.run]
branch = true
source = ["tools"]

[tool.coverage.report]
fail_under = 80
show_missing = true


===== FILE: README.md =====

# Note By Note â€” Golden Fixture Regression Pack

This repo folder contains:
- `schemas/lesson_instruction.schema.json`: strict JSON Schema for lesson extraction
- `prompts/`: extraction + generation prompt templates
- `fixtures/golden/`: a golden transcript and expected outputs
- `tests/`: CI regression tests that validate the schema + expected artifacts

## Why this exists
The fastest way to keep LLM pipelines sane is to pin them to a "golden" fixture.
When agents change prompts or code, CI will tell you exactly what changed.

## Run locally
```bash
python -m pip install -r requirements-dev.txt
make test
```

## Run the turnkey golden runner
```bash
make golden
```

This writes artifacts to `artifacts/golden-run/` and fails if outputs diverge
from the expected fixture.

## How to use in the worker pipeline
1. After extraction: validate extracted JSON using `tools/validate_schema.py`.
2. After draft generation: run the lightweight text constraints in `tools/text_checks.py`.
3. When you intentionally improve prompts, update the `fixtures/golden/*.expected.*` files and commit.

## Updating the golden files (intentional changes)
- If you change the schema: update `schemas/lesson_instruction.schema.json` and regenerate `schema.expected.json`.
- If you change prompts: regenerate drafts and update `*.expected.md`.
- If CI fails, treat it as a design review, not an annoyance.


===== FILE: docs/GOLDEN_FIXTURE_REGRESSION.md =====

# Golden Fixture Regression Pack

## Purpose
This folder provides a deterministic fixture set for validating the extraction contract and draft formatting without needing real lesson audio.

## Files
- transcript.segments.json
  - The canonical transcript input (segments with timestamps and speaker labels).

- schema.expected.json
  - The expected LessonInstruction JSON output after extraction.

- recap.expected.md
- practice_plan.expected.md
- parent_email.expected.md
  - The expected drafts generated from the expected schema.

## How to use in automated tests
1. Validate schema.expected.json against schemas/lesson_instruction.schema.json.
2. Run your extraction step (LLM) against transcript.segments.json.
3. Canonicalize the extraction output:
   - sort arrays where order is not meaningful
   - normalize whitespace
4. Compare canonicalized output to schema.expected.json.
5. Run your draft generation step against schema.expected.json.
6. Compare draft outputs to the expected .md files.

## Turnkey runner
You can run the full golden flow (extract + generate + validate + diff) with:

  python tools/run_pipeline_on_fixture.py

By default it uses a deterministic adapter that replays the expected outputs,
so it is safe to run in CI.

When your real worker pipeline exists, implement a PipelineAdapter and run:

  python tools/run_pipeline_on_fixture.py --adapter your_module:YourAdapter

## Recommended canonicalization rules
- Keep order stable for user-facing items in practice_items, pieces_assigned, tempo_targets.
- For evidence arrays, order by start_time_sec.
- Trim trailing whitespace on every line.

## Failure triage
- If schema mismatch: inspect evidence quoting and timestamp ranges first.
- If drafts mismatch: verify length limits, headings, and that only schema fields are used.


===== FILE: schemas/lesson_instruction.schema.json =====

{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://note-by-note.app/schemas/lesson-instruction.schema.json",
  "title": "LessonInstruction",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "meta",
    "praise_wins",
    "pieces_assigned",
    "techniques",
    "corrections",
    "tempo_targets",
    "weekly_focus",
    "practice_items",
    "concerns",
    "admin_notes"
  ],
  "properties": {
    "meta": {
      "type": "object",
      "additionalProperties": false,
      "required": ["student_name", "instrument", "lesson_date_iso", "extraction_version"],
      "properties": {
        "lesson_id": { "type": "string" },
        "student_id": { "type": "string" },
        "student_name": { "type": "string", "minLength": 1 },
        "instrument": {
          "type": "string",
          "enum": ["piano", "violin", "other"]
        },
        "level": { "type": "string" },
        "lesson_date_iso": { "type": "string", "format": "date" },
        "timezone": { "type": "string" },
        "extraction_version": { "type": "string", "minLength": 1 },
        "notes": { "type": "string" }
      }
    },

    "praise_wins": {
      "type": "array",
      "items": { "$ref": "#/definitions/EvidencedText" }
    },

    "pieces_assigned": {
      "type": "array",
      "items": { "$ref": "#/definitions/PieceAssignment" }
    },

    "techniques": {
      "type": "array",
      "items": { "$ref": "#/definitions/Technique" }
    },

    "corrections": {
      "type": "array",
      "items": { "$ref": "#/definitions/Correction" }
    },

    "tempo_targets": {
      "type": "array",
      "items": { "$ref": "#/definitions/TempoTarget" }
    },

    "weekly_focus": {
      "type": "array",
      "items": { "$ref": "#/definitions/EvidencedText" }
    },

    "practice_items": {
      "type": "array",
      "items": { "$ref": "#/definitions/PracticeItem" }
    },

    "concerns": {
      "type": "array",
      "items": { "$ref": "#/definitions/EvidencedText" }
    },

    "admin_notes": {
      "type": "array",
      "items": { "$ref": "#/definitions/EvidencedText" }
    }
  },

  "definitions": {
    "Evidence": {
      "type": "object",
      "additionalProperties": false,
      "required": ["quote", "start_time_sec", "end_time_sec"],
      "properties": {
        "quote": { "type": "string", "minLength": 1, "maxLength": 240 },
        "start_time_sec": { "type": "number", "minimum": 0 },
        "end_time_sec": { "type": "number", "minimum": 0 },
        "speaker": { "type": "string", "enum": ["Teacher", "Student", "Unknown"] }
      }
    },

    "Confidence": {
      "type": "string",
      "enum": ["high", "medium", "low"]
    },

    "EvidencedText": {
      "type": "object",
      "additionalProperties": false,
      "required": ["text", "evidence", "confidence"],
      "properties": {
        "text": { "type": "string", "minLength": 1 },
        "evidence": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/definitions/Evidence" }
        },
        "confidence": { "$ref": "#/definitions/Confidence" }
      }
    },

    "PieceAssignment": {
      "type": "object",
      "additionalProperties": false,
      "required": ["title", "section", "goal", "evidence", "confidence"],
      "properties": {
        "title": { "type": "string", "minLength": 1 },
        "composer": { "type": "string" },
        "section": { "type": "string", "minLength": 1 },
        "goal": { "type": "string", "minLength": 1 },
        "evidence": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/definitions/Evidence" }
        },
        "confidence": { "$ref": "#/definitions/Confidence" }
      }
    },

    "Technique": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "description", "evidence", "confidence"],
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "description": { "type": "string", "minLength": 1 },
        "evidence": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/definitions/Evidence" }
        },
        "confidence": { "$ref": "#/definitions/Confidence" }
      }
    },

    "Correction": {
      "type": "object",
      "additionalProperties": false,
      "required": ["issue", "fix", "where", "evidence", "confidence"],
      "properties": {
        "issue": { "type": "string", "minLength": 1 },
        "fix": { "type": "string", "minLength": 1 },
        "where": { "type": "string", "minLength": 1 },
        "evidence": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/definitions/Evidence" }
        },
        "confidence": { "$ref": "#/definitions/Confidence" }
      }
    },

    "TempoTarget": {
      "type": "object",
      "additionalProperties": false,
      "required": ["piece", "bpm", "context", "evidence", "confidence"],
      "properties": {
        "piece": { "type": "string", "minLength": 1 },
        "bpm": { "type": "integer", "minimum": 20, "maximum": 240 },
        "context": { "type": "string", "minLength": 1 },
        "evidence": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/definitions/Evidence" }
        },
        "confidence": { "$ref": "#/definitions/Confidence" }
      }
    },

    "PracticeItem": {
      "type": "object",
      "additionalProperties": false,
      "required": ["category", "instruction", "duration_minutes", "priority", "evidence", "confidence"],
      "properties": {
        "category": {
          "type": "string",
          "enum": ["scales", "technique", "repertoire", "rhythm", "sight_reading", "other"]
        },
        "instruction": { "type": "string", "minLength": 1 },
        "duration_minutes": { "type": "integer", "minimum": 1, "maximum": 90 },
        "priority": { "type": "integer", "minimum": 1, "maximum": 5 },
        "evidence": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/definitions/Evidence" }
        },
        "confidence": { "$ref": "#/definitions/Confidence" }
      }
    }
  }
}


===== FILE: prompts/00_system_policy.md =====

You are an assistant that produces reliable, teacher-grade outputs for music lesson documentation.
You must not invent details.
You must ground every extracted item in transcript evidence.
If something is not present, omit it or mark confidence low with a short reason.
You must output exactly what the user requested, in the required format.


===== FILE: prompts/10_extract_lesson_schema.prompt.md =====

# Extraction Prompt: Transcript -> LessonInstruction JSON

## System
(Use the content of 00_system_policy.md as the system message.)

## Developer
You are extracting structured lesson instructions from a transcript.
Return only valid JSON that conforms to the provided JSON Schema.
Every extracted item MUST include evidence entries.
Evidence quote must be a short verbatim snippet from the transcript.
Use timestamps from the transcript segments.
Do not fabricate piece names, measure numbers, tempo targets, or techniques.
Prefer fewer high-confidence items over many speculative items.

## User
Context:
- student_name: {{student_name}}
- instrument: {{instrument}}
- level: {{level}}
- lesson_date_iso: {{lesson_date_iso}}

JSON Schema:
{{lesson_instruction_json_schema}}

Transcript (JSON segments):
{{transcript_segments_json}}

Task:
Extract a LessonInstruction JSON object.
Return ONLY the JSON.


===== FILE: prompts/20_generate_recap.prompt.md =====

# Generation Prompt: Student Recap

## System
(Use the content of 00_system_policy.md as the system message.)

## Developer
Write a concise student recap based ONLY on the LessonInstruction JSON.
Do not add details that are not supported by the schema.
Tone: teacher-to-student, supportive, clear, professional.
Length limit: 180 words.
Format:
- Title line: "Lesson Recap"
- Sections with bullets:
  - Wins
  - Focus
  - Next lesson

## User
Student: {{student_name}}
Instrument: {{instrument}}
Level: {{level}}
LessonInstruction JSON:
{{lesson_instruction_json}}

Return the recap text only.


===== FILE: prompts/21_generate_practice_plan.prompt.md =====

# Generation Prompt: Weekly Practice Plan (Daily)

## System
(Use the content of 00_system_policy.md as the system message.)

## Developer
Create a 6-day practice plan broken into daily assignments.
Use ONLY items in LessonInstruction JSON.
Total per day: 25 minutes.
Each day: 3 tasks.
Include tempo targets when provided.
Avoid vague phrases.
Format:
- Title line: "Practice Plan"
- For each day: "Day 1" ... "Day 6"
  - Task bullets: "(minutes) category: instruction"

## User
Student: {{student_name}}
Instrument: {{instrument}}
LessonInstruction JSON:
{{lesson_instruction_json}}

Return the practice plan text only.


===== FILE: prompts/22_generate_parent_email.prompt.md =====

# Generation Prompt: Parent Email

## System
(Use the content of 00_system_policy.md as the system message.)

## Developer
Draft a parent email summarizing progress and what to practice this week.
Use ONLY information in LessonInstruction JSON.
Tone: warm, confident, not overly long.
Length limit: 220 words.
Include:
- Short positive opener
- 2 to 4 bullet highlights
- Clear practice expectations for the week
- Friendly closing
No marketing language.

## User
Parent recipient names (optional): {{parent_names}}
Student: {{student_name}}
LessonInstruction JSON:
{{lesson_instruction_json}}

Return the email body only.


===== FILE: fixtures/golden/transcript.segments.json =====

[
  {"start_time_sec": 0, "end_time_sec": 12, "speaker": "Teacher", "text": "Hi Leo. Let's start with your C major scale. Two octaves, hands together."},
  {"start_time_sec": 12, "end_time_sec": 28, "speaker": "Teacher", "text": "Good. Keep your fingers curved and land on the tips, not flat."},
  {"start_time_sec": 28, "end_time_sec": 45, "speaker": "Teacher", "text": "Metronome at 72 today. By Friday I want you at 84 if it stays clean."},
  {"start_time_sec": 45, "end_time_sec": 62, "speaker": "Teacher", "text": "Add the C major arpeggio too. Slow, even sound, no rushing at the top."},
  {"start_time_sec": 62, "end_time_sec": 78, "speaker": "Teacher", "text": "Your posture is much better this week. Shoulders relaxed. Nice."},
  {"start_time_sec": 78, "end_time_sec": 102, "speaker": "Teacher", "text": "Now Minuet in G. Let's focus on measures 9 to 16. The left hand needs lighter staccato."},
  {"start_time_sec": 102, "end_time_sec": 120, "speaker": "Teacher", "text": "For staccato, lift from the wrist, not the fingers. Think bounce, not poke."},
  {"start_time_sec": 120, "end_time_sec": 138, "speaker": "Teacher", "text": "Great dynamic contrast in the phrase. Keep that."},
  {"start_time_sec": 138, "end_time_sec": 160, "speaker": "Teacher", "text": "Your recital piece is Moonlight Sonata. This week do measures 5 to 8 hands separate first."},
  {"start_time_sec": 160, "end_time_sec": 184, "speaker": "Teacher", "text": "The chord change in measure 12 is still tripping you. Practice just that transition ten times slowly."},
  {"start_time_sec": 184, "end_time_sec": 204, "speaker": "Teacher", "text": "Count out loud: one e and a, two e and a. It fixes the rhythm."},
  {"start_time_sec": 204, "end_time_sec": 226, "speaker": "Teacher", "text": "This week I want steady tempo and clean staccato in the left hand. Quality over speed."},
  {"start_time_sec": 226, "end_time_sec": 248, "speaker": "Teacher", "text": "Aim for about 25 minutes a day, six days this week. Short and focused."},
  {"start_time_sec": 248, "end_time_sec": 270, "speaker": "Teacher", "text": "Tell your mom you did great today. The main thing is to slow down before the tricky spots."}
]


===== FILE: fixtures/golden/schema.expected.json =====

{
  "meta": {
    "lesson_id": "lesson_golden_001",
    "student_id": "student_golden_leo",
    "student_name": "Leo",
    "instrument": "piano",
    "level": "early intermediate",
    "lesson_date_iso": "2026-01-15",
    "timezone": "Europe/Brussels",
    "extraction_version": "golden-fixture-v1",
    "notes": "Golden regression fixture"
  },
  "praise_wins": [
    {
      "text": "Improved posture with relaxed shoulders.",
      "evidence": [
        {
          "quote": "Your posture is much better this week. Shoulders relaxed",
          "start_time_sec": 62,
          "end_time_sec": 78,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "text": "Good dynamic contrast in the phrase.",
      "evidence": [
        {
          "quote": "Great dynamic contrast in the phrase",
          "start_time_sec": 120,
          "end_time_sec": 138,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    }
  ],
  "pieces_assigned": [
    {
      "title": "Minuet in G",
      "composer": "",
      "section": "measures 9 to 16",
      "goal": "Lighter left-hand staccato and keep dynamic contrast.",
      "evidence": [
        {
          "quote": "Minuet in G. Let's focus on measures 9 to 16",
          "start_time_sec": 78,
          "end_time_sec": 102,
          "speaker": "Teacher"
        },
        {
          "quote": "The left hand needs lighter staccato",
          "start_time_sec": 78,
          "end_time_sec": 102,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "title": "Moonlight Sonata",
      "composer": "",
      "section": "measures 5 to 8 hands separate; chord transition in measure 12",
      "goal": "Hands separate first, then drill the measure 12 chord transition slowly.",
      "evidence": [
        {
          "quote": "Your recital piece is Moonlight Sonata. This week do measures 5 to 8",
          "start_time_sec": 138,
          "end_time_sec": 160,
          "speaker": "Teacher"
        },
        {
          "quote": "The chord change in measure 12 is still tripping you",
          "start_time_sec": 160,
          "end_time_sec": 184,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    }
  ],
  "techniques": [
    {
      "name": "Curved fingers",
      "description": "Keep fingers curved and play on the fingertips rather than flat fingers.",
      "evidence": [
        {
          "quote": "Keep your fingers curved and land on the tips, not flat",
          "start_time_sec": 12,
          "end_time_sec": 28,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "name": "Wrist-led staccato",
      "description": "Lift from the wrist for staccato instead of isolated finger motion.",
      "evidence": [
        {
          "quote": "For staccato, lift from the wrist, not the fingers",
          "start_time_sec": 102,
          "end_time_sec": 120,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "name": "Subdivision counting",
      "description": "Count subdivisions out loud to stabilize rhythm.",
      "evidence": [
        {
          "quote": "Count out loud: one e and a, two e and a",
          "start_time_sec": 184,
          "end_time_sec": 204,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    }
  ],
  "corrections": [
    {
      "issue": "Flattened fingers during scales.",
      "fix": "Keep fingers curved and play on the fingertips.",
      "where": "C major scale",
      "evidence": [
        {
          "quote": "Keep your fingers curved and land on the tips, not flat",
          "start_time_sec": 12,
          "end_time_sec": 28,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "issue": "Rushing at the top of the arpeggio.",
      "fix": "Play slowly with even sound and avoid rushing at the top.",
      "where": "C major arpeggio",
      "evidence": [
        {
          "quote": "no rushing at the top",
          "start_time_sec": 45,
          "end_time_sec": 62,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "issue": "Staccato is coming from fingers instead of wrist.",
      "fix": "Lift from the wrist and think bounce.",
      "where": "Minuet in G left hand",
      "evidence": [
        {
          "quote": "lift from the wrist, not the fingers",
          "start_time_sec": 102,
          "end_time_sec": 120,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "issue": "Chord transition is inconsistent.",
      "fix": "Repeat the transition ten times slowly.",
      "where": "Moonlight Sonata measure 12",
      "evidence": [
        {
          "quote": "Practice just that transition ten times slowly",
          "start_time_sec": 160,
          "end_time_sec": 184,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    }
  ],
  "tempo_targets": [
    {
      "piece": "C major scale",
      "bpm": 72,
      "context": "Current metronome setting for clean playing.",
      "evidence": [
        {
          "quote": "Metronome at 72 today",
          "start_time_sec": 28,
          "end_time_sec": 45,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "piece": "C major scale",
      "bpm": 84,
      "context": "Goal tempo by Friday if clean.",
      "evidence": [
        {
          "quote": "By Friday I want you at 84 if it stays clean",
          "start_time_sec": 28,
          "end_time_sec": 45,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    }
  ],
  "weekly_focus": [
    {
      "text": "Steady tempo and clean left-hand staccato, prioritizing quality over speed.",
      "evidence": [
        {
          "quote": "steady tempo and clean staccato in the left hand. Quality over speed",
          "start_time_sec": 204,
          "end_time_sec": 226,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    }
  ],
  "practice_items": [
    {
      "category": "scales",
      "instruction": "C major scale, two octaves, hands together. Start at 72 bpm and work toward 84 bpm if clean.",
      "duration_minutes": 10,
      "priority": 5,
      "evidence": [
        {
          "quote": "C major scale. Two octaves, hands together",
          "start_time_sec": 0,
          "end_time_sec": 12,
          "speaker": "Teacher"
        },
        {
          "quote": "Metronome at 72 today. By Friday I want you at 84",
          "start_time_sec": 28,
          "end_time_sec": 45,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "category": "technique",
      "instruction": "C major arpeggio, slow and even. Do not rush at the top.",
      "duration_minutes": 5,
      "priority": 4,
      "evidence": [
        {
          "quote": "Add the C major arpeggio too. Slow, even sound",
          "start_time_sec": 45,
          "end_time_sec": 62,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "category": "repertoire",
      "instruction": "Minuet in G, measures 9 to 16. Left hand staccato should come from the wrist and stay light.",
      "duration_minutes": 8,
      "priority": 4,
      "evidence": [
        {
          "quote": "Minuet in G. Let's focus on measures 9 to 16",
          "start_time_sec": 78,
          "end_time_sec": 102,
          "speaker": "Teacher"
        },
        {
          "quote": "lift from the wrist, not the fingers",
          "start_time_sec": 102,
          "end_time_sec": 120,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "category": "repertoire",
      "instruction": "Moonlight Sonata, measures 5 to 8 hands separate first.",
      "duration_minutes": 7,
      "priority": 5,
      "evidence": [
        {
          "quote": "do measures 5 to 8 hands separate first",
          "start_time_sec": 138,
          "end_time_sec": 160,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "category": "technique",
      "instruction": "Moonlight Sonata measure 12 chord transition. Repeat the transition 10 times slowly.",
      "duration_minutes": 5,
      "priority": 5,
      "evidence": [
        {
          "quote": "Practice just that transition ten times slowly",
          "start_time_sec": 160,
          "end_time_sec": 184,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "category": "rhythm",
      "instruction": "Count subdivisions out loud: one e and a, two e and a, especially in tricky spots.",
      "duration_minutes": 3,
      "priority": 3,
      "evidence": [
        {
          "quote": "Count out loud: one e and a, two e and a",
          "start_time_sec": 184,
          "end_time_sec": 204,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    }
  ],
  "concerns": [
    {
      "text": "The measure 12 chord transition in Moonlight Sonata is still inconsistent and needs slow repetition.",
      "evidence": [
        {
          "quote": "The chord change in measure 12 is still tripping you",
          "start_time_sec": 160,
          "end_time_sec": 184,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    }
  ],
  "admin_notes": [
    {
      "text": "Practice target: about 25 minutes per day, six days this week.",
      "evidence": [
        {
          "quote": "Aim for about 25 minutes a day, six days this week",
          "start_time_sec": 226,
          "end_time_sec": 248,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    }
  ]
}


===== FILE: fixtures/golden/schema.snapshot.json =====

{
  "meta": {
    "lesson_id": "lesson_golden_001",
    "student_id": "student_golden_leo",
    "student_name": "Leo",
    "instrument": "piano",
    "level": "early intermediate",
    "lesson_date_iso": "2026-01-15",
    "timezone": "Europe/Brussels",
    "extraction_version": "golden-fixture-v1",
    "notes": "Golden regression fixture"
  },
  "praise_wins": [
    {
      "text": "Improved posture with relaxed shoulders.",
      "evidence": [
        {
          "quote": "Your posture is much better this week. Shoulders relaxed",
          "start_time_sec": 62,
          "end_time_sec": 78,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "text": "Good dynamic contrast in the phrase.",
      "evidence": [
        {
          "quote": "Great dynamic contrast in the phrase",
          "start_time_sec": 120,
          "end_time_sec": 138,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    }
  ],
  "pieces_assigned": [
    {
      "title": "Minuet in G",
      "composer": "",
      "section": "measures 9 to 16",
      "goal": "Lighter left-hand staccato and keep dynamic contrast.",
      "evidence": [
        {
          "quote": "Minuet in G. Let's focus on measures 9 to 16",
          "start_time_sec": 78,
          "end_time_sec": 102,
          "speaker": "Teacher"
        },
        {
          "quote": "The left hand needs lighter staccato",
          "start_time_sec": 78,
          "end_time_sec": 102,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "title": "Moonlight Sonata",
      "composer": "",
      "section": "measures 5 to 8 hands separate; chord transition in measure 12",
      "goal": "Hands separate first, then drill the measure 12 chord transition slowly.",
      "evidence": [
        {
          "quote": "Your recital piece is Moonlight Sonata. This week do measures 5 to 8",
          "start_time_sec": 138,
          "end_time_sec": 160,
          "speaker": "Teacher"
        },
        {
          "quote": "The chord change in measure 12 is still tripping you",
          "start_time_sec": 160,
          "end_time_sec": 184,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    }
  ],
  "techniques": [
    {
      "name": "Curved fingers",
      "description": "Keep fingers curved and play on the fingertips rather than flat fingers.",
      "evidence": [
        {
          "quote": "Keep your fingers curved and land on the tips, not flat",
          "start_time_sec": 12,
          "end_time_sec": 28,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "name": "Wrist-led staccato",
      "description": "Lift from the wrist for staccato instead of isolated finger motion.",
      "evidence": [
        {
          "quote": "For staccato, lift from the wrist, not the fingers",
          "start_time_sec": 102,
          "end_time_sec": 120,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "name": "Subdivision counting",
      "description": "Count subdivisions out loud to stabilize rhythm.",
      "evidence": [
        {
          "quote": "Count out loud: one e and a, two e and a",
          "start_time_sec": 184,
          "end_time_sec": 204,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    }
  ],
  "corrections": [
    {
      "issue": "Flattened fingers during scales.",
      "fix": "Keep fingers curved and play on the fingertips.",
      "where": "C major scale",
      "evidence": [
        {
          "quote": "Keep your fingers curved and land on the tips, not flat",
          "start_time_sec": 12,
          "end_time_sec": 28,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "issue": "Rushing at the top of the arpeggio.",
      "fix": "Play slowly with even sound and avoid rushing at the top.",
      "where": "C major arpeggio",
      "evidence": [
        {
          "quote": "no rushing at the top",
          "start_time_sec": 45,
          "end_time_sec": 62,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "issue": "Staccato is coming from fingers instead of wrist.",
      "fix": "Lift from the wrist and think bounce.",
      "where": "Minuet in G left hand",
      "evidence": [
        {
          "quote": "lift from the wrist, not the fingers",
          "start_time_sec": 102,
          "end_time_sec": 120,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "issue": "Chord transition is inconsistent.",
      "fix": "Repeat the transition ten times slowly.",
      "where": "Moonlight Sonata measure 12",
      "evidence": [
        {
          "quote": "Practice just that transition ten times slowly",
          "start_time_sec": 160,
          "end_time_sec": 184,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    }
  ],
  "tempo_targets": [
    {
      "piece": "C major scale",
      "bpm": 72,
      "context": "Current metronome setting for clean playing.",
      "evidence": [
        {
          "quote": "Metronome at 72 today",
          "start_time_sec": 28,
          "end_time_sec": 45,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "piece": "C major scale",
      "bpm": 84,
      "context": "Goal tempo by Friday if clean.",
      "evidence": [
        {
          "quote": "By Friday I want you at 84 if it stays clean",
          "start_time_sec": 28,
          "end_time_sec": 45,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    }
  ],
  "weekly_focus": [
    {
      "text": "Steady tempo and clean left-hand staccato, prioritizing quality over speed.",
      "evidence": [
        {
          "quote": "steady tempo and clean staccato in the left hand. Quality over speed",
          "start_time_sec": 204,
          "end_time_sec": 226,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    }
  ],
  "practice_items": [
    {
      "category": "scales",
      "instruction": "C major scale, two octaves, hands together. Start at 72 bpm and work toward 84 bpm if clean.",
      "duration_minutes": 10,
      "priority": 5,
      "evidence": [
        {
          "quote": "C major scale. Two octaves, hands together",
          "start_time_sec": 0,
          "end_time_sec": 12,
          "speaker": "Teacher"
        },
        {
          "quote": "Metronome at 72 today. By Friday I want you at 84",
          "start_time_sec": 28,
          "end_time_sec": 45,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "category": "technique",
      "instruction": "C major arpeggio, slow and even. Do not rush at the top.",
      "duration_minutes": 5,
      "priority": 4,
      "evidence": [
        {
          "quote": "Add the C major arpeggio too. Slow, even sound",
          "start_time_sec": 45,
          "end_time_sec": 62,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "category": "repertoire",
      "instruction": "Minuet in G, measures 9 to 16. Left hand staccato should come from the wrist and stay light.",
      "duration_minutes": 8,
      "priority": 4,
      "evidence": [
        {
          "quote": "Minuet in G. Let's focus on measures 9 to 16",
          "start_time_sec": 78,
          "end_time_sec": 102,
          "speaker": "Teacher"
        },
        {
          "quote": "lift from the wrist, not the fingers",
          "start_time_sec": 102,
          "end_time_sec": 120,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "category": "repertoire",
      "instruction": "Moonlight Sonata, measures 5 to 8 hands separate first.",
      "duration_minutes": 7,
      "priority": 5,
      "evidence": [
        {
          "quote": "do measures 5 to 8 hands separate first",
          "start_time_sec": 138,
          "end_time_sec": 160,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "category": "technique",
      "instruction": "Moonlight Sonata measure 12 chord transition. Repeat the transition 10 times slowly.",
      "duration_minutes": 5,
      "priority": 5,
      "evidence": [
        {
          "quote": "Practice just that transition ten times slowly",
          "start_time_sec": 160,
          "end_time_sec": 184,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    },
    {
      "category": "rhythm",
      "instruction": "Count subdivisions out loud: one e and a, two e and a, especially in tricky spots.",
      "duration_minutes": 3,
      "priority": 3,
      "evidence": [
        {
          "quote": "Count out loud: one e and a, two e and a",
          "start_time_sec": 184,
          "end_time_sec": 204,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    }
  ],
  "concerns": [
    {
      "text": "The measure 12 chord transition in Moonlight Sonata is still inconsistent and needs slow repetition.",
      "evidence": [
        {
          "quote": "The chord change in measure 12 is still tripping you",
          "start_time_sec": 160,
          "end_time_sec": 184,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    }
  ],
  "admin_notes": [
    {
      "text": "Practice target: about 25 minutes per day, six days this week.",
      "evidence": [
        {
          "quote": "Aim for about 25 minutes a day, six days this week",
          "start_time_sec": 226,
          "end_time_sec": 248,
          "speaker": "Teacher"
        }
      ],
      "confidence": "high"
    }
  ]
}


===== FILE: fixtures/golden/recap.expected.md =====

Lesson Recap

Wins
- Better posture this week with relaxed shoulders.
- Strong dynamic contrast in the phrase.

Focus
- C major scale: keep fingers curved and play on the fingertips.
- C major arpeggio: keep it even and do not rush at the top.
- Minuet in G measures 9 to 16: lighter left-hand staccato led by the wrist.
- Moonlight Sonata: measures 5 to 8 hands separate, then drill the measure 12 chord transition slowly.

Next lesson
- We will check scale tempo progress and whether the Moonlight transition feels reliable.


===== FILE: fixtures/golden/practice_plan.expected.md =====

Practice Plan

Day 1
- (10) scales: C major scale, two octaves, hands together at 72 bpm. Curved fingers on fingertips.
- (8) repertoire: Minuet in G measures 9 to 16. Left-hand staccato from the wrist.
- (7) repertoire: Moonlight Sonata measures 5 to 8 hands separate, slow and steady.

Day 2
- (10) scales: C major scale at 72 bpm, then one clean attempt slightly faster.
- (5) technique: C major arpeggio, slow and even, no rushing at the top.
- (10) technique: Moonlight Sonata measure 12 chord transition, 10 slow reps.

Day 3
- (10) scales: C major scale, aim for clean playing and stable tempo.
- (8) repertoire: Minuet in G measures 9 to 16. Light wrist staccato in left hand.
- (7) rhythm: Count out loud one e and a, two e and a during tricky spots.

Day 4
- (10) scales: C major scale, target 76 to 80 bpm only if clean.
- (5) technique: C major arpeggio, even tone, no rushing.
- (10) repertoire: Moonlight Sonata measures 5 to 8 hands separate, then one careful hands-together try.

Day 5
- (10) scales: C major scale, push toward 84 bpm only if clean.
- (8) repertoire: Minuet in G measures 9 to 16, keep dynamics and light staccato.
- (7) technique: Moonlight Sonata measure 12 chord transition, 10 slow reps with counting.

Day 6
- (10) scales: C major scale, one best take at your cleanest tempo.
- (8) repertoire: Minuet in G measures 9 to 16, wrist-led staccato check.
- (7) repertoire: Moonlight Sonata measures 5 to 8, steady tempo and relaxed hands.


===== FILE: fixtures/golden/parent_email.expected.md =====

Hi,

Leo made strong progress today.

Highlights
- His posture has improved a lot and his shoulders stayed relaxed.
- He showed great dynamic contrast in his phrasing.

This week, please aim for about 25 minutes a day, six days if possible.

Practice focus
- C major scale, two octaves hands together. Start with metronome 72 and work toward 84 by Friday only if it stays clean.
- Add C major arpeggio slowly, keeping the sound even and avoiding any rush at the top.
- Minuet in G measures 9 to 16. The left-hand staccato should come from the wrist and stay light.
- Moonlight Sonata measures 5 to 8 hands separate first. The measure 12 chord transition is the tricky spot, so repeat that transition 10 times slowly.

Thanks, and please tell Leo he did great today.


===== FILE: tests/test_golden_fixture.py =====

from __future__ import annotations

import json
from pathlib import Path

from deepdiff import DeepDiff

from tools.validate_schema import validate as validate_json
from tools.text_checks import assert_max_words, assert_contains_any


REPO = Path(__file__).resolve().parents[1]
SCHEMA_PATH = REPO / "schemas" / "lesson_instruction.schema.json"
FIX = REPO / "fixtures" / "golden"


def _load(p: Path):
    return json.loads(p.read_text(encoding="utf-8"))


def test_expected_schema_conforms_to_json_schema():
    expected = _load(FIX / "schema.expected.json")
    validate_json(expected, SCHEMA_PATH)


def test_transcript_fixture_shape_is_reasonable():
    segs = _load(FIX / "transcript.segments.json")
    assert isinstance(segs, list)
    assert len(segs) >= 10
    first = segs[0]

    # Fixture format: {start_time_sec, end_time_sec, speaker, text}
    for k in ("start_time_sec", "end_time_sec", "speaker", "text"):
        assert k in first
    assert first["start_time_sec"] <= first["end_time_sec"]


def test_expected_outputs_basic_constraints():
    recap = (FIX / "recap.expected.md").read_text(encoding="utf-8")
    plan = (FIX / "practice_plan.expected.md").read_text(encoding="utf-8")
    email = (FIX / "parent_email.expected.md").read_text(encoding="utf-8")

    # From PROMPTING_SPEC.md constraints
    assert_max_words(recap, 180, "Recap")
    assert_max_words(email, 220, "Parent email")

    # Practice plan should have day structure (accept either Day labels or weekdays)
    assert_contains_any(plan, ["Day 1", "Day 2", "Monday", "Tuesday"], "Practice plan")


def test_schema_stability_snapshot():
    """Prevent silent edits to the golden extraction schema."""
    expected = _load(FIX / "schema.expected.json")
    snapshot = _load(FIX / "schema.snapshot.json")
    diff = DeepDiff(snapshot, expected, ignore_order=True)
    assert diff == {}, f"Golden schema changed:\n{diff}"


===== FILE: tests/test_golden_runner.py =====

from __future__ import annotations

import json
from pathlib import Path

from tools.adapters.expected_adapter import ExpectedAdapter
from tools.run_pipeline_on_fixture import run_fixture


REPO = Path(__file__).resolve().parents[1]
FIX = REPO / "fixtures" / "golden"


def test_runner_produces_expected_artifacts(tmp_path: Path):
    adapter = ExpectedAdapter(FIX)
    result = run_fixture(adapter, fixture_dir=FIX, out_dir=tmp_path, compare=True)

    assert result["ok"] is True

    # Artifacts exist
    assert (tmp_path / "schema.json").exists()
    assert (tmp_path / "recap.md").exists()
    assert (tmp_path / "practice_plan.md").exists()
    assert (tmp_path / "parent_email.md").exists()
    assert (tmp_path / "diff.json").exists()

    # Diff file should be empty diffs
    diff = json.loads((tmp_path / "diff.json").read_text(encoding="utf-8"))
    assert diff["schema"] == {}
    assert all(v == {} for v in diff["texts"].values())


===== FILE: tools/pipeline_contract.py =====

"""Pipeline adapter contract used by the golden fixture runner.

This repo is intentionally provider-agnostic. The golden runner calls an
adapter that knows how to:
  1) extract the Lesson Instruction schema from a transcript fixture, and
  2) generate the three draft outputs from that schema.

In the real product, this adapter will wrap your worker pipeline (LLM calls,
JSON validation/repair, template-based generation). In CI, we default to a
deterministic adapter that replays the expected golden outputs.
"""

from __future__ import annotations

from dataclasses import dataclass
from typing import Any, Dict, List, Protocol


@dataclass(frozen=True)
class TranscriptSegment:
    start_time_sec: float
    end_time_sec: float
    speaker: str
    text: str


@dataclass(frozen=True)
class FixtureContext:
    """Small context object passed through the pipeline.

    The golden fixture includes these in schema.meta, but real runs may supply
    them from your DB.
    """

    lesson_id: str
    student_id: str
    student_name: str
    instrument: str
    level: str | None = None
    lesson_date_iso: str | None = None
    timezone: str | None = None


class PipelineAdapter(Protocol):
    """Contract the runner expects.

    Implementations MUST be deterministic for a given input if you want
    snapshot-style comparisons.
    """

    def extract_schema(
        self,
        transcript: List[TranscriptSegment],
        context: FixtureContext,
    ) -> Dict[str, Any]:
        ...

    def generate_drafts(
        self,
        schema: Dict[str, Any],
        context: FixtureContext,
    ) -> Dict[str, str]:
        """Return mapping with keys: recap, practice_plan, parent_email."""


===== FILE: tools/adapters/init.py =====

"""Pipeline adapters for the golden fixture runner."""


===== FILE: tools/adapters/expected_adapter.py =====

"""Deterministic adapter that replays the golden expected outputs.

This is the default used in CI, because it requires no external providers.
When your real worker pipeline exists, create a new adapter that implements
PipelineAdapter and point the runner at it.
"""

from __future__ import annotations

import json
from pathlib import Path
from typing import Any, Dict, List

from tools.pipeline_contract import FixtureContext, PipelineAdapter, TranscriptSegment


class ExpectedAdapter(PipelineAdapter):
    def __init__(self, fixture_dir: str | Path):
        self.fix = Path(fixture_dir)

    def _load_json(self, p: Path) -> Any:
        return json.loads(p.read_text(encoding="utf-8"))

    def extract_schema(
        self,
        transcript: List[TranscriptSegment],
        context: FixtureContext,
    ) -> Dict[str, Any]:
        # Ignore transcript/context; the expected file is the canonical output.
        return self._load_json(self.fix / "schema.expected.json")

    def generate_drafts(
        self,
        schema: Dict[str, Any],
        context: FixtureContext,
    ) -> Dict[str, str]:
        return {
            "recap": (self.fix / "recap.expected.md").read_text(encoding="utf-8"),
            "practice_plan": (self.fix / "practice_plan.expected.md").read_text(
                encoding="utf-8"
            ),
            "parent_email": (self.fix / "parent_email.expected.md").read_text(
                encoding="utf-8"
            ),
        }


===== FILE: tools/adapters/template_adapter.py =====

"""Template for a real pipeline adapter.

Copy this into your worker service (or keep it here) and implement the two
methods using your actual extraction + generation code.

Usage:
  python tools/run_pipeline_on_fixture.py --adapter tools.adapters.template_adapter:TemplateAdapter

Once implemented, the runner will:
  - validate your extracted JSON against schemas/lesson_instruction.schema.json
  - enforce deterministic formatting constraints on drafts
  - write artifacts to artifacts/golden-run/
  - diff against fixtures/golden/*expected* (unless --no-compare)
"""

from __future__ import annotations

from typing import Any, Dict, List

from tools.pipeline_contract import FixtureContext, PipelineAdapter, TranscriptSegment


class TemplateAdapter(PipelineAdapter):
    def __init__(self, fixture_dir=None):
        # Optional: accept fixture_dir for parity with ExpectedAdapter.
        self.fixture_dir = fixture_dir

    def extract_schema(
        self,
        transcript: List[TranscriptSegment],
        context: FixtureContext,
    ) -> Dict[str, Any]:
        """Transcript -> Lesson Instruction JSON.

        TODO: call your LLM extraction step here.
        Requirements:
          - MUST return a dict that conforms to the JSON schema.
          - MUST include evidence arrays for every extracted item.
          - MUST avoid inventing info not present in the transcript.
        """
        raise NotImplementedError

    def generate_drafts(
        self,
        schema: Dict[str, Any],
        context: FixtureContext,
    ) -> Dict[str, str]:
        """Schema -> {recap, practice_plan, parent_email}.

        TODO: call your draft generation step(s) here.
        Requirements:
          - Output must respect format/length constraints enforced by tools/text_checks.py.
          - Must be grounded only in the schema.
        """
        raise NotImplementedError


===== FILE: tools/run_pipeline_on_fixture.py =====

"""Golden fixture runner.

This command is the glue between:
  - the transcript fixture (fixtures/golden/transcript.segments.json)
  - your pipeline adapter (LLM-backed extraction + generation)
  - deterministic CI checks (schema validation + golden diffs)

Default behavior:
  - uses ExpectedAdapter (replays golden expected outputs)
  - writes artifacts to artifacts/golden-run/
  - validates schema + text constraints
  - compares outputs to fixtures (diffs fail the run)

When your real worker pipeline exists:
  1) Implement an adapter class that fulfills tools.pipeline_contract.PipelineAdapter.
  2) Run with: --adapter your_module:YourAdapter
"""

from __future__ import annotations

import argparse
import importlib
import json
from dataclasses import asdict
from pathlib import Path
from typing import Any, Dict, List, Tuple

from deepdiff import DeepDiff

from tools.adapters.expected_adapter import ExpectedAdapter
from tools.pipeline_contract import FixtureContext, PipelineAdapter, TranscriptSegment
from tools.text_checks import assert_contains_any, assert_max_words
from tools.validate_schema import validate as validate_json


REPO = Path(__file__).resolve().parents[1]
DEFAULT_FIXTURE_DIR = REPO / "fixtures" / "golden"
SCHEMA_PATH = REPO / "schemas" / "lesson_instruction.schema.json"


def load_transcript_segments(path: Path) -> List[TranscriptSegment]:
    raw = json.loads(path.read_text(encoding="utf-8"))
    segs: List[TranscriptSegment] = []
    for s in raw:
        segs.append(
            TranscriptSegment(
                start_time_sec=float(s["start_time_sec"]),
                end_time_sec=float(s["end_time_sec"]),
                speaker=str(s["speaker"]),
                text=str(s["text"]),
            )
        )
    return segs


def context_from_expected_schema(expected_schema: Dict[str, Any]) -> FixtureContext:
    meta = expected_schema.get("meta", {})
    return FixtureContext(
        lesson_id=str(meta.get("lesson_id", "lesson_unknown")),
        student_id=str(meta.get("student_id", "student_unknown")),
        student_name=str(meta.get("student_name", "Student")),
        instrument=str(meta.get("instrument", "piano")),
        level=meta.get("level"),
        lesson_date_iso=meta.get("lesson_date_iso"),
        timezone=meta.get("timezone"),
    )


def import_adapter(adapter_path: str, fixture_dir: Path) -> PipelineAdapter:
    """Import adapter from 'module:ClassName' string."""
    if ":" not in adapter_path:
        raise ValueError("Adapter must be in form 'module:ClassName'")

    mod_name, cls_name = adapter_path.split(":", 1)
    mod = importlib.import_module(mod_name)
    cls = getattr(mod, cls_name)

    # Convention: adapter can optionally accept fixture_dir for convenience.
    try:
        return cls(fixture_dir)
    except TypeError:
        return cls()


def write_artifacts(out_dir: Path, schema: Dict[str, Any], drafts: Dict[str, str], meta: Dict[str, Any]) -> None:
    out_dir.mkdir(parents=True, exist_ok=True)

    (out_dir / "schema.json").write_text(
        json.dumps(schema, indent=2, ensure_ascii=False) + "\n",
        encoding="utf-8",
    )

    (out_dir / "recap.md").write_text(drafts["recap"].rstrip() + "\n", encoding="utf-8")
    (out_dir / "practice_plan.md").write_text(
        drafts["practice_plan"].rstrip() + "\n", encoding="utf-8"
    )
    (out_dir / "parent_email.md").write_text(
        drafts["parent_email"].rstrip() + "\n", encoding="utf-8"
    )

    (out_dir / "meta.json").write_text(
        json.dumps(meta, indent=2, ensure_ascii=False) + "\n",
        encoding="utf-8",
    )


def compare_to_expected(
    fixture_dir: Path,
    schema: Dict[str, Any],
    drafts: Dict[str, str],
) -> Tuple[DeepDiff, Dict[str, DeepDiff]]:
    expected_schema = json.loads((fixture_dir / "schema.expected.json").read_text(encoding="utf-8"))

    schema_diff = DeepDiff(expected_schema, schema, ignore_order=True)

    text_diffs: Dict[str, DeepDiff] = {}
    expected_recap = (fixture_dir / "recap.expected.md").read_text(encoding="utf-8").strip()
    expected_plan = (fixture_dir / "practice_plan.expected.md").read_text(encoding="utf-8").strip()
    expected_email = (fixture_dir / "parent_email.expected.md").read_text(encoding="utf-8").strip()

    text_diffs["recap"] = DeepDiff(expected_recap, drafts["recap"].strip())
    text_diffs["practice_plan"] = DeepDiff(expected_plan, drafts["practice_plan"].strip())
    text_diffs["parent_email"] = DeepDiff(expected_email, drafts["parent_email"].strip())

    return schema_diff, text_diffs


def validate_outputs(schema: Dict[str, Any], drafts: Dict[str, str]) -> None:
    validate_json(schema, SCHEMA_PATH)

    recap = drafts["recap"]
    plan = drafts["practice_plan"]
    email = drafts["parent_email"]

    assert_max_words(recap, 180, "Recap")
    assert_max_words(email, 220, "Parent email")
    assert_contains_any(plan, ["Day 1", "Monday", "Tuesday"], "Practice plan")


def run_fixture(
    adapter: PipelineAdapter,
    fixture_dir: Path = DEFAULT_FIXTURE_DIR,
    out_dir: Path | None = None,
    compare: bool = True,
) -> Dict[str, Any]:
    """Run extraction+generation on the golden fixture.

    Returns a summary dict with diffs and artifact paths (useful in tests/CI).
    """

    if out_dir is None:
        out_dir = REPO / "artifacts" / "golden-run"

    transcript = load_transcript_segments(fixture_dir / "transcript.segments.json")
    expected_schema = json.loads((fixture_dir / "schema.expected.json").read_text(encoding="utf-8"))
    context = context_from_expected_schema(expected_schema)

    schema = adapter.extract_schema(transcript, context)
    drafts = adapter.generate_drafts(schema, context)

    validate_outputs(schema, drafts)

    meta = {
        "adapter": adapter.__class__.__name__,
        "fixture_dir": str(fixture_dir),
        "context": asdict(context),
        "compare": compare,
    }

    write_artifacts(out_dir, schema, drafts, meta)

    schema_diff: DeepDiff | None = None
    text_diffs: Dict[str, DeepDiff] | None = None
    ok = True

    if compare:
        schema_diff, text_diffs = compare_to_expected(fixture_dir, schema, drafts)
        ok = (schema_diff == {}) and all(d == {} for d in text_diffs.values())

        (out_dir / "diff.json").write_text(
            json.dumps(
                {
                    "schema": schema_diff,
                    "texts": {k: v for k, v in text_diffs.items()},
                },
                indent=2,
                default=str,
                ensure_ascii=False,
            )
            + "\n",
            encoding="utf-8",
        )

    return {
        "ok": ok,
        "out_dir": str(out_dir),
        "schema_diff": schema_diff,
        "text_diffs": text_diffs,
    }


def main(argv: List[str] | None = None) -> int:
    p = argparse.ArgumentParser(description="Run pipeline on the golden transcript fixture")
    p.add_argument(
        "--fixture-dir",
        default=str(DEFAULT_FIXTURE_DIR),
        help="Path to fixture directory (default: fixtures/golden)",
    )
    p.add_argument(
        "--out-dir",
        default=str(REPO / "artifacts" / "golden-run"),
        help="Where to write artifacts",
    )
    p.add_argument(
        "--adapter",
        default="tools.adapters.expected_adapter:ExpectedAdapter",
        help="Adapter import path module:ClassName",
    )
    p.add_argument(
        "--no-compare",
        action="store_true",
        help="Skip comparing against expected fixture outputs",
    )
    args = p.parse_args(argv)

    fixture_dir = Path(args.fixture_dir)
    out_dir = Path(args.out_dir)
    adapter = import_adapter(args.adapter, fixture_dir)

    result = run_fixture(adapter, fixture_dir=fixture_dir, out_dir=out_dir, compare=not args.no_compare)
    return 0 if result["ok"] else 2


if __name__ == "__main__":
    raise SystemExit(main())


===== FILE: tools/text_checks.py =====

"""Lightweight quality gates for draft text outputs.

These checks are deterministic and run in CI. They do NOT try to assess pedagogy;
they enforce format/length constraints that keep drafts usable and predictable.
"""

from __future__ import annotations

import re


def word_count(s: str) -> int:
    # Count words as runs of letters/numbers/apostrophes.
    return len(re.findall(r"[A-Za-z0-9']+", s))


def assert_max_words(s: str, limit: int, label: str) -> None:
    wc = word_count(s)
    assert wc <= limit, f"{label} too long: {wc} words (limit {limit})"


def assert_contains_any(s: str, needles: list[str], label: str) -> None:
    hay = s.lower()
    assert any(n.lower() in hay for n in needles), f"{label} missing expected markers: {needles}"


def assert_not_contains(s: str, needles: list[str], label: str) -> None:
    hay = s.lower()
    bad = [n for n in needles if n.lower() in hay]
    assert not bad, f"{label} contains disallowed content: {bad}"


===== FILE: tools/validate_schema.py =====

"""Utilities for validating Lesson Instruction outputs against the JSON Schema.

This file is intentionally small and dependency-light so AI agents can reuse it
inside the worker pipeline and in CI.
"""

from __future__ import annotations

import json
from pathlib import Path
from typing import Any, Dict

from jsonschema import Draft202012Validator


def load_json(path: str | Path) -> Any:
    p = Path(path)
    return json.loads(p.read_text(encoding="utf-8"))


def get_validator(schema_path: str | Path) -> Draft202012Validator:
    schema = load_json(schema_path)
    return Draft202012Validator(schema)


def validate(instance: Dict[str, Any], schema_path: str | Path) -> None:
    """Raises jsonschema.ValidationError on failure."""
    v = get_validator(schema_path)
    v.validate(instance)


</exampleBeta>
<exampleDelta>

# Note By Note: AI Practice Plan Generator for Music Teachers

## Project Goal
Build a **functional MVP** as a **web app** and **iOS app** (cross-platform where possible) that allows music teachers to:
- Record a lesson on their phone
- Automatically transcribe it
- Generate an editable student recap and daily practice plan
- Review/edit/send the outputs

The MVP must be **elegant** (sleek, professional, minimalist UI) and **efficient** (all core functionalities working, â‰¥80% test coverage).

Target launch platforms:
- iOS app (primary for recording)
- Web app (for review, editing, student management, history)

## Recommended Tech Stack (Optimized for AI Agent Development)

| Layer              | Technology                          | Rationale                                                                 |
|------------------------|-------------------------------------|---------------------------------------------------------------------------|
| Frontend (Web + iOS)   | React Native + Expo (with expo-web) | Single codebase for web and iOS, fast iteration, excellent audio recording |
| UI Framework           | NativeWind (Tailwind CSS for RN) or Tamagui | Sleek, professional, responsive design with minimal effort                |
| State Management       | Zustand or Redux Toolkit            | Simple, scalable                                                          |
| Backend                | Supabase                            | Auth, PostgreSQL DB, Storage, Serverless Functions â€” zero server management |
| Transcription          | OpenAI Whisper API                  | Best-in-class speech-to-text, handles music lesson jargon well            |
| LLM Processing         | OpenAI GPT-4o or GPT-4o-mini        | Structured extraction and generation of recap + practice plan             |
| Audio Recording        | Expo AV                             | Native-quality recording on iOS, easy upload                              |
| Testing                | Jest + React Native Testing Library + Cypress (web) | High test coverage goal                                                   |
| CI/CD                  | GitHub Actions + Expo EAS           | Automated builds and deployments                                          |
| Analytics              | PostHog (self-hosted on Supabase)   | Optional for MVP                                                          |

This stack is deliberately simple and well-documented, allowing AI agents to generate reliable code with minimal context switching.

## High-Level Architecture

```
User (iOS/Web)
   â†“
Expo React Native App
   â†“ (Auth)
Supabase Auth
   â†“
Record Audio â†’ Save locally â†’ Upload to Supabase Storage
   â†“
Trigger Supabase Edge Function
   â†“
1. Download audio
2. Call OpenAI Whisper API â†’ Transcript
3. Call OpenAI GPT-4o with structured prompt â†’ JSON output (recap + practice_plan)
4. Save transcript + generated content to Supabase DB
   â†“
App polls/subscribes (Supabase Realtime) â†’ Display editable recap & plan
   â†“
Teacher edits â†’ Saves â†’ Copies or emails
```

## Core User Flows (MVP Scope)

1. **Onboarding**
   - Sign up / Log in (email + password or Google)
   - Short welcome tour (2-3 screens)

2. **Student Management**
   - List of students
   - Add/Edit student (name, instrument, optional parent email, notes)

3. **New Lesson**
   - Select student
   - Start recording (big clean record button, timer, waveform optional)
   - Stop recording
   - Auto-upload + processing indicator ("Transcribingâ€¦", "Analyzing lessonâ€¦")
   - Show generated recap + practice plan (editable text fields)
   - Save draft or Send (copy to clipboard + optional email via share sheet on iOS / mailto on web)

4. **History**
   - List past lessons per student
   - View transcript, recap, practice plan
   - Re-edit and re-send if needed

## Data Model (Supabase Tables)

```sql
users (Supabase auth users)

students
- id (uuid)
- user_id (uuid)
- name (text)
- instrument (text)
- parent_email (text nullable)
- notes (text nullable)
- created_at

lessons
- id (uuid)
- user_id (uuid)
- student_id (uuid)
- audio_url (text)          -- Supabase storage path
- transcript (text)
- recap (text)              -- editable
- practice_plan (text)     -- editable JSON string or markdown
- status (enum: processing, ready, edited)
- created_at
```

## LLM Prompts (Hard-coded in Edge Function)

### Prompt 1: Structured Extraction + Generation

```text
You are an expert music teaching assistant. Analyze the following lesson transcript from a {instrument} lesson.

Extract and summarize:
- Key positive moments / wins
- Areas to improve
- Specific pieces or exercises assigned
- Techniques introduced or corrected
- Tempo targets, scales, chords mentioned
- Any homework or focus areas mentioned

Then generate:
1. Student Recap (200-300 words, encouraging tone, highlight wins first, then constructive feedback)
2. Daily Practice Plan for the next 7 days (bullet list, realistic 15-30 min sessions, specific exercises with measures/reps/tempo)

Output strictly as JSON:
{
  "recap": "string",
  "practice_plan": "string (markdown formatted)"
}

Transcript:
{transcript}
```

Fine-tune the prompt with a few examples during development.

## UI/UX Guidelines (Elegant & Professional)

- Color palette: Soft neutrals (white, light gray), deep teal/blue accents, black text
- Typography: System fonts (San Francisco on iOS, Roboto on web), generous spacing
- Icons: Feather or Lucide icons
- Screens:
  - Home: List of students (cards) + FAB to add student
  - Student detail: Past lessons list + big "New Lesson" button
  - Recording screen: Full-screen centered record button, timer, subtle waveform
  - Processing screen: Calm animation + progress messages
  - Edit screen: Clean text fields with markdown preview for practice plan
  - Use subtle shadows, rounded corners, ample whitespace

## MVP Scope (Whatâ€™s In / Out)

**IN**
- Auth
- Student CRUD
- Audio recording & upload (iOS + web)
- Transcription via Whisper
- LLM generation of recap + practice plan
- Editable outputs
- Copy to clipboard + basic share (mailto/share sheet)
- Lesson history
- Responsive web version
- â‰¥80% test coverage (unit + integration)

**OUT (Post-MVP)**
- Payments/subscriptions
- Parent portal
- Multiple instruments advanced tuning
- In-app email sending (can add later with Resend or SendGrid)
- Advanced analytics
- Android app
- Offline recording

## Project Structure (Monorepo)

```
note-by-note/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ web/          (Expo web)
â”‚   â””â”€â”€ ios/          (Expo iOS)
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ ui/           (shared components with Tamagui/NativeWind)
â”‚   â””â”€â”€ types/        (shared TypeScript types)
â”œâ”€â”€ supabase/
â”‚   â”œâ”€â”€ functions/
â”‚   â”‚   â””â”€â”€ process-lesson/
â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â””â”€â”€ migrations/
â”œâ”€â”€ tests/
â”œâ”€â”€ .github/workflows/
â”œâ”€â”€ README.md
â”œâ”€â”€ package.json
```

## README.md Template

```markdown
# Note By Note

AI-powered practice plan generator for private music teachers.

## Features
- Record lessons on iOS or web
- Automatic transcription (OpenAI Whisper)
- AI-generated student recap & 7-day practice plan
- Editable outputs
- Student management & lesson history

## Development Setup

1. Install dependencies
   ```bash
   npm install
   ```

2. Set up Supabase
   - Create project
   - Add tables via migrations
   - Create storage bucket "lesson-audio"
   - Deploy edge function `process-lesson`

3. Environment variables (.env)
   ```
   EXPO_PUBLIC_SUPABASE_URL=
   EXPO_PUBLIC_SUPABASE_ANON_KEY=
   SUPABASE_SERVICE_ROLE_KEY=   # only in functions
   OPENAI_API_KEY=
   ```

4. Run
   ```bash
   npx expo start
   ```

## Testing
```bash
npm test
# Aim for â‰¥80% coverage
npm run test:coverage
```

## Deployment
- Web: `eas build --platform web`
- iOS: `eas build --platform ios`

```

## Testing Requirements
- Unit tests for all utilities, prompts, components
- Integration tests for recording â†’ upload â†’ processing flow
- E2E tests with Cypress (web) and Detox (iOS) for critical paths
- Target: 80%+ coverage (statements, branches)

## Next Steps for AI Agent Team
1. Set up repo + Supabase project
2. Implement auth + student management
3. Implement recording + upload
4. Build Supabase edge function for transcription + LLM
5. Implement processing UI + realtime updates
6. Polish UI according to guidelines
7. Add tests iteratively
8. Deploy web + iOS builds

This documentation package provides everything needed for an AI agent engineering team to deliver a high-quality, elegant, functional MVP.

</exampleDelta>
<exampleEpsilon>

# Note By Note

**AI Practice Plan Generator for Music Teachers**

[![Version](https://img.shields.io/badge/version-1.0.0--MVP-blue.svg)]()
[![Platform](https://img.shields.io/badge/platform-Web%20%7C%20iOS-lightgrey.svg)]()
[![License](https://img.shields.io/badge/license-Proprietary-red.svg)]()

## Overview

Note By Note is an AI-powered assistant that transforms music lesson recordings into actionable practice plans, student recaps, and parent communications. By leveraging speech-to-text and large language models, it eliminates the 2-3 hours teachers spend daily on administrative tasks.

## The Problem

Private music teachers spend countless hours after lessons writing:
- Practice plans for each student (daily assignments)
- Progress recaps highlighting wins and areas for improvement
- Parent emails summarizing lessons and next steps

A teacher with 23 students can spend 3+ hours per night on administrative work alone.

## The Solution

Note By Note listens so teachers don't have to write:

1. **Record** - Hit record on your phone during the lesson
2. **Teach** - Conduct the lesson as normal
3. **Review** - AI generates three editable outputs:
   - **Student Recap**: Highlights wins and areas to work on
   - **Practice Plan**: Daily assignments broken down by day
   - **Parent Email**: Professional summary of progress

**20 minutes of typing becomes 20 seconds of review.**

## Key Features

### Core Functionality
- ðŸŽ™ï¸ **One-tap recording** with high-quality audio capture
- ðŸ¤– **AI transcription** using OpenAI Whisper
- ðŸ“ **Intelligent extraction** of musical instructions, corrections, and assignments
- ðŸ“… **Daily practice plans** auto-generated from lesson content
- ðŸ“§ **Parent-ready emails** with customizable templates
- âœï¸ **Quick editing** before sending any output

### Platform Support
- ðŸ“± **iOS Native App** - Optimized for in-lesson recording
- ðŸ’» **Web Application** - Full management dashboard
- ðŸ”„ **Cross-platform sync** - Seamless data across devices

### Teacher Tools
- ðŸ‘¨â€ðŸŽ“ **Student management** with profiles and history
- ðŸ“Š **Progress tracking** across lessons
- ðŸ“š **Lesson library** with searchable transcripts
- âš™ï¸ **Customizable templates** for outputs

## Tech Stack

### Frontend
| Component | Technology |
|-----------|------------|
| Web App | Next.js 14 (App Router), TypeScript, Tailwind CSS |
| iOS App | Swift 5, SwiftUI, Combine |
| State Management | Zustand (Web), SwiftUI @Observable (iOS) |
| UI Components | Radix UI, Shadcn/ui |

### Backend
| Component | Technology |
|-----------|------------|
| API | Node.js, Express.js, TypeScript |
| Database | PostgreSQL with Prisma ORM |
| Authentication | Clerk (OAuth + Email/Password) |
| File Storage | AWS S3 / Cloudflare R2 |
| Queue System | BullMQ with Redis |

### AI/ML
| Component | Technology |
|-----------|------------|
| Transcription | OpenAI Whisper API |
| Content Generation | OpenAI GPT-4o / Claude 3.5 Sonnet |
| Prompt Engineering | Custom music-domain prompts |

### Infrastructure
| Component | Technology |
|-----------|------------|
| Hosting | Vercel (Web), Railway (API) |
| CDN | Cloudflare |
| Monitoring | Sentry, LogRocket |
| CI/CD | GitHub Actions |

## Project Structure

```
note-by-note/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ web/                 # Next.js web application
â”‚   â”‚   â”œâ”€â”€ app/            # App router pages
â”‚   â”‚   â”œâ”€â”€ components/     # React components
â”‚   â”‚   â”œâ”€â”€ lib/           # Utilities and helpers
â”‚   â”‚   â””â”€â”€ styles/        # Global styles
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                # Express.js backend
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ routes/    # API endpoints
â”‚   â”‚   â”‚   â”œâ”€â”€ services/  # Business logic
â”‚   â”‚   â”‚   â”œâ”€â”€ models/    # Data models
â”‚   â”‚   â”‚   â””â”€â”€ utils/     # Helpers
â”‚   â”‚   â””â”€â”€ prisma/        # Database schema
â”‚   â”‚
â”‚   â””â”€â”€ ios/               # Swift iOS application
â”‚       â”œâ”€â”€ NoteByNote/
â”‚       â”‚   â”œâ”€â”€ Views/     # SwiftUI views
â”‚       â”‚   â”œâ”€â”€ Models/    # Data models
â”‚       â”‚   â”œâ”€â”€ Services/  # API & Audio services
â”‚       â”‚   â””â”€â”€ Utils/     # Helpers
â”‚       â””â”€â”€ Tests/
â”‚
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ shared/            # Shared TypeScript types
â”‚   â”œâ”€â”€ ai-prompts/        # LLM prompt templates
â”‚   â””â”€â”€ ui/               # Shared UI components
â”‚
â”œâ”€â”€ docs/                  # Documentation
â”‚   â”œâ”€â”€ PRD.md
â”‚   â”œâ”€â”€ TECHNICAL_SPEC.md
â”‚   â”œâ”€â”€ API_DESIGN.md
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ infrastructure/        # IaC and deployment
    â”œâ”€â”€ terraform/
    â””â”€â”€ docker/
```

## Quick Start

### Prerequisites
- Node.js 20+
- pnpm 8+
- PostgreSQL 15+
- Redis 7+
- Xcode 15+ (for iOS development)

### Environment Setup

```bash
# Clone the repository
git clone https://github.com/your-org/note-by-note.git
cd note-by-note

# Install dependencies
pnpm install

# Set up environment variables
cp .env.example .env.local

# Initialize database
pnpm db:push
pnpm db:seed

# Start development servers
pnpm dev
```

### Environment Variables

```env
# Database
DATABASE_URL="postgresql://user:pass@localhost:5432/notebynote"

# Redis
REDIS_URL="redis://localhost:6379"

# Authentication (Clerk)
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY="pk_..."
CLERK_SECRET_KEY="sk_..."

# AI Services
OPENAI_API_KEY="sk-..."
ANTHROPIC_API_KEY="sk-ant-..."

# Storage
AWS_ACCESS_KEY_ID="..."
AWS_SECRET_ACCESS_KEY="..."
AWS_S3_BUCKET="notebynote-uploads"

# App URLs
NEXT_PUBLIC_APP_URL="http://localhost:3000"
API_URL="http://localhost:4000"
```

## Documentation Index

| Document | Description |
|----------|-------------|
| [PRD.md](./docs/PRD.md) | Product Requirements Document |
| [TECHNICAL_SPEC.md](./docs/TECHNICAL_SPEC.md) | Technical Architecture |
| [API_DESIGN.md](./docs/API_DESIGN.md) | REST API Specification |
| [DATABASE_SCHEMA.md](./docs/DATABASE_SCHEMA.md) | Data Models & Schema |
| [UI_UX_SPEC.md](./docs/UI_UX_SPEC.md) | User Interface Specifications |
| [IOS_SPEC.md](./docs/IOS_SPEC.md) | iOS Application Specification |
| [AI_PROMPTS.md](./docs/AI_PROMPTS.md) | LLM Prompt Engineering |
| [TEST_PLAN.md](./docs/TEST_PLAN.md) | Testing Strategy |
| [DEVELOPMENT_GUIDE.md](./docs/DEVELOPMENT_GUIDE.md) | Developer Setup Guide |

## Business Model

| Plan | Price | Features |
|------|-------|----------|
| Solo Teacher | $49/month | 1 user, 50 lessons/month, all features |
| Studio | $99/month | 5 users, 200 lessons/month, analytics |
| Enterprise | Custom | Unlimited, API access, custom integrations |

## Target Metrics

- **MVP Launch**: 3-4 weeks development
- **Target**: 850 paying teachers = $500K ARR
- **Market**: 100,000+ private music instructors in US alone

## Contributing

This project is built by AI agents. All contributions should follow the specifications outlined in the documentation. See [DEVELOPMENT_GUIDE.md](./docs/DEVELOPMENT_GUIDE.md) for coding standards and contribution guidelines.

## License

Proprietary - All rights reserved.

---

Built with â¤ï¸ for music teachers everywhere.

# Product Requirements Document (PRD)

## Note By Note - AI Practice Plan Generator for Music Teachers

**Version:** 1.0.0-MVP  
**Last Updated:** January 2025  
**Status:** Ready for Development  

---

## 1. Executive Summary

### 1.1 Product Vision
Note By Note transforms music lesson recordings into actionable practice plans, student recaps, and parent communications using AI. The platform eliminates the 2-3 hours teachers spend daily on administrative tasks, allowing them to focus on what they do best: teaching.

### 1.2 Problem Statement
Private music teachers face a significant administrative burden:
- **Time sink**: Teachers with 20+ students spend 2-3 hours nightly writing practice plans and parent emails
- **Inconsistency**: Manual notes vary in quality based on energy and time available
- **Delayed communication**: Parents often receive updates days after lessons
- **No leverage**: The same type of content is written repeatedly with slight variations

### 1.3 Solution
An AI-powered mobile and web application that:
1. Records lesson audio with a single tap
2. Transcribes and analyzes the lesson using AI
3. Generates three outputs: Student Recap, Practice Plan, Parent Email
4. Allows quick editing before sending
5. Maintains a searchable history of all lessons and communications

### 1.4 Success Metrics
| Metric | Target | Measurement |
|--------|--------|-------------|
| Time Saved | 90% reduction in admin time | User surveys, time tracking |
| User Adoption | 500 paying users in 6 months | Subscription count |
| Output Quality | 85% sent without edits | Edit rate analytics |
| User Retention | 80% month-over-month | Subscription renewals |
| NPS Score | 50+ | Quarterly surveys |

---

## 2. User Personas

### 2.1 Primary Persona: Sarah the Solo Teacher

**Demographics:**
- Age: 35-55
- Location: Suburban USA
- Income: $40,000-80,000/year from teaching
- Technical proficiency: Moderate (comfortable with smartphones, basic apps)

**Profile:**
Sarah is a piano teacher with 25 weekly students ranging from beginners to advanced. She teaches from her home studio. After lessons end at 6pm, she spends 2-3 hours writing practice plans and parent emails. She's exhausted by this routine but knows consistent communication is essential for student progress and parent satisfaction.

**Goals:**
- Reduce administrative time without sacrificing quality
- Send professional communications to parents
- Track student progress over time
- Maintain work-life balance

**Pain Points:**
- Spends more time writing than teaching
- Forgets lesson details when writing later
- Inconsistent quality of notes when tired
- No searchable history of past lessons

**Quote:** "I love teaching, but the paperwork is killing me."

### 2.2 Secondary Persona: Michael the Studio Owner

**Demographics:**
- Age: 40-60
- Location: Urban/Suburban USA
- Income: $100,000-200,000/year from studio
- Technical proficiency: High (uses studio management software)

**Profile:**
Michael owns a music studio with 5 teachers and 150 students. He needs consistent communication standards across all teachers. Currently, each teacher handles their own communications with varying quality. He wants a unified system that maintains his studio's professional image.

**Goals:**
- Standardize communications across all teachers
- Monitor teacher-parent communications
- Ensure consistent student experience
- Scale the studio without administrative overhead

**Pain Points:**
- Inconsistent communication quality between teachers
- No visibility into lesson content
- Difficulty maintaining standards at scale
- High teacher turnover due to admin burden

---

## 3. Feature Requirements

### 3.1 Feature Priority Matrix

| Priority | Feature | User Value | Technical Complexity |
|----------|---------|------------|---------------------|
| P0 | Audio Recording | Critical | Low |
| P0 | AI Transcription | Critical | Medium |
| P0 | Practice Plan Generation | Critical | High |
| P0 | Student Recap Generation | Critical | High |
| P0 | Parent Email Generation | Critical | High |
| P0 | Output Editing | Critical | Low |
| P1 | Student Management | High | Medium |
| P1 | User Authentication | Critical | Low |
| P1 | Web Dashboard | High | Medium |
| P2 | Lesson History | Medium | Low |
| P2 | Template Customization | Medium | Medium |
| P2 | Progress Tracking | Medium | High |
| P3 | Email Integration | Low | Medium |
| P3 | Analytics Dashboard | Low | High |

### 3.2 Core Features (P0 - MVP Required)

#### 3.2.1 Audio Recording

**Description:** One-tap lesson recording with background-capable audio capture.

**Functional Requirements:**
| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| REC-001 | Single tap to start recording | Recording starts within 500ms of button press |
| REC-002 | Visual recording indicator | Pulsing red dot visible at all times during recording |
| REC-003 | Recording timer display | Shows elapsed time in MM:SS format |
| REC-004 | Background recording support | Recording continues when app is backgrounded |
| REC-005 | Pause/Resume functionality | User can pause and resume without creating new files |
| REC-006 | Auto-save on interruption | Recording saved if call received or app crashes |
| REC-007 | Audio quality settings | Minimum 16kHz sample rate, mono, AAC codec |
| REC-008 | Maximum recording length | Support recordings up to 90 minutes |
| REC-009 | Storage indication | Show estimated storage remaining |
| REC-010 | Stop and process action | Single action to stop recording and initiate processing |

**Technical Specifications:**
- Audio format: AAC, 64kbps, mono, 16kHz minimum
- Maximum file size: ~100MB (90 minutes)
- Local storage with background upload
- Waveform visualization during recording

#### 3.2.2 AI Transcription

**Description:** Convert recorded audio to text using OpenAI Whisper API.

**Functional Requirements:**
| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| TRX-001 | Automatic transcription | Transcription begins automatically after recording stops |
| TRX-002 | Processing indicator | Show progress bar with estimated time remaining |
| TRX-003 | Speaker diarization | Distinguish between teacher and student speech |
| TRX-004 | Music terminology accuracy | 95%+ accuracy on common music terms |
| TRX-005 | Timestamp alignment | Transcript segments aligned to audio timestamps |
| TRX-006 | Error handling | Clear error messages with retry option |
| TRX-007 | Transcript viewing | Full transcript viewable after processing |
| TRX-008 | Processing time | Complete within 2x audio length |

**Technical Specifications:**
- API: OpenAI Whisper API (whisper-1)
- Chunking: Split audio into 25MB chunks if needed
- Language: English (expandable to other languages)
- Response format: Verbose JSON with timestamps

#### 3.2.3 AI Content Generation

**Description:** Generate three outputs from the transcription using LLM.

**Functional Requirements:**
| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| GEN-001 | Generate Student Recap | 150-300 word summary of lesson highlights |
| GEN-002 | Generate Practice Plan | Daily breakdown for 7 days with specific exercises |
| GEN-003 | Generate Parent Email | Professional email ready to send |
| GEN-004 | Music-domain accuracy | Correctly identify techniques, pieces, and terminology |
| GEN-005 | Personalization | Include student name and specific details |
| GEN-006 | Tone consistency | Maintain encouraging, professional tone |
| GEN-007 | Actionable items | Practice plan items are specific and measurable |
| GEN-008 | Generation time | All three outputs generated within 30 seconds |

**Output Specifications:**

**Student Recap:**
```
Structure:
- Greeting with student name
- What went well (2-3 bullet points)
- Areas to focus on (2-3 bullet points)  
- Encouragement for next lesson

Length: 150-300 words
Tone: Positive, specific, actionable
```

**Practice Plan:**
```
Structure:
- Duration per day (e.g., 30 minutes)
- Day 1-7 breakdown with:
  - Specific exercise/piece
  - Time allocation
  - Focus area
  - Tips for execution

Length: 300-500 words
Format: Structured daily list
```

**Parent Email:**
```
Structure:
- Professional greeting
- Lesson summary (1 paragraph)
- Key achievements (brief)
- Practice plan overview
- Next lesson focus
- Professional closing

Length: 200-400 words
Tone: Professional, warm, informative
```

#### 3.2.4 Output Editing

**Description:** Allow teachers to review and edit generated content before sending.

**Functional Requirements:**
| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| EDT-001 | Inline text editing | Click any text to edit directly |
| EDT-002 | Regenerate section | Button to regenerate specific output |
| EDT-003 | Undo/Redo support | Unlimited undo/redo within session |
| EDT-004 | Auto-save drafts | Changes saved automatically every 5 seconds |
| EDT-005 | Preview mode | View formatted output as recipient will see it |
| EDT-006 | Copy to clipboard | One-click copy for any output |
| EDT-007 | Mark as final | Explicit action to finalize outputs |
| EDT-008 | Edit history | Track changes made to generated content |

#### 3.2.5 User Authentication

**Description:** Secure user registration and login.

**Functional Requirements:**
| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| AUTH-001 | Email/password registration | Standard registration flow |
| AUTH-002 | Social login (Google) | One-click Google sign-in |
| AUTH-003 | Social login (Apple) | One-click Apple sign-in (required for iOS) |
| AUTH-004 | Password reset | Email-based password reset flow |
| AUTH-005 | Session management | Persistent sessions with secure token refresh |
| AUTH-006 | Account settings | Update email, password, profile information |
| AUTH-007 | Account deletion | GDPR-compliant account deletion |
| AUTH-008 | iOS/Web sync | Same account works across platforms |

### 3.3 Essential Features (P1 - MVP Included)

#### 3.3.1 Student Management

**Description:** Manage student profiles and associate lessons.

**Functional Requirements:**
| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| STU-001 | Create student profile | Name, instrument, skill level, parent info |
| STU-002 | Edit student profile | Update any field at any time |
| STU-003 | Delete student | Soft delete with data retention option |
| STU-004 | Student list view | Sortable, searchable list of all students |
| STU-005 | Associate lesson | Link recording to specific student |
| STU-006 | Parent contact info | Store parent email for communications |
| STU-007 | Lesson history per student | View all past lessons for a student |
| STU-008 | Import students | CSV upload for bulk import |

**Student Profile Fields:**
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| id | UUID | Yes | System generated |
| firstName | String | Yes | Student first name |
| lastName | String | Yes | Student last name |
| email | String | No | Student email (if applicable) |
| parentFirstName | String | No | Parent/guardian first name |
| parentLastName | String | No | Parent/guardian last name |
| parentEmail | String | Yes | Parent email for communications |
| instrument | Enum | Yes | Piano, Violin, Guitar, Voice, Other |
| skillLevel | Enum | Yes | Beginner, Intermediate, Advanced |
| lessonDay | Enum | No | Typical lesson day |
| lessonTime | Time | No | Typical lesson time |
| notes | Text | No | Private teacher notes |
| createdAt | DateTime | Yes | System generated |
| updatedAt | DateTime | Yes | System generated |

#### 3.3.2 Web Dashboard

**Description:** Full-featured web application for managing lessons and students.

**Functional Requirements:**
| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| WEB-001 | Responsive design | Works on desktop, tablet, mobile |
| WEB-002 | Dashboard home | Overview of recent lessons, pending tasks |
| WEB-003 | Student list page | Full CRUD for students |
| WEB-004 | Lesson list page | View all lessons with filters |
| WEB-005 | Lesson detail page | View transcript, outputs, audio player |
| WEB-006 | Settings page | Account, preferences, templates |
| WEB-007 | Upload audio | Web-based audio upload option |
| WEB-008 | Real-time updates | WebSocket for processing status |

### 3.4 Enhanced Features (P2 - Post-MVP)

#### 3.4.1 Lesson History & Search

**Functional Requirements:**
| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| HIS-001 | Full-text search | Search across all transcripts |
| HIS-002 | Filter by student | View lessons for specific student |
| HIS-003 | Filter by date range | View lessons within date range |
| HIS-004 | Sort options | Sort by date, student, duration |
| HIS-005 | Export history | Download lesson history as PDF/CSV |

#### 3.4.2 Template Customization

**Functional Requirements:**
| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| TPL-001 | Custom practice plan template | Define structure and prompts |
| TPL-002 | Custom email template | Define greeting, closing, tone |
| TPL-003 | Template preview | Preview with sample data |
| TPL-004 | Template library | Save multiple templates |
| TPL-005 | Per-student template | Assign templates to students |

### 3.5 Future Features (P3 - Backlog)

- Email integration (send directly from app)
- Calendar integration (sync with Google Calendar, Apple Calendar)
- Analytics dashboard (student progress over time)
- Multi-language support
- Voice commands during lessons
- Integration with music notation software
- Parent portal for viewing updates

---

## 4. User Flows

### 4.1 Core Flow: Record and Generate

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        RECORD AND GENERATE FLOW                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[Open App] 
    â”‚
    â–¼
[Dashboard/Home Screen]
    â”‚
    â”œâ”€â”€ [New Recording] â—„â”€â”€ Primary CTA
    â”‚         â”‚
    â”‚         â–¼
    â”‚   [Select Student] â—„â”€â”€ Required before recording
    â”‚         â”‚
    â”‚         â”œâ”€â”€ [Existing Student] 
    â”‚         â”‚         â”‚
    â”‚         â”‚         â–¼
    â”‚         â”‚   [Student Selected]
    â”‚         â”‚
    â”‚         â””â”€â”€ [+ Add New Student]
    â”‚                   â”‚
    â”‚                   â–¼
    â”‚             [Quick Add Form]
    â”‚                   â”‚
    â”‚                   â–¼
    â”‚             [Student Created & Selected]
    â”‚                   â”‚
    â”‚         â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚         â”‚
    â”‚         â–¼
    â”‚   [Recording Screen]
    â”‚         â”‚
    â”‚         â”œâ”€â”€ [â— Record Button] â—„â”€â”€ Tap to start
    â”‚         â”‚         â”‚
    â”‚         â”‚         â–¼
    â”‚         â”‚   [Recording Active]
    â”‚         â”‚   - Timer running
    â”‚         â”‚   - Waveform display
    â”‚         â”‚   - Pause button available
    â”‚         â”‚         â”‚
    â”‚         â”‚         â”œâ”€â”€ [â¸ Pause]
    â”‚         â”‚         â”‚      â”‚
    â”‚         â”‚         â”‚      â–¼
    â”‚         â”‚         â”‚   [Paused State]
    â”‚         â”‚         â”‚      â”‚
    â”‚         â”‚         â”‚      â””â”€â”€ [â–¶ Resume] â”€â”€â”€â”
    â”‚         â”‚         â”‚                        â”‚
    â”‚         â”‚         â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚         â”‚         â”‚
    â”‚         â”‚         â””â”€â”€ [â–  Stop & Process]
    â”‚         â”‚                   â”‚
    â”‚         â”‚                   â–¼
    â”‚         â”‚             [Upload & Process]
    â”‚         â”‚             - Progress: Uploading...
    â”‚         â”‚             - Progress: Transcribing...
    â”‚         â”‚             - Progress: Generating...
    â”‚         â”‚                   â”‚
    â”‚         â”‚                   â–¼
    â”‚         â”‚             [Results Screen]
    â”‚         â”‚             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚             â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚         â”‚             â”‚ â”‚ STUDENT RECAP   â”‚ â”‚
    â”‚         â”‚             â”‚ â”‚ [Edit] [Regen]  â”‚ â”‚
    â”‚         â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚         â”‚             â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚         â”‚             â”‚ â”‚ PRACTICE PLAN   â”‚ â”‚
    â”‚         â”‚             â”‚ â”‚ [Edit] [Regen]  â”‚ â”‚
    â”‚         â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚         â”‚             â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚         â”‚             â”‚ â”‚ PARENT EMAIL    â”‚ â”‚
    â”‚         â”‚             â”‚ â”‚ [Edit] [Regen]  â”‚ â”‚
    â”‚         â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚         â”‚             â”‚                     â”‚
    â”‚         â”‚             â”‚ [Copy All] [Done]   â”‚
    â”‚         â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚         â”‚                   â”‚
    â”‚         â”‚                   â”œâ”€â”€ [Edit Any Section]
    â”‚         â”‚                   â”‚         â”‚
    â”‚         â”‚                   â”‚         â–¼
    â”‚         â”‚                   â”‚   [Inline Editor]
    â”‚         â”‚                   â”‚         â”‚
    â”‚         â”‚                   â”‚         â””â”€â”€ [Save Changes]
    â”‚         â”‚                   â”‚                   â”‚
    â”‚         â”‚                   â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚         â”‚                   â”‚
    â”‚         â”‚                   â””â”€â”€ [Done / Save]
    â”‚         â”‚                             â”‚
    â”‚         â”‚                             â–¼
    â”‚         â”‚                       [Lesson Saved]
    â”‚         â”‚                             â”‚
    â”‚         â”‚                             â–¼
    â”‚         â”‚                       [Return to Dashboard]
    â”‚         â”‚
    â”‚         â””â”€â”€ [Cancel]
    â”‚                   â”‚
    â”‚                   â–¼
    â”‚             [Confirm Discard?]
    â”‚                   â”‚
    â”‚                   â”œâ”€â”€ [Yes] â”€â”€â–º [Dashboard]
    â”‚                   â””â”€â”€ [No] â”€â”€â–º [Recording Screen]
    â”‚
    â””â”€â”€ [View Students] / [View Lessons] / [Settings]
              â”‚
              â–¼
        [Respective Screens]
```

### 4.2 Onboarding Flow

```
[First Launch]
    â”‚
    â–¼
[Welcome Screen]
"Welcome to Note By Note"
"Transform lessons into practice plans in seconds"
    â”‚
    â–¼
[Sign Up / Sign In]
    â”‚
    â”œâ”€â”€ [Sign Up with Email]
    â”‚         â”‚
    â”‚         â–¼
    â”‚   [Email + Password Form]
    â”‚         â”‚
    â”‚         â–¼
    â”‚   [Verify Email]
    â”‚
    â”œâ”€â”€ [Sign In with Google]
    â”‚         â”‚
    â”‚         â–¼
    â”‚   [OAuth Flow]
    â”‚
    â””â”€â”€ [Sign In with Apple]
              â”‚
              â–¼
        [OAuth Flow]
              â”‚
              â–¼
[Profile Setup]
- Name
- Studio/School Name (optional)
- Primary Instrument(s)
- Typical Students per Week
    â”‚
    â–¼
[Add First Student]
"Let's add your first student"
- Name
- Parent Email
- Instrument
- Skill Level
    â”‚
    â–¼
[Microphone Permission]
"Note By Note needs microphone access to record lessons"
[Allow] [Skip for Now]
    â”‚
    â–¼
[Ready to Go!]
"Record your first lesson"
[Start Recording] â”€â”€â–º [Recording Screen]
```

### 4.3 Student Management Flow

```
[Students Tab]
    â”‚
    â–¼
[Student List]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Search...        ] [+ Add]    â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ðŸŽ¹ Emma Wilson              â”‚ â”‚
â”‚ â”‚ Piano â€¢ Intermediate        â”‚ â”‚
â”‚ â”‚ Last lesson: 2 days ago    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ðŸŽ» James Chen               â”‚ â”‚
â”‚ â”‚ Violin â€¢ Beginner          â”‚ â”‚
â”‚ â”‚ Last lesson: 5 days ago    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ ...                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€â”€ [+ Add Student]
    â”‚         â”‚
    â”‚         â–¼
    â”‚   [Add Student Form]
    â”‚   - First Name*
    â”‚   - Last Name*
    â”‚   - Parent Email*
    â”‚   - Instrument*
    â”‚   - Skill Level*
    â”‚   - Lesson Day
    â”‚   - Lesson Time
    â”‚   - Notes
    â”‚         â”‚
    â”‚         â””â”€â”€ [Save] â”€â”€â–º [Student Created]
    â”‚
    â””â”€â”€ [Tap Student]
              â”‚
              â–¼
        [Student Detail]
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ðŸŽ¹ Emma Wilson              â”‚
        â”‚ Piano â€¢ Intermediate        â”‚
        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚ Parent: Sarah Wilson        â”‚
        â”‚ Email: sarah@example.com    â”‚
        â”‚ Lessons: Wednesdays 4pm     â”‚
        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚ RECENT LESSONS              â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
        â”‚ â”‚ Jan 8 â€¢ 45 min         â”‚ â”‚
        â”‚ â”‚ Worked on Fur Elise    â”‚ â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
        â”‚ â”‚ Jan 1 â€¢ 40 min         â”‚ â”‚
        â”‚ â”‚ Scale exercises        â”‚ â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚ [Record Lesson] [Edit] [ðŸ—‘] â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Non-Functional Requirements

### 5.1 Performance

| Metric | Requirement | Priority |
|--------|-------------|----------|
| App Launch | < 2 seconds to interactive | P0 |
| Recording Start | < 500ms from tap | P0 |
| Audio Upload | < 30 seconds for 30min audio | P0 |
| Transcription | < 2x audio length | P0 |
| AI Generation | < 30 seconds for all outputs | P0 |
| Page Load (Web) | < 3 seconds | P1 |
| API Response | < 500ms for non-AI endpoints | P1 |

### 5.2 Reliability

| Metric | Requirement | Priority |
|--------|-------------|----------|
| Uptime | 99.5% monthly | P0 |
| Data Durability | No data loss on crash | P0 |
| Audio Backup | Local backup until cloud confirmed | P0 |
| Error Recovery | Graceful degradation with retry | P1 |
| Offline Support | Queue recordings when offline | P2 |

### 5.3 Security

| Requirement | Implementation | Priority |
|-------------|----------------|----------|
| Authentication | Clerk with JWT tokens | P0 |
| Data Encryption | TLS 1.3 in transit, AES-256 at rest | P0 |
| Audio Privacy | Audio files not shared between users | P0 |
| GDPR Compliance | Data export, deletion, consent | P1 |
| SOC 2 | Audit logging, access controls | P2 |

### 5.4 Scalability

| Metric | Initial Capacity | Growth Target |
|--------|-----------------|---------------|
| Concurrent Users | 100 | 10,000 |
| Audio Storage | 1TB | 100TB |
| Daily Transcriptions | 500 | 50,000 |
| Database Size | 10GB | 1TB |

### 5.5 Accessibility

| Standard | Requirement | Priority |
|----------|-------------|----------|
| WCAG 2.1 Level AA | Web application compliance | P1 |
| iOS Accessibility | VoiceOver support | P1 |
| Color Contrast | 4.5:1 minimum | P1 |
| Keyboard Navigation | Full web keyboard support | P2 |

---

## 6. Design Requirements

### 6.1 Brand Guidelines

**Color Palette:**
| Color | Hex | Usage |
|-------|-----|-------|
| Primary | #6366F1 | Buttons, links, accents |
| Primary Dark | #4F46E5 | Hover states |
| Secondary | #10B981 | Success, positive states |
| Warning | #F59E0B | Warnings, attention |
| Error | #EF4444 | Errors, destructive actions |
| Neutral 50 | #F9FAFB | Backgrounds |
| Neutral 100 | #F3F4F6 | Card backgrounds |
| Neutral 200 | #E5E7EB | Borders |
| Neutral 500 | #6B7280 | Secondary text |
| Neutral 900 | #111827 | Primary text |

**Typography:**
| Element | Font | Size | Weight |
|---------|------|------|--------|
| H1 | Inter | 36px | 700 |
| H2 | Inter | 28px | 600 |
| H3 | Inter | 22px | 600 |
| Body | Inter | 16px | 400 |
| Small | Inter | 14px | 400 |
| Caption | Inter | 12px | 400 |

**Spacing:**
- Base unit: 4px
- Component padding: 16px (4 units)
- Section spacing: 32px (8 units)
- Page margins: 24px (6 units)

### 6.2 UI Components

**Buttons:**
- Primary: Filled background, white text
- Secondary: Outlined, primary color
- Ghost: Text only, subtle hover
- Destructive: Red background for delete actions
- All buttons: 44px minimum touch target

**Cards:**
- Background: Neutral 100
- Border radius: 12px
- Shadow: sm (0 1px 2px rgba(0,0,0,0.05))
- Padding: 16px

**Forms:**
- Input height: 44px
- Border radius: 8px
- Focus ring: Primary color, 2px offset
- Error state: Red border, error message below

### 6.3 Motion & Feedback

| Action | Feedback |
|--------|----------|
| Button press | Scale to 0.98, 100ms |
| Page transition | Fade, 200ms |
| Loading | Skeleton screens |
| Success | Green checkmark animation |
| Error | Shake animation, 300ms |
| Recording | Pulse animation on indicator |

---

## 7. Technical Constraints

### 7.1 Platform Requirements

**iOS:**
- Minimum iOS version: 16.0
- Devices: iPhone (no iPad in MVP)
- Required capabilities: Microphone, Background audio

**Web:**
- Browsers: Chrome 90+, Safari 15+, Firefox 90+, Edge 90+
- Responsive breakpoints: 640px, 768px, 1024px, 1280px

### 7.2 API Constraints

**OpenAI Whisper:**
- Max file size: 25MB
- Supported formats: mp3, mp4, m4a, webm, wav
- Rate limits: Varies by tier

**OpenAI GPT-4:**
- Context window: 128K tokens
- Rate limits: Varies by tier
- Cost: ~$0.03/1K input tokens, $0.06/1K output tokens

### 7.3 Infrastructure Constraints

- Audio storage: S3/R2 with lifecycle policies
- Database: PostgreSQL 15+ required for JSON operations
- Redis: 7+ required for streams

---

## 8. Release Plan

### 8.1 MVP Scope (v1.0)

**Included:**
- iOS app with recording and output viewing
- Web dashboard with full functionality
- Audio recording and cloud upload
- AI transcription and content generation
- Basic student management
- User authentication

**Excluded:**
- Android app
- Email sending integration
- Advanced analytics
- Template customization
- Offline mode

### 8.2 Timeline

| Phase | Duration | Deliverables |
|-------|----------|--------------|
| Phase 1: Foundation | Week 1-2 | Auth, database, basic API, project setup |
| Phase 2: Core Features | Week 2-3 | Recording, transcription, AI generation |
| Phase 3: UI Polish | Week 3-4 | iOS app, web dashboard, UX refinement |
| Phase 4: Testing | Week 4 | Integration testing, bug fixes |
| Phase 5: Launch | Week 4+ | Deployment, monitoring, soft launch |

### 8.3 Success Criteria for Launch

- [ ] All P0 features functional
- [ ] 80% test coverage
- [ ] < 1% crash rate on iOS
- [ ] < 500ms API response times
- [ ] Successful processing of 30+ minute recordings
- [ ] 3 beta teachers validated outputs

---

## 9. Appendix

### 9.1 Glossary

| Term | Definition |
|------|------------|
| Lesson | A recorded teaching session |
| Practice Plan | AI-generated daily practice assignments |
| Student Recap | Summary of lesson highlights for the student |
| Parent Email | Communication template for parents |
| Transcript | Text version of recorded audio |
| Output | Any of the three generated documents |

### 9.2 References

- OpenAI Whisper API Documentation
- OpenAI GPT-4 API Documentation
- Clerk Authentication Documentation
- Apple Human Interface Guidelines
- WCAG 2.1 Guidelines

### 9.3 Change Log

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | Jan 2025 | Initial PRD for MVP |


# Product Requirements Document (PRD)

## Note By Note - AI Practice Plan Generator for Music Teachers

**Version:** 1.0.0-MVP  
**Last Updated:** January 2025  
**Status:** Ready for Development  

---

## 1. Executive Summary

### 1.1 Product Vision
Note By Note transforms music lesson recordings into actionable practice plans, student recaps, and parent communications using AI. The platform eliminates the 2-3 hours teachers spend daily on administrative tasks, allowing them to focus on what they do best: teaching.

### 1.2 Problem Statement
Private music teachers face a significant administrative burden:
- **Time sink**: Teachers with 20+ students spend 2-3 hours nightly writing practice plans and parent emails
- **Inconsistency**: Manual notes vary in quality based on energy and time available
- **Delayed communication**: Parents often receive updates days after lessons
- **No leverage**: The same type of content is written repeatedly with slight variations

### 1.3 Solution
An AI-powered mobile and web application that:
1. Records lesson audio with a single tap
2. Transcribes and analyzes the lesson using AI
3. Generates three outputs: Student Recap, Practice Plan, Parent Email
4. Allows quick editing before sending
5. Maintains a searchable history of all lessons and communications

### 1.4 Success Metrics
| Metric | Target | Measurement |
|--------|--------|-------------|
| Time Saved | 90% reduction in admin time | User surveys, time tracking |
| User Adoption | 500 paying users in 6 months | Subscription count |
| Output Quality | 85% sent without edits | Edit rate analytics |
| User Retention | 80% month-over-month | Subscription renewals |
| NPS Score | 50+ | Quarterly surveys |

---

## 2. User Personas

### 2.1 Primary Persona: Sarah the Solo Teacher

**Demographics:**
- Age: 35-55
- Location: Suburban USA
- Income: $40,000-80,000/year from teaching
- Technical proficiency: Moderate (comfortable with smartphones, basic apps)

**Profile:**
Sarah is a piano teacher with 25 weekly students ranging from beginners to advanced. She teaches from her home studio. After lessons end at 6pm, she spends 2-3 hours writing practice plans and parent emails. She's exhausted by this routine but knows consistent communication is essential for student progress and parent satisfaction.

**Goals:**
- Reduce administrative time without sacrificing quality
- Send professional communications to parents
- Track student progress over time
- Maintain work-life balance

**Pain Points:**
- Spends more time writing than teaching
- Forgets lesson details when writing later
- Inconsistent quality of notes when tired
- No searchable history of past lessons

**Quote:** "I love teaching, but the paperwork is killing me."

### 2.2 Secondary Persona: Michael the Studio Owner

**Demographics:**
- Age: 40-60
- Location: Urban/Suburban USA
- Income: $100,000-200,000/year from studio
- Technical proficiency: High (uses studio management software)

**Profile:**
Michael owns a music studio with 5 teachers and 150 students. He needs consistent communication standards across all teachers. Currently, each teacher handles their own communications with varying quality. He wants a unified system that maintains his studio's professional image.

**Goals:**
- Standardize communications across all teachers
- Monitor teacher-parent communications
- Ensure consistent student experience
- Scale the studio without administrative overhead

**Pain Points:**
- Inconsistent communication quality between teachers
- No visibility into lesson content
- Difficulty maintaining standards at scale
- High teacher turnover due to admin burden

---

## 3. Feature Requirements

### 3.1 Feature Priority Matrix

| Priority | Feature | User Value | Technical Complexity |
|----------|---------|------------|---------------------|
| P0 | Audio Recording | Critical | Low |
| P0 | AI Transcription | Critical | Medium |
| P0 | Practice Plan Generation | Critical | High |
| P0 | Student Recap Generation | Critical | High |
| P0 | Parent Email Generation | Critical | High |
| P0 | Output Editing | Critical | Low |
| P1 | Student Management | High | Medium |
| P1 | User Authentication | Critical | Low |
| P1 | Web Dashboard | High | Medium |
| P2 | Lesson History | Medium | Low |
| P2 | Template Customization | Medium | Medium |
| P2 | Progress Tracking | Medium | High |
| P3 | Email Integration | Low | Medium |
| P3 | Analytics Dashboard | Low | High |

### 3.2 Core Features (P0 - MVP Required)

#### 3.2.1 Audio Recording

**Description:** One-tap lesson recording with background-capable audio capture.

**Functional Requirements:**
| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| REC-001 | Single tap to start recording | Recording starts within 500ms of button press |
| REC-002 | Visual recording indicator | Pulsing red dot visible at all times during recording |
| REC-003 | Recording timer display | Shows elapsed time in MM:SS format |
| REC-004 | Background recording support | Recording continues when app is backgrounded |
| REC-005 | Pause/Resume functionality | User can pause and resume without creating new files |
| REC-006 | Auto-save on interruption | Recording saved if call received or app crashes |
| REC-007 | Audio quality settings | Minimum 16kHz sample rate, mono, AAC codec |
| REC-008 | Maximum recording length | Support recordings up to 90 minutes |
| REC-009 | Storage indication | Show estimated storage remaining |
| REC-010 | Stop and process action | Single action to stop recording and initiate processing |

**Technical Specifications:**
- Audio format: AAC, 64kbps, mono, 16kHz minimum
- Maximum file size: ~100MB (90 minutes)
- Local storage with background upload
- Waveform visualization during recording

#### 3.2.2 AI Transcription

**Description:** Convert recorded audio to text using OpenAI Whisper API.

**Functional Requirements:**
| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| TRX-001 | Automatic transcription | Transcription begins automatically after recording stops |
| TRX-002 | Processing indicator | Show progress bar with estimated time remaining |
| TRX-003 | Speaker diarization | Distinguish between teacher and student speech |
| TRX-004 | Music terminology accuracy | 95%+ accuracy on common music terms |
| TRX-005 | Timestamp alignment | Transcript segments aligned to audio timestamps |
| TRX-006 | Error handling | Clear error messages with retry option |
| TRX-007 | Transcript viewing | Full transcript viewable after processing |
| TRX-008 | Processing time | Complete within 2x audio length |

**Technical Specifications:**
- API: OpenAI Whisper API (whisper-1)
- Chunking: Split audio into 25MB chunks if needed
- Language: English (expandable to other languages)
- Response format: Verbose JSON with timestamps

#### 3.2.3 AI Content Generation

**Description:** Generate three outputs from the transcription using LLM.

**Functional Requirements:**
| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| GEN-001 | Generate Student Recap | 150-300 word summary of lesson highlights |
| GEN-002 | Generate Practice Plan | Daily breakdown for 7 days with specific exercises |
| GEN-003 | Generate Parent Email | Professional email ready to send |
| GEN-004 | Music-domain accuracy | Correctly identify techniques, pieces, and terminology |
| GEN-005 | Personalization | Include student name and specific details |
| GEN-006 | Tone consistency | Maintain encouraging, professional tone |
| GEN-007 | Actionable items | Practice plan items are specific and measurable |
| GEN-008 | Generation time | All three outputs generated within 30 seconds |

**Output Specifications:**

**Student Recap:**
```
Structure:
- Greeting with student name
- What went well (2-3 bullet points)
- Areas to focus on (2-3 bullet points)  
- Encouragement for next lesson

Length: 150-300 words
Tone: Positive, specific, actionable
```

**Practice Plan:**
```
Structure:
- Duration per day (e.g., 30 minutes)
- Day 1-7 breakdown with:
  - Specific exercise/piece
  - Time allocation
  - Focus area
  - Tips for execution

Length: 300-500 words
Format: Structured daily list
```

**Parent Email:**
```
Structure:
- Professional greeting
- Lesson summary (1 paragraph)
- Key achievements (brief)
- Practice plan overview
- Next lesson focus
- Professional closing

Length: 200-400 words
Tone: Professional, warm, informative
```

#### 3.2.4 Output Editing

**Description:** Allow teachers to review and edit generated content before sending.

**Functional Requirements:**
| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| EDT-001 | Inline text editing | Click any text to edit directly |
| EDT-002 | Regenerate section | Button to regenerate specific output |
| EDT-003 | Undo/Redo support | Unlimited undo/redo within session |
| EDT-004 | Auto-save drafts | Changes saved automatically every 5 seconds |
| EDT-005 | Preview mode | View formatted output as recipient will see it |
| EDT-006 | Copy to clipboard | One-click copy for any output |
| EDT-007 | Mark as final | Explicit action to finalize outputs |
| EDT-008 | Edit history | Track changes made to generated content |

#### 3.2.5 User Authentication

**Description:** Secure user registration and login.

**Functional Requirements:**
| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| AUTH-001 | Email/password registration | Standard registration flow |
| AUTH-002 | Social login (Google) | One-click Google sign-in |
| AUTH-003 | Social login (Apple) | One-click Apple sign-in (required for iOS) |
| AUTH-004 | Password reset | Email-based password reset flow |
| AUTH-005 | Session management | Persistent sessions with secure token refresh |
| AUTH-006 | Account settings | Update email, password, profile information |
| AUTH-007 | Account deletion | GDPR-compliant account deletion |
| AUTH-008 | iOS/Web sync | Same account works across platforms |

### 3.3 Essential Features (P1 - MVP Included)

#### 3.3.1 Student Management

**Description:** Manage student profiles and associate lessons.

**Functional Requirements:**
| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| STU-001 | Create student profile | Name, instrument, skill level, parent info |
| STU-002 | Edit student profile | Update any field at any time |
| STU-003 | Delete student | Soft delete with data retention option |
| STU-004 | Student list view | Sortable, searchable list of all students |
| STU-005 | Associate lesson | Link recording to specific student |
| STU-006 | Parent contact info | Store parent email for communications |
| STU-007 | Lesson history per student | View all past lessons for a student |
| STU-008 | Import students | CSV upload for bulk import |

**Student Profile Fields:**
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| id | UUID | Yes | System generated |
| firstName | String | Yes | Student first name |
| lastName | String | Yes | Student last name |
| email | String | No | Student email (if applicable) |
| parentFirstName | String | No | Parent/guardian first name |
| parentLastName | String | No | Parent/guardian last name |
| parentEmail | String | Yes | Parent email for communications |
| instrument | Enum | Yes | Piano, Violin, Guitar, Voice, Other |
| skillLevel | Enum | Yes | Beginner, Intermediate, Advanced |
| lessonDay | Enum | No | Typical lesson day |
| lessonTime | Time | No | Typical lesson time |
| notes | Text | No | Private teacher notes |
| createdAt | DateTime | Yes | System generated |
| updatedAt | DateTime | Yes | System generated |

#### 3.3.2 Web Dashboard

**Description:** Full-featured web application for managing lessons and students.

**Functional Requirements:**
| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| WEB-001 | Responsive design | Works on desktop, tablet, mobile |
| WEB-002 | Dashboard home | Overview of recent lessons, pending tasks |
| WEB-003 | Student list page | Full CRUD for students |
| WEB-004 | Lesson list page | View all lessons with filters |
| WEB-005 | Lesson detail page | View transcript, outputs, audio player |
| WEB-006 | Settings page | Account, preferences, templates |
| WEB-007 | Upload audio | Web-based audio upload option |
| WEB-008 | Real-time updates | WebSocket for processing status |

### 3.4 Enhanced Features (P2 - Post-MVP)

#### 3.4.1 Lesson History & Search

**Functional Requirements:**
| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| HIS-001 | Full-text search | Search across all transcripts |
| HIS-002 | Filter by student | View lessons for specific student |
| HIS-003 | Filter by date range | View lessons within date range |
| HIS-004 | Sort options | Sort by date, student, duration |
| HIS-005 | Export history | Download lesson history as PDF/CSV |

#### 3.4.2 Template Customization

**Functional Requirements:**
| ID | Requirement | Acceptance Criteria |
|----|-------------|---------------------|
| TPL-001 | Custom practice plan template | Define structure and prompts |
| TPL-002 | Custom email template | Define greeting, closing, tone |
| TPL-003 | Template preview | Preview with sample data |
| TPL-004 | Template library | Save multiple templates |
| TPL-005 | Per-student template | Assign templates to students |

### 3.5 Future Features (P3 - Backlog)

- Email integration (send directly from app)
- Calendar integration (sync with Google Calendar, Apple Calendar)
- Analytics dashboard (student progress over time)
- Multi-language support
- Voice commands during lessons
- Integration with music notation software
- Parent portal for viewing updates

---

## 4. User Flows

### 4.1 Core Flow: Record and Generate

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        RECORD AND GENERATE FLOW                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[Open App] 
    â”‚
    â–¼
[Dashboard/Home Screen]
    â”‚
    â”œâ”€â”€ [New Recording] â—„â”€â”€ Primary CTA
    â”‚         â”‚
    â”‚         â–¼
    â”‚   [Select Student] â—„â”€â”€ Required before recording
    â”‚         â”‚
    â”‚         â”œâ”€â”€ [Existing Student] 
    â”‚         â”‚         â”‚
    â”‚         â”‚         â–¼
    â”‚         â”‚   [Student Selected]
    â”‚         â”‚
    â”‚         â””â”€â”€ [+ Add New Student]
    â”‚                   â”‚
    â”‚                   â–¼
    â”‚             [Quick Add Form]
    â”‚                   â”‚
    â”‚                   â–¼
    â”‚             [Student Created & Selected]
    â”‚                   â”‚
    â”‚         â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚         â”‚
    â”‚         â–¼
    â”‚   [Recording Screen]
    â”‚         â”‚
    â”‚         â”œâ”€â”€ [â— Record Button] â—„â”€â”€ Tap to start
    â”‚         â”‚         â”‚
    â”‚         â”‚         â–¼
    â”‚         â”‚   [Recording Active]
    â”‚         â”‚   - Timer running
    â”‚         â”‚   - Waveform display
    â”‚         â”‚   - Pause button available
    â”‚         â”‚         â”‚
    â”‚         â”‚         â”œâ”€â”€ [â¸ Pause]
    â”‚         â”‚         â”‚      â”‚
    â”‚         â”‚         â”‚      â–¼
    â”‚         â”‚         â”‚   [Paused State]
    â”‚         â”‚         â”‚      â”‚
    â”‚         â”‚         â”‚      â””â”€â”€ [â–¶ Resume] â”€â”€â”€â”
    â”‚         â”‚         â”‚                        â”‚
    â”‚         â”‚         â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚         â”‚         â”‚
    â”‚         â”‚         â””â”€â”€ [â–  Stop & Process]
    â”‚         â”‚                   â”‚
    â”‚         â”‚                   â–¼
    â”‚         â”‚             [Upload & Process]
    â”‚         â”‚             - Progress: Uploading...
    â”‚         â”‚             - Progress: Transcribing...
    â”‚         â”‚             - Progress: Generating...
    â”‚         â”‚                   â”‚
    â”‚         â”‚                   â–¼
    â”‚         â”‚             [Results Screen]
    â”‚         â”‚             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚             â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚         â”‚             â”‚ â”‚ STUDENT RECAP   â”‚ â”‚
    â”‚         â”‚             â”‚ â”‚ [Edit] [Regen]  â”‚ â”‚
    â”‚         â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚         â”‚             â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚         â”‚             â”‚ â”‚ PRACTICE PLAN   â”‚ â”‚
    â”‚         â”‚             â”‚ â”‚ [Edit] [Regen]  â”‚ â”‚
    â”‚         â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚         â”‚             â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚         â”‚             â”‚ â”‚ PARENT EMAIL    â”‚ â”‚
    â”‚         â”‚             â”‚ â”‚ [Edit] [Regen]  â”‚ â”‚
    â”‚         â”‚             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚         â”‚             â”‚                     â”‚
    â”‚         â”‚             â”‚ [Copy All] [Done]   â”‚
    â”‚         â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚         â”‚                   â”‚
    â”‚         â”‚                   â”œâ”€â”€ [Edit Any Section]
    â”‚         â”‚                   â”‚         â”‚
    â”‚         â”‚                   â”‚         â–¼
    â”‚         â”‚                   â”‚   [Inline Editor]
    â”‚         â”‚                   â”‚         â”‚
    â”‚         â”‚                   â”‚         â””â”€â”€ [Save Changes]
    â”‚         â”‚                   â”‚                   â”‚
    â”‚         â”‚                   â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚         â”‚                   â”‚
    â”‚         â”‚                   â””â”€â”€ [Done / Save]
    â”‚         â”‚                             â”‚
    â”‚         â”‚                             â–¼
    â”‚         â”‚                       [Lesson Saved]
    â”‚         â”‚                             â”‚
    â”‚         â”‚                             â–¼
    â”‚         â”‚                       [Return to Dashboard]
    â”‚         â”‚
    â”‚         â””â”€â”€ [Cancel]
    â”‚                   â”‚
    â”‚                   â–¼
    â”‚             [Confirm Discard?]
    â”‚                   â”‚
    â”‚                   â”œâ”€â”€ [Yes] â”€â”€â–º [Dashboard]
    â”‚                   â””â”€â”€ [No] â”€â”€â–º [Recording Screen]
    â”‚
    â””â”€â”€ [View Students] / [View Lessons] / [Settings]
              â”‚
              â–¼
        [Respective Screens]
```

### 4.2 Onboarding Flow

```
[First Launch]
    â”‚
    â–¼
[Welcome Screen]
"Welcome to Note By Note"
"Transform lessons into practice plans in seconds"
    â”‚
    â–¼
[Sign Up / Sign In]
    â”‚
    â”œâ”€â”€ [Sign Up with Email]
    â”‚         â”‚
    â”‚         â–¼
    â”‚   [Email + Password Form]
    â”‚         â”‚
    â”‚         â–¼
    â”‚   [Verify Email]
    â”‚
    â”œâ”€â”€ [Sign In with Google]
    â”‚         â”‚
    â”‚         â–¼
    â”‚   [OAuth Flow]
    â”‚
    â””â”€â”€ [Sign In with Apple]
              â”‚
              â–¼
        [OAuth Flow]
              â”‚
              â–¼
[Profile Setup]
- Name
- Studio/School Name (optional)
- Primary Instrument(s)
- Typical Students per Week
    â”‚
    â–¼
[Add First Student]
"Let's add your first student"
- Name
- Parent Email
- Instrument
- Skill Level
    â”‚
    â–¼
[Microphone Permission]
"Note By Note needs microphone access to record lessons"
[Allow] [Skip for Now]
    â”‚
    â–¼
[Ready to Go!]
"Record your first lesson"
[Start Recording] â”€â”€â–º [Recording Screen]
```

### 4.3 Student Management Flow

```
[Students Tab]
    â”‚
    â–¼
[Student List]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Search...        ] [+ Add]    â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ðŸŽ¹ Emma Wilson              â”‚ â”‚
â”‚ â”‚ Piano â€¢ Intermediate        â”‚ â”‚
â”‚ â”‚ Last lesson: 2 days ago    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ðŸŽ» James Chen               â”‚ â”‚
â”‚ â”‚ Violin â€¢ Beginner          â”‚ â”‚
â”‚ â”‚ Last lesson: 5 days ago    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ ...                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€â”€ [+ Add Student]
    â”‚         â”‚
    â”‚         â–¼
    â”‚   [Add Student Form]
    â”‚   - First Name*
    â”‚   - Last Name*
    â”‚   - Parent Email*
    â”‚   - Instrument*
    â”‚   - Skill Level*
    â”‚   - Lesson Day
    â”‚   - Lesson Time
    â”‚   - Notes
    â”‚         â”‚
    â”‚         â””â”€â”€ [Save] â”€â”€â–º [Student Created]
    â”‚
    â””â”€â”€ [Tap Student]
              â”‚
              â–¼
        [Student Detail]
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ðŸŽ¹ Emma Wilson              â”‚
        â”‚ Piano â€¢ Intermediate        â”‚
        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚ Parent: Sarah Wilson        â”‚
        â”‚ Email: sarah@example.com    â”‚
        â”‚ Lessons: Wednesdays 4pm     â”‚
        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚ RECENT LESSONS              â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
        â”‚ â”‚ Jan 8 â€¢ 45 min         â”‚ â”‚
        â”‚ â”‚ Worked on Fur Elise    â”‚ â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
        â”‚ â”‚ Jan 1 â€¢ 40 min         â”‚ â”‚
        â”‚ â”‚ Scale exercises        â”‚ â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚ [Record Lesson] [Edit] [ðŸ—‘] â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Non-Functional Requirements

### 5.1 Performance

| Metric | Requirement | Priority |
|--------|-------------|----------|
| App Launch | < 2 seconds to interactive | P0 |
| Recording Start | < 500ms from tap | P0 |
| Audio Upload | < 30 seconds for 30min audio | P0 |
| Transcription | < 2x audio length | P0 |
| AI Generation | < 30 seconds for all outputs | P0 |
| Page Load (Web) | < 3 seconds | P1 |
| API Response | < 500ms for non-AI endpoints | P1 |

### 5.2 Reliability

| Metric | Requirement | Priority |
|--------|-------------|----------|
| Uptime | 99.5% monthly | P0 |
| Data Durability | No data loss on crash | P0 |
| Audio Backup | Local backup until cloud confirmed | P0 |
| Error Recovery | Graceful degradation with retry | P1 |
| Offline Support | Queue recordings when offline | P2 |

### 5.3 Security

| Requirement | Implementation | Priority |
|-------------|----------------|----------|
| Authentication | Clerk with JWT tokens | P0 |
| Data Encryption | TLS 1.3 in transit, AES-256 at rest | P0 |
| Audio Privacy | Audio files not shared between users | P0 |
| GDPR Compliance | Data export, deletion, consent | P1 |
| SOC 2 | Audit logging, access controls | P2 |

### 5.4 Scalability

| Metric | Initial Capacity | Growth Target |
|--------|-----------------|---------------|
| Concurrent Users | 100 | 10,000 |
| Audio Storage | 1TB | 100TB |
| Daily Transcriptions | 500 | 50,000 |
| Database Size | 10GB | 1TB |

### 5.5 Accessibility

| Standard | Requirement | Priority |
|----------|-------------|----------|
| WCAG 2.1 Level AA | Web application compliance | P1 |
| iOS Accessibility | VoiceOver support | P1 |
| Color Contrast | 4.5:1 minimum | P1 |
| Keyboard Navigation | Full web keyboard support | P2 |

---

## 6. Design Requirements

### 6.1 Brand Guidelines

**Color Palette:**
| Color | Hex | Usage |
|-------|-----|-------|
| Primary | #6366F1 | Buttons, links, accents |
| Primary Dark | #4F46E5 | Hover states |
| Secondary | #10B981 | Success, positive states |
| Warning | #F59E0B | Warnings, attention |
| Error | #EF4444 | Errors, destructive actions |
| Neutral 50 | #F9FAFB | Backgrounds |
| Neutral 100 | #F3F4F6 | Card backgrounds |
| Neutral 200 | #E5E7EB | Borders |
| Neutral 500 | #6B7280 | Secondary text |
| Neutral 900 | #111827 | Primary text |

**Typography:**
| Element | Font | Size | Weight |
|---------|------|------|--------|
| H1 | Inter | 36px | 700 |
| H2 | Inter | 28px | 600 |
| H3 | Inter | 22px | 600 |
| Body | Inter | 16px | 400 |
| Small | Inter | 14px | 400 |
| Caption | Inter | 12px | 400 |

**Spacing:**
- Base unit: 4px
- Component padding: 16px (4 units)
- Section spacing: 32px (8 units)
- Page margins: 24px (6 units)

### 6.2 UI Components

**Buttons:**
- Primary: Filled background, white text
- Secondary: Outlined, primary color
- Ghost: Text only, subtle hover
- Destructive: Red background for delete actions
- All buttons: 44px minimum touch target

**Cards:**
- Background: Neutral 100
- Border radius: 12px
- Shadow: sm (0 1px 2px rgba(0,0,0,0.05))
- Padding: 16px

**Forms:**
- Input height: 44px
- Border radius: 8px
- Focus ring: Primary color, 2px offset
- Error state: Red border, error message below

### 6.3 Motion & Feedback

| Action | Feedback |
|--------|----------|
| Button press | Scale to 0.98, 100ms |
| Page transition | Fade, 200ms |
| Loading | Skeleton screens |
| Success | Green checkmark animation |
| Error | Shake animation, 300ms |
| Recording | Pulse animation on indicator |

---

## 7. Technical Constraints

### 7.1 Platform Requirements

**iOS:**
- Minimum iOS version: 16.0
- Devices: iPhone (no iPad in MVP)
- Required capabilities: Microphone, Background audio

**Web:**
- Browsers: Chrome 90+, Safari 15+, Firefox 90+, Edge 90+
- Responsive breakpoints: 640px, 768px, 1024px, 1280px

### 7.2 API Constraints

**OpenAI Whisper:**
- Max file size: 25MB
- Supported formats: mp3, mp4, m4a, webm, wav
- Rate limits: Varies by tier

**OpenAI GPT-4:**
- Context window: 128K tokens
- Rate limits: Varies by tier
- Cost: ~$0.03/1K input tokens, $0.06/1K output tokens

### 7.3 Infrastructure Constraints

- Audio storage: S3/R2 with lifecycle policies
- Database: PostgreSQL 15+ required for JSON operations
- Redis: 7+ required for streams

---

## 8. Release Plan

### 8.1 MVP Scope (v1.0)

**Included:**
- iOS app with recording and output viewing
- Web dashboard with full functionality
- Audio recording and cloud upload
- AI transcription and content generation
- Basic student management
- User authentication

**Excluded:**
- Android app
- Email sending integration
- Advanced analytics
- Template customization
- Offline mode

### 8.2 Timeline

| Phase | Duration | Deliverables |
|-------|----------|--------------|
| Phase 1: Foundation | Week 1-2 | Auth, database, basic API, project setup |
| Phase 2: Core Features | Week 2-3 | Recording, transcription, AI generation |
| Phase 3: UI Polish | Week 3-4 | iOS app, web dashboard, UX refinement |
| Phase 4: Testing | Week 4 | Integration testing, bug fixes |
| Phase 5: Launch | Week 4+ | Deployment, monitoring, soft launch |

### 8.3 Success Criteria for Launch

- [ ] All P0 features functional
- [ ] 80% test coverage
- [ ] < 1% crash rate on iOS
- [ ] < 500ms API response times
- [ ] Successful processing of 30+ minute recordings
- [ ] 3 beta teachers validated outputs

---

## 9. Appendix

### 9.1 Glossary

| Term | Definition |
|------|------------|
| Lesson | A recorded teaching session |
| Practice Plan | AI-generated daily practice assignments |
| Student Recap | Summary of lesson highlights for the student |
| Parent Email | Communication template for parents |
| Transcript | Text version of recorded audio |
| Output | Any of the three generated documents |

### 9.2 References

- OpenAI Whisper API Documentation
- OpenAI GPT-4 API Documentation
- Clerk Authentication Documentation
- Apple Human Interface Guidelines
- WCAG 2.1 Guidelines

### 9.3 Change Log

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | Jan 2025 | Initial PRD for MVP |


# API Design Specification

## Note By Note - REST API Documentation

**Version:** 1.0.0-MVP  
**Base URL:** `https://api.notebynote.com/v1`  
**Authentication:** Bearer Token (Clerk JWT)  

---

## 1. Overview

### 1.1 Base Configuration

```
Base URL: /api/v1
Content-Type: application/json
Authentication: Bearer {clerk_jwt_token}
```

### 1.2 Common Headers

| Header | Required | Description |
|--------|----------|-------------|
| `Authorization` | Yes | Bearer token from Clerk |
| `Content-Type` | Yes | application/json |
| `X-Request-ID` | No | Client-generated UUID for tracing |
| `Accept-Language` | No | Preferred language (default: en) |

### 1.3 Standard Response Format

**Success (2xx):**
```json
{
  "success": true,
  "data": { },
  "meta": {
    "requestId": "req_abc123xyz",
    "timestamp": "2025-01-15T10:30:00.000Z"
  }
}
```

**Success with Pagination:**
```json
{
  "success": true,
  "data": [ ],
  "pagination": {
    "total": 100,
    "page": 1,
    "pageSize": 20,
    "hasMore": true,
    "nextCursor": "cursor_xyz"
  },
  "meta": {
    "requestId": "req_abc123xyz",
    "timestamp": "2025-01-15T10:30:00.000Z"
  }
}
```

**Error (4xx/5xx):**
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "Human readable message",
    "details": [
      {
        "field": "fieldName",
        "message": "Field-specific error"
      }
    ]
  },
  "meta": {
    "requestId": "req_abc123xyz",
    "timestamp": "2025-01-15T10:30:00.000Z"
  }
}
```

---

## 2. Authentication Endpoints

### 2.1 Webhook - Clerk User Sync

Webhook endpoint for Clerk to sync user data.

```http
POST /webhooks/clerk
```

**Headers:**
```
svix-id: {webhook_id}
svix-timestamp: {timestamp}
svix-signature: {signature}
```

**Request Body (user.created):**
```json
{
  "type": "user.created",
  "data": {
    "id": "user_abc123",
    "email_addresses": [
      {
        "email_address": "sarah@example.com",
        "id": "email_123",
        "verification": { "status": "verified" }
      }
    ],
    "first_name": "Sarah",
    "last_name": "Johnson",
    "created_at": 1705312200000
  }
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "received": true
  }
}
```

---

## 3. User Endpoints

### 3.1 Get Current User

```http
GET /users/me
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "cuid_abc123",
    "email": "sarah@example.com",
    "firstName": "Sarah",
    "lastName": "Johnson",
    "studioName": "Sarah's Piano Studio",
    "plan": "SOLO",
    "usage": {
      "lessonsThisMonth": 15,
      "lessonsLimit": 50,
      "resetDate": "2025-02-01T00:00:00.000Z"
    },
    "createdAt": "2025-01-01T00:00:00.000Z"
  }
}
```

### 3.2 Update Current User

```http
PATCH /users/me
```

**Request Body:**
```json
{
  "firstName": "Sarah",
  "lastName": "Johnson",
  "studioName": "Johnson Music Academy"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "cuid_abc123",
    "email": "sarah@example.com",
    "firstName": "Sarah",
    "lastName": "Johnson",
    "studioName": "Johnson Music Academy",
    "plan": "SOLO",
    "createdAt": "2025-01-01T00:00:00.000Z",
    "updatedAt": "2025-01-15T10:30:00.000Z"
  }
}
```

### 3.3 Delete Current User

```http
DELETE /users/me
```

**Request Body:**
```json
{
  "confirmation": "DELETE MY ACCOUNT"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "deleted": true,
    "message": "Account scheduled for deletion"
  }
}
```

---

## 4. Student Endpoints

### 4.1 List Students

```http
GET /students
```

**Query Parameters:**
| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `page` | integer | 1 | Page number |
| `pageSize` | integer | 20 | Items per page (max 100) |
| `search` | string | - | Search by name |
| `instrument` | string | - | Filter by instrument |
| `sortBy` | string | createdAt | Sort field |
| `sortOrder` | string | desc | asc or desc |

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "id": "stu_abc123",
      "firstName": "Emma",
      "lastName": "Wilson",
      "parentEmail": "parent@example.com",
      "instrument": "PIANO",
      "skillLevel": "INTERMEDIATE",
      "lessonDay": "WEDNESDAY",
      "lessonTime": "16:00",
      "lessonCount": 12,
      "lastLessonAt": "2025-01-13T16:00:00.000Z",
      "createdAt": "2024-09-01T00:00:00.000Z"
    }
  ],
  "pagination": {
    "total": 25,
    "page": 1,
    "pageSize": 20,
    "hasMore": true
  }
}
```

### 4.2 Create Student

```http
POST /students
```

**Request Body:**
```json
{
  "firstName": "Emma",
  "lastName": "Wilson",
  "email": "emma@example.com",
  "parentFirstName": "Sarah",
  "parentLastName": "Wilson",
  "parentEmail": "sarah.wilson@example.com",
  "instrument": "PIANO",
  "skillLevel": "INTERMEDIATE",
  "lessonDay": "WEDNESDAY",
  "lessonTime": "16:00",
  "notes": "Working on ABRSM Grade 5"
}
```

**Validation Rules:**
| Field | Rules |
|-------|-------|
| firstName | Required, 1-50 chars |
| lastName | Required, 1-50 chars |
| email | Optional, valid email |
| parentEmail | Required, valid email |
| instrument | Required, enum value |
| skillLevel | Required, enum value |
| lessonDay | Optional, enum value |
| lessonTime | Optional, HH:MM format |
| notes | Optional, max 2000 chars |

**Response (201 Created):**
```json
{
  "success": true,
  "data": {
    "id": "stu_xyz789",
    "firstName": "Emma",
    "lastName": "Wilson",
    "email": "emma@example.com",
    "parentFirstName": "Sarah",
    "parentLastName": "Wilson",
    "parentEmail": "sarah.wilson@example.com",
    "instrument": "PIANO",
    "skillLevel": "INTERMEDIATE",
    "lessonDay": "WEDNESDAY",
    "lessonTime": "16:00",
    "notes": "Working on ABRSM Grade 5",
    "createdAt": "2025-01-15T10:30:00.000Z"
  }
}
```

### 4.3 Get Student

```http
GET /students/:id
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "stu_abc123",
    "firstName": "Emma",
    "lastName": "Wilson",
    "email": "emma@example.com",
    "parentFirstName": "Sarah",
    "parentLastName": "Wilson",
    "parentEmail": "sarah.wilson@example.com",
    "instrument": "PIANO",
    "skillLevel": "INTERMEDIATE",
    "lessonDay": "WEDNESDAY",
    "lessonTime": "16:00",
    "notes": "Working on ABRSM Grade 5",
    "stats": {
      "totalLessons": 12,
      "totalPracticeMinutes": 360,
      "lastLessonAt": "2025-01-13T16:00:00.000Z"
    },
    "recentLessons": [
      {
        "id": "les_abc123",
        "createdAt": "2025-01-13T16:00:00.000Z",
        "audioLength": 2700,
        "status": "COMPLETED"
      }
    ],
    "createdAt": "2024-09-01T00:00:00.000Z",
    "updatedAt": "2025-01-15T10:30:00.000Z"
  }
}
```

### 4.4 Update Student

```http
PATCH /students/:id
```

**Request Body:**
```json
{
  "skillLevel": "ADVANCED",
  "notes": "Now working on ABRSM Grade 6"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "stu_abc123",
    "firstName": "Emma",
    "lastName": "Wilson",
    "skillLevel": "ADVANCED",
    "notes": "Now working on ABRSM Grade 6",
    "updatedAt": "2025-01-15T10:30:00.000Z"
  }
}
```

### 4.5 Delete Student

```http
DELETE /students/:id
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "stu_abc123",
    "deleted": true
  }
}
```

### 4.6 Import Students (Bulk)

```http
POST /students/import
```

**Request Body:**
```json
{
  "students": [
    {
      "firstName": "Emma",
      "lastName": "Wilson",
      "parentEmail": "sarah@example.com",
      "instrument": "PIANO",
      "skillLevel": "INTERMEDIATE"
    },
    {
      "firstName": "James",
      "lastName": "Chen",
      "parentEmail": "chen@example.com",
      "instrument": "VIOLIN",
      "skillLevel": "BEGINNER"
    }
  ]
}
```

**Response (201 Created):**
```json
{
  "success": true,
  "data": {
    "imported": 2,
    "failed": 0,
    "students": [
      { "id": "stu_abc123", "name": "Emma Wilson" },
      { "id": "stu_xyz789", "name": "James Chen" }
    ]
  }
}
```

---

## 5. Lesson Endpoints

### 5.1 List Lessons

```http
GET /lessons
```

**Query Parameters:**
| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `page` | integer | 1 | Page number |
| `pageSize` | integer | 20 | Items per page |
| `studentId` | string | - | Filter by student |
| `status` | string | - | Filter by status |
| `from` | ISO date | - | Start date filter |
| `to` | ISO date | - | End date filter |

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "id": "les_abc123",
      "student": {
        "id": "stu_abc123",
        "firstName": "Emma",
        "lastName": "Wilson",
        "instrument": "PIANO"
      },
      "audioLength": 2700,
      "status": "COMPLETED",
      "hasTranscript": true,
      "outputCount": 3,
      "createdAt": "2025-01-13T16:00:00.000Z"
    }
  ],
  "pagination": {
    "total": 150,
    "page": 1,
    "pageSize": 20,
    "hasMore": true
  }
}
```

### 5.2 Create Lesson (Initiate Recording)

```http
POST /lessons
```

**Request Body:**
```json
{
  "studentId": "stu_abc123"
}
```

**Response (201 Created):**
```json
{
  "success": true,
  "data": {
    "id": "les_xyz789",
    "studentId": "stu_abc123",
    "status": "RECORDING",
    "upload": {
      "uploadId": "upload_abc123",
      "key": "audio/user_123/les_xyz789/original.m4a",
      "presignedUrl": "https://s3.amazonaws.com/...",
      "expiresAt": "2025-01-15T11:30:00.000Z"
    },
    "createdAt": "2025-01-15T10:30:00.000Z"
  }
}
```

### 5.3 Get Lesson

```http
GET /lessons/:id
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "les_abc123",
    "student": {
      "id": "stu_abc123",
      "firstName": "Emma",
      "lastName": "Wilson",
      "instrument": "PIANO",
      "skillLevel": "INTERMEDIATE"
    },
    "audioUrl": "https://cdn.notebynote.com/audio/...",
    "audioLength": 2700,
    "status": "COMPLETED",
    "transcript": {
      "id": "trx_abc123",
      "fullText": "Okay Emma, let's start with your scales...",
      "wordCount": 1250,
      "segments": [
        {
          "start": 0.0,
          "end": 5.2,
          "text": "Okay Emma, let's start with your scales.",
          "speaker": "teacher"
        }
      ]
    },
    "outputs": [
      {
        "id": "out_abc123",
        "type": "STUDENT_RECAP",
        "content": "Great lesson today, Emma!...",
        "editedContent": null,
        "createdAt": "2025-01-13T16:45:00.000Z"
      },
      {
        "id": "out_xyz789",
        "type": "PRACTICE_PLAN",
        "content": "## Week of January 13th...",
        "editedContent": null,
        "createdAt": "2025-01-13T16:45:00.000Z"
      },
      {
        "id": "out_def456",
        "type": "PARENT_EMAIL",
        "content": "Dear Sarah,\n\nEmma had a wonderful lesson...",
        "editedContent": null,
        "createdAt": "2025-01-13T16:45:00.000Z"
      }
    ],
    "processedAt": "2025-01-13T16:45:00.000Z",
    "createdAt": "2025-01-13T16:00:00.000Z"
  }
}
```

### 5.4 Upload Audio Complete

Called after audio upload to S3 is complete.

```http
POST /lessons/:id/upload-complete
```

**Request Body:**
```json
{
  "uploadId": "upload_abc123",
  "parts": [
    { "ETag": "\"abc123\"", "PartNumber": 1 },
    { "ETag": "\"def456\"", "PartNumber": 2 }
  ],
  "audioLength": 2700,
  "audioSize": 45000000
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "les_abc123",
    "status": "TRANSCRIBING",
    "jobId": "job_xyz789",
    "estimatedCompletion": "2025-01-15T10:35:00.000Z"
  }
}
```

### 5.5 Get Lesson Status

```http
GET /lessons/:id/status
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "les_abc123",
    "status": "GENERATING",
    "progress": {
      "step": "generating",
      "percent": 75,
      "message": "Generating practice plan..."
    },
    "estimatedCompletion": "2025-01-15T10:35:00.000Z"
  }
}
```

### 5.6 Delete Lesson

```http
DELETE /lessons/:id
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "les_abc123",
    "deleted": true
  }
}
```

---

## 6. Output Endpoints

### 6.1 Get Output

```http
GET /outputs/:id
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "out_abc123",
    "lessonId": "les_abc123",
    "type": "PRACTICE_PLAN",
    "content": "## Week of January 13th\n\n### Monday (30 minutes)...",
    "editedContent": null,
    "sentAt": null,
    "createdAt": "2025-01-13T16:45:00.000Z",
    "updatedAt": "2025-01-13T16:45:00.000Z"
  }
}
```

### 6.2 Update Output (Edit)

```http
PATCH /outputs/:id
```

**Request Body:**
```json
{
  "editedContent": "## Week of January 13th\n\n### Monday (25 minutes)..."
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "out_abc123",
    "type": "PRACTICE_PLAN",
    "content": "## Week of January 13th\n\n### Monday (30 minutes)...",
    "editedContent": "## Week of January 13th\n\n### Monday (25 minutes)...",
    "updatedAt": "2025-01-15T10:30:00.000Z"
  }
}
```

### 6.3 Regenerate Output

```http
POST /outputs/:id/regenerate
```

**Request Body (optional):**
```json
{
  "instructions": "Make the practice plan more detailed for each day"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "out_abc123",
    "type": "PRACTICE_PLAN",
    "content": "## Detailed Practice Plan - Week of January 13th...",
    "editedContent": null,
    "updatedAt": "2025-01-15T10:30:00.000Z"
  }
}
```

### 6.4 Mark Output as Sent

```http
POST /outputs/:id/sent
```

**Request Body:**
```json
{
  "sentTo": "sarah.wilson@example.com",
  "sentVia": "clipboard"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "out_abc123",
    "sentAt": "2025-01-15T10:30:00.000Z"
  }
}
```

---

## 7. Upload Endpoints

### 7.1 Initiate Multipart Upload

```http
POST /uploads/initiate
```

**Request Body:**
```json
{
  "lessonId": "les_abc123",
  "filename": "lesson_recording.m4a",
  "contentType": "audio/m4a",
  "fileSize": 45000000
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "uploadId": "upload_abc123",
    "key": "audio/user_123/les_abc123/original.m4a",
    "partSize": 5242880,
    "totalParts": 9
  }
}
```

### 7.2 Get Part Upload URL

```http
GET /uploads/:uploadId/part/:partNumber
```

**Response:**
```json
{
  "success": true,
  "data": {
    "url": "https://s3.amazonaws.com/notebynote/...",
    "expiresAt": "2025-01-15T11:30:00.000Z"
  }
}
```

### 7.3 Complete Multipart Upload

```http
POST /uploads/:uploadId/complete
```

**Request Body:**
```json
{
  "lessonId": "les_abc123",
  "parts": [
    { "ETag": "\"abc123\"", "PartNumber": 1 },
    { "ETag": "\"def456\"", "PartNumber": 2 }
  ]
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "uploadId": "upload_abc123",
    "audioUrl": "https://cdn.notebynote.com/audio/...",
    "status": "completed"
  }
}
```

### 7.4 Abort Multipart Upload

```http
DELETE /uploads/:uploadId
```

**Response:**
```json
{
  "success": true,
  "data": {
    "uploadId": "upload_abc123",
    "aborted": true
  }
}
```

---

## 8. Dashboard Endpoints

### 8.1 Get Dashboard Summary

```http
GET /dashboard
```

**Response:**
```json
{
  "success": true,
  "data": {
    "overview": {
      "totalStudents": 25,
      "totalLessons": 150,
      "lessonsThisWeek": 12,
      "pendingOutputs": 3
    },
    "recentLessons": [
      {
        "id": "les_abc123",
        "student": {
          "id": "stu_abc123",
          "firstName": "Emma",
          "lastName": "Wilson"
        },
        "status": "COMPLETED",
        "createdAt": "2025-01-13T16:00:00.000Z"
      }
    ],
    "upcomingLessons": [
      {
        "student": {
          "id": "stu_xyz789",
          "firstName": "James",
          "lastName": "Chen"
        },
        "scheduledDay": "THURSDAY",
        "scheduledTime": "15:00"
      }
    ],
    "usage": {
      "lessonsThisMonth": 15,
      "lessonsLimit": 50,
      "percentUsed": 30,
      "resetDate": "2025-02-01T00:00:00.000Z"
    }
  }
}
```

---

## 9. Search Endpoints

### 9.1 Global Search

```http
GET /search
```

**Query Parameters:**
| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `q` | string | required | Search query |
| `type` | string | all | student, lesson, transcript |
| `limit` | integer | 10 | Results per type |

**Response:**
```json
{
  "success": true,
  "data": {
    "students": [
      {
        "id": "stu_abc123",
        "firstName": "Emma",
        "lastName": "Wilson",
        "instrument": "PIANO",
        "highlight": "Emma Wilson - Piano"
      }
    ],
    "lessons": [
      {
        "id": "les_abc123",
        "studentName": "Emma Wilson",
        "date": "2025-01-13",
        "highlight": "...worked on FÃ¼r Elise..."
      }
    ],
    "transcripts": [
      {
        "lessonId": "les_abc123",
        "studentName": "Emma Wilson",
        "highlight": "...let's try the FÃ¼r Elise passage again..."
      }
    ]
  }
}
```

---

## 10. Settings Endpoints

### 10.1 Get User Settings

```http
GET /settings
```

**Response:**
```json
{
  "success": true,
  "data": {
    "notifications": {
      "emailOnComplete": true,
      "pushOnComplete": true
    },
    "defaults": {
      "practiceDaysPerWeek": 7,
      "practiceMinutesPerDay": 30,
      "emailTemplate": "professional"
    },
    "preferences": {
      "timezone": "America/New_York",
      "language": "en",
      "dateFormat": "MM/DD/YYYY"
    }
  }
}
```

### 10.2 Update User Settings

```http
PATCH /settings
```

**Request Body:**
```json
{
  "defaults": {
    "practiceDaysPerWeek": 6,
    "practiceMinutesPerDay": 45
  }
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "updated": true
  }
}
```

---

## 11. WebSocket Events

### 11.1 Connection

```javascript
// Client connection
const socket = io('wss://api.notebynote.com', {
  auth: {
    token: 'clerk_jwt_token'
  }
});
```

### 11.2 Subscribe to Lesson

```javascript
// Subscribe
socket.emit('lesson:subscribe', { lessonId: 'les_abc123' });

// Unsubscribe
socket.emit('lesson:unsubscribe', { lessonId: 'les_abc123' });
```

### 11.3 Server Events

**lesson:status**
```json
{
  "lessonId": "les_abc123",
  "status": "TRANSCRIBING",
  "progress": {
    "percent": 45,
    "message": "Transcribing audio..."
  }
}
```

**lesson:completed**
```json
{
  "lessonId": "les_abc123",
  "status": "COMPLETED",
  "outputs": {
    "studentRecap": "Great lesson today...",
    "practicePlan": "## Week of January 13th...",
    "parentEmail": "Dear Sarah..."
  }
}
```

**lesson:error**
```json
{
  "lessonId": "les_abc123",
  "status": "FAILED",
  "error": {
    "code": "TRANSCRIPTION_FAILED",
    "message": "Unable to transcribe audio"
  }
}
```

---

## 12. Error Reference

### 12.1 Error Codes

| Code | HTTP | Description |
|------|------|-------------|
| `VALIDATION_ERROR` | 400 | Request validation failed |
| `INVALID_JSON` | 400 | Malformed JSON body |
| `UNAUTHORIZED` | 401 | Missing/invalid auth token |
| `TOKEN_EXPIRED` | 401 | JWT token has expired |
| `FORBIDDEN` | 403 | Insufficient permissions |
| `NOT_FOUND` | 404 | Resource not found |
| `STUDENT_NOT_FOUND` | 404 | Student ID not found |
| `LESSON_NOT_FOUND` | 404 | Lesson ID not found |
| `CONFLICT` | 409 | Resource conflict |
| `DUPLICATE_EMAIL` | 409 | Email already exists |
| `RATE_LIMITED` | 429 | Too many requests |
| `QUOTA_EXCEEDED` | 429 | Plan quota exceeded |
| `UPLOAD_FAILED` | 500 | File upload failed |
| `TRANSCRIPTION_FAILED` | 500 | Whisper API error |
| `GENERATION_FAILED` | 500 | LLM generation error |
| `INTERNAL_ERROR` | 500 | Unexpected server error |
| `SERVICE_UNAVAILABLE` | 503 | External service down |

### 12.2 Rate Limits

| Endpoint Pattern | Limit | Window |
|-----------------|-------|--------|
| `*` (general) | 100 | 1 minute |
| `/lessons` POST | 10 | 1 minute |
| `/outputs/*/regenerate` | 5 | 1 minute |
| `/search` | 30 | 1 minute |

---

## 13. SDK Examples

### 13.1 TypeScript Client

```typescript
// lib/api-client.ts

import axios, { AxiosInstance } from 'axios';

interface ApiResponse<T> {
  success: boolean;
  data: T;
  error?: {
    code: string;
    message: string;
  };
}

class NoteBynoteClient {
  private client: AxiosInstance;

  constructor(token: string) {
    this.client = axios.create({
      baseURL: 'https://api.notebynote.com/v1',
      headers: {
        Authorization: `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    });
  }

  // Students
  async listStudents(params?: { page?: number; search?: string }) {
    const { data } = await this.client.get<ApiResponse<Student[]>>('/students', { params });
    return data;
  }

  async createStudent(student: CreateStudentInput) {
    const { data } = await this.client.post<ApiResponse<Student>>('/students', student);
    return data;
  }

  // Lessons
  async createLesson(studentId: string) {
    const { data } = await this.client.post<ApiResponse<Lesson>>('/lessons', { studentId });
    return data;
  }

  async getLesson(lessonId: string) {
    const { data } = await this.client.get<ApiResponse<LessonDetail>>(`/lessons/${lessonId}`);
    return data;
  }

  // Outputs
  async updateOutput(outputId: string, editedContent: string) {
    const { data } = await this.client.patch<ApiResponse<Output>>(`/outputs/${outputId}`, {
      editedContent,
    });
    return data;
  }
}

export default NoteBynoteClient;
```

### 13.2 Swift Client

```swift
// Services/APIClient.swift

import Foundation

class APIClient {
    private let baseURL = URL(string: "https://api.notebynote.com/v1")!
    private let session: URLSession
    private var token: String?
    
    init() {
        let config = URLSessionConfiguration.default
        config.timeoutIntervalForRequest = 30
        self.session = URLSession(configuration: config)
    }
    
    func setToken(_ token: String) {
        self.token = token
    }
    
    // MARK: - Students
    
    func listStudents() async throws -> [Student] {
        let request = try makeRequest(path: "/students", method: "GET")
        let response: APIResponse<[Student]> = try await perform(request)
        return response.data
    }
    
    func createStudent(_ input: CreateStudentInput) async throws -> Student {
        var request = try makeRequest(path: "/students", method: "POST")
        request.httpBody = try JSONEncoder().encode(input)
        let response: APIResponse<Student> = try await perform(request)
        return response.data
    }
    
    // MARK: - Lessons
    
    func createLesson(studentId: String) async throws -> Lesson {
        var request = try makeRequest(path: "/lessons", method: "POST")
        request.httpBody = try JSONEncoder().encode(["studentId": studentId])
        let response: APIResponse<Lesson> = try await perform(request)
        return response.data
    }
    
    // MARK: - Helpers
    
    private func makeRequest(path: String, method: String) throws -> URLRequest {
        guard let token = token else {
            throw APIError.unauthorized
        }
        
        var request = URLRequest(url: baseURL.appendingPathComponent(path))
        request.httpMethod = method
        request.setValue("Bearer \(token)", forHTTPHeaderField: "Authorization")
        request.setValue("application/json", forHTTPHeaderField: "Content-Type")
        return request
    }
    
    private func perform<T: Decodable>(_ request: URLRequest) async throws -> T {
        let (data, response) = try await session.data(for: request)
        
        guard let httpResponse = response as? HTTPURLResponse else {
            throw APIError.invalidResponse
        }
        
        if httpResponse.statusCode >= 400 {
            let error = try JSONDecoder().decode(APIErrorResponse.self, from: data)
            throw APIError.serverError(error.error.code, error.error.message)
        }
        
        return try JSONDecoder().decode(T.self, from: data)
    }
}
```

---

This API specification provides complete documentation for all endpoints needed to build the Note By Note MVP. All responses follow consistent patterns and include comprehensive error handling.


# Database Schema Specification

## Note By Note - Data Models & Database Design

**Version:** 1.0.0-MVP  
**Database:** PostgreSQL 15+  
**ORM:** Prisma 5.8+  

---

## 1. Overview

### 1.1 Design Principles

1. **Normalization**: Third normal form (3NF) for data integrity
2. **Soft Deletes**: Preserve data with `deletedAt` timestamps
3. **Audit Trail**: Track all significant changes
4. **Performance**: Strategic indexes for common queries
5. **Scalability**: Design for horizontal partitioning if needed

### 1.2 Naming Conventions

| Element | Convention | Example |
|---------|------------|---------|
| Tables | PascalCase | `Student`, `Lesson` |
| Columns | camelCase | `firstName`, `parentEmail` |
| Primary Keys | `id` | `id` |
| Foreign Keys | `{table}Id` | `studentId`, `userId` |
| Indexes | `idx_{table}_{columns}` | `idx_student_userId` |
| Enums | UPPER_SNAKE_CASE | `INTERMEDIATE`, `PIANO` |

---

## 2. Entity Relationship Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           NOTE BY NOTE - ERD                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚     User     â”‚
                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                              â”‚ id        PK â”‚
                              â”‚ clerkId   UK â”‚
                              â”‚ email     UK â”‚
                              â”‚ firstName    â”‚
                              â”‚ lastName     â”‚
                              â”‚ studioName   â”‚
                              â”‚ plan         â”‚
                              â”‚ lessonsMonth â”‚
                              â”‚ resetAt      â”‚
                              â”‚ createdAt    â”‚
                              â”‚ updatedAt    â”‚
                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                â”‚                â”‚
                    â–¼                â”‚                â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚   Student    â”‚          â”‚       â”‚   Settings   â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚ id        PK â”‚          â”‚       â”‚ id        PK â”‚
           â”‚ userId    FK â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚ userId    FK â”‚â—„â”€â”€â”€â”€â”€â”
           â”‚ firstName    â”‚          â”‚       â”‚ notificationsâ”‚      â”‚
           â”‚ lastName     â”‚          â”‚       â”‚ defaults     â”‚      â”‚
           â”‚ email        â”‚          â”‚       â”‚ preferences  â”‚      â”‚
           â”‚ parentFirst  â”‚          â”‚       â”‚ createdAt    â”‚      â”‚
           â”‚ parentLast   â”‚          â”‚       â”‚ updatedAt    â”‚      â”‚
           â”‚ parentEmail  â”‚          â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
           â”‚ instrument   â”‚          â”‚                             â”‚
           â”‚ skillLevel   â”‚          â”‚                             â”‚
           â”‚ lessonDay    â”‚          â”‚                             â”‚
           â”‚ lessonTime   â”‚          â”‚                             â”‚
           â”‚ notes        â”‚          â”‚                             â”‚
           â”‚ deletedAt    â”‚          â”‚                             â”‚
           â”‚ createdAt    â”‚          â”‚                             â”‚
           â”‚ updatedAt    â”‚          â”‚                             â”‚
           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚                             â”‚
                  â”‚                  â”‚                             â”‚
                  â”‚                  â”‚                             â”‚
                  â–¼                  â”‚                             â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚                             â”‚
           â”‚    Lesson    â”‚          â”‚                             â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚                             â”‚
           â”‚ id        PK â”‚          â”‚                             â”‚
           â”‚ studentId FK â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚
           â”‚ userId    FK â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
           â”‚ audioUrl     â”‚                                        â”‚
           â”‚ audioLength  â”‚                                        â”‚
           â”‚ audioSize    â”‚                                        â”‚
           â”‚ status       â”‚                                        â”‚
           â”‚ errorMessage â”‚                                        â”‚
           â”‚ uploadedAt   â”‚                                        â”‚
           â”‚ transcribedAtâ”‚                                        â”‚
           â”‚ generatedAt  â”‚                                        â”‚
           â”‚ createdAt    â”‚                                        â”‚
           â”‚ updatedAt    â”‚                                        â”‚
           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
                  â”‚                                                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
         â”‚                â”‚                                        â”‚
         â–¼                â–¼                                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  Transcript  â”‚  â”‚    Output    â”‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                 â”‚
â”‚ id        PK â”‚  â”‚ id        PK â”‚                                 â”‚
â”‚ lessonId  FK â”‚  â”‚ lessonId  FK â”‚                                 â”‚
â”‚ fullText     â”‚  â”‚ type         â”‚                                 â”‚
â”‚ segments JSONâ”‚  â”‚ content      â”‚                                 â”‚
â”‚ wordCount    â”‚  â”‚ editedContentâ”‚                                 â”‚
â”‚ language     â”‚  â”‚ sentAt       â”‚                                 â”‚
â”‚ createdAt    â”‚  â”‚ createdAt    â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ updatedAt    â”‚                                 â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
                                                                   â”‚
                                                                   â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
                              â”‚   AuditLog   â”‚                     â”‚
                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
                              â”‚ id        PK â”‚                     â”‚
                              â”‚ userId    FK â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ action       â”‚
                              â”‚ entityType   â”‚
                              â”‚ entityId     â”‚
                              â”‚ metadata JSONâ”‚
                              â”‚ ipAddress    â”‚
                              â”‚ userAgent    â”‚
                              â”‚ createdAt    â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Complete Prisma Schema

```prisma
// prisma/schema.prisma

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum Plan {
  FREE_TRIAL
  SOLO
  STUDIO
  ENTERPRISE
}

enum Instrument {
  PIANO
  VIOLIN
  VIOLA
  CELLO
  GUITAR
  BASS
  VOICE
  DRUMS
  FLUTE
  CLARINET
  SAXOPHONE
  TRUMPET
  TROMBONE
  FRENCH_HORN
  OBOE
  BASSOON
  HARP
  OTHER
}

enum SkillLevel {
  BEGINNER
  EARLY_INTERMEDIATE
  INTERMEDIATE
  LATE_INTERMEDIATE
  ADVANCED
  PROFESSIONAL
}

enum LessonDay {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum LessonStatus {
  CREATED       // Initial state
  RECORDING     // Currently recording (client-side)
  UPLOADING     // Uploading to S3
  TRANSCRIBING  // Whisper processing
  GENERATING    // LLM generating outputs
  COMPLETED     // All outputs ready
  FAILED        // Processing failed
}

enum OutputType {
  STUDENT_RECAP
  PRACTICE_PLAN
  PARENT_EMAIL
}

// ============================================================================
// USER MODEL
// ============================================================================

/// Represents a registered user (music teacher)
model User {
  id          String    @id @default(cuid())
  
  /// Clerk user ID for authentication
  clerkId     String    @unique
  
  /// Primary email address
  email       String    @unique
  
  /// Personal information
  firstName   String?
  lastName    String?
  
  /// Business information
  studioName  String?
  
  /// Subscription plan
  plan        Plan      @default(FREE_TRIAL)
  
  /// Usage tracking for billing
  lessonsThisMonth  Int       @default(0)
  lessonsResetAt    DateTime  @default(now())
  
  /// Relations
  students    Student[]
  lessons     Lesson[]
  settings    Settings?
  auditLogs   AuditLog[]
  
  /// Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([clerkId])
  @@index([email])
  @@map("users")
}

// ============================================================================
// STUDENT MODEL
// ============================================================================

/// Represents a student being taught by a user
model Student {
  id              String      @id @default(cuid())
  
  /// Owner relationship
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  /// Student personal info
  firstName       String      @db.VarChar(100)
  lastName        String      @db.VarChar(100)
  email           String?     @db.VarChar(255)
  
  /// Parent/Guardian info
  parentFirstName String?     @db.VarChar(100)
  parentLastName  String?     @db.VarChar(100)
  parentEmail     String      @db.VarChar(255)
  
  /// Musical profile
  instrument      Instrument
  skillLevel      SkillLevel
  
  /// Scheduling
  lessonDay       LessonDay?
  lessonTime      String?     @db.VarChar(5) // HH:MM format
  
  /// Private notes (not shared with parents)
  notes           String?     @db.Text
  
  /// Relations
  lessons         Lesson[]
  
  /// Soft delete support
  deletedAt       DateTime?
  
  /// Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([userId])
  @@index([userId, deletedAt])
  @@index([parentEmail])
  @@map("students")
}

// ============================================================================
// LESSON MODEL
// ============================================================================

/// Represents a recorded lesson session
model Lesson {
  id              String        @id @default(cuid())
  
  /// Relationships
  studentId       String
  student         Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  /// Audio file information
  audioUrl        String?       @db.VarChar(500)
  audioLength     Int?          // Duration in seconds
  audioSize       Int?          // File size in bytes
  
  /// Processing status
  status          LessonStatus  @default(CREATED)
  errorMessage    String?       @db.Text
  
  /// Processing timestamps
  uploadedAt      DateTime?
  transcribedAt   DateTime?
  generatedAt     DateTime?
  
  /// Relations
  transcript      Transcript?
  outputs         Output[]
  
  /// Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([userId])
  @@index([studentId])
  @@index([userId, status])
  @@index([createdAt(sort: Desc)])
  @@map("lessons")
}

// ============================================================================
// TRANSCRIPT MODEL
// ============================================================================

/// Stores the transcription of a lesson's audio
model Transcript {
  id              String    @id @default(cuid())
  
  /// One-to-one relationship with lesson
  lessonId        String    @unique
  lesson          Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  /// Transcription content
  fullText        String    @db.Text
  
  /// Structured segments with timestamps
  /// Format: [{ start: number, end: number, text: string, speaker?: string }]
  segments        Json      @db.JsonB
  
  /// Metadata
  wordCount       Int
  language        String    @default("en") @db.VarChar(10)
  
  /// AI processing metadata
  modelUsed       String?   @db.VarChar(50) // e.g., "whisper-1"
  processingTime  Int?      // Processing time in ms
  
  /// Timestamps
  createdAt       DateTime  @default(now())
  
  @@index([lessonId])
  @@map("transcripts")
}

// ============================================================================
// OUTPUT MODEL
// ============================================================================

/// Stores AI-generated outputs (recap, practice plan, email)
model Output {
  id              String      @id @default(cuid())
  
  /// Relationship with lesson
  lessonId        String
  lesson          Lesson      @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  /// Output type
  type            OutputType
  
  /// Content
  content         String      @db.Text   // Original AI-generated content
  editedContent   String?     @db.Text   // User-modified content (if any)
  
  /// Delivery tracking
  sentAt          DateTime?
  sentTo          String?     @db.VarChar(255)
  sentVia         String?     @db.VarChar(50) // "email", "clipboard", etc.
  
  /// AI processing metadata
  modelUsed       String?     @db.VarChar(50)
  promptTokens    Int?
  completionTokens Int?
  
  /// Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  /// Unique constraint: one output per type per lesson
  @@unique([lessonId, type])
  @@index([lessonId])
  @@index([type])
  @@map("outputs")
}

// ============================================================================
// SETTINGS MODEL
// ============================================================================

/// User preferences and settings
model Settings {
  id              String    @id @default(cuid())
  
  /// One-to-one relationship with user
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  /// Notification preferences
  /// Format: { emailOnComplete: boolean, pushOnComplete: boolean, ... }
  notifications   Json      @default("{\"emailOnComplete\":true,\"pushOnComplete\":true}") @db.JsonB
  
  /// Default values for new content
  /// Format: { practiceDaysPerWeek: number, practiceMinutesPerDay: number, ... }
  defaults        Json      @default("{\"practiceDaysPerWeek\":7,\"practiceMinutesPerDay\":30}") @db.JsonB
  
  /// User preferences
  /// Format: { timezone: string, language: string, dateFormat: string }
  preferences     Json      @default("{\"timezone\":\"America/New_York\",\"language\":\"en\"}") @db.JsonB
  
  /// Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("settings")
}

// ============================================================================
// AUDIT LOG MODEL
// ============================================================================

/// Tracks significant user actions for compliance and debugging
model AuditLog {
  id          String    @id @default(cuid())
  
  /// Actor
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  /// Action details
  action      String    @db.VarChar(100) // e.g., "lesson.created", "output.sent"
  entityType  String    @db.VarChar(50)  // e.g., "lesson", "student"
  entityId    String    @db.VarChar(100)
  
  /// Additional context
  metadata    Json?     @db.JsonB
  
  /// Request information
  ipAddress   String?   @db.VarChar(45)  // IPv6 compatible
  userAgent   String?   @db.VarChar(500)
  
  /// Timestamp
  createdAt   DateTime  @default(now())
  
  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt(sort: Desc)])
  @@map("audit_logs")
}
```

---

## 4. SQL Migrations

### 4.1 Initial Migration

```sql
-- migrations/001_initial_schema.sql

-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Create ENUMs
CREATE TYPE "Plan" AS ENUM ('FREE_TRIAL', 'SOLO', 'STUDIO', 'ENTERPRISE');

CREATE TYPE "Instrument" AS ENUM (
  'PIANO', 'VIOLIN', 'VIOLA', 'CELLO', 'GUITAR', 'BASS', 'VOICE', 
  'DRUMS', 'FLUTE', 'CLARINET', 'SAXOPHONE', 'TRUMPET', 'TROMBONE',
  'FRENCH_HORN', 'OBOE', 'BASSOON', 'HARP', 'OTHER'
);

CREATE TYPE "SkillLevel" AS ENUM (
  'BEGINNER', 'EARLY_INTERMEDIATE', 'INTERMEDIATE', 
  'LATE_INTERMEDIATE', 'ADVANCED', 'PROFESSIONAL'
);

CREATE TYPE "LessonDay" AS ENUM (
  'MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 
  'FRIDAY', 'SATURDAY', 'SUNDAY'
);

CREATE TYPE "LessonStatus" AS ENUM (
  'CREATED', 'RECORDING', 'UPLOADING', 'TRANSCRIBING',
  'GENERATING', 'COMPLETED', 'FAILED'
);

CREATE TYPE "OutputType" AS ENUM (
  'STUDENT_RECAP', 'PRACTICE_PLAN', 'PARENT_EMAIL'
);

-- Users table
CREATE TABLE "users" (
  "id" TEXT NOT NULL DEFAULT gen_random_uuid()::text,
  "clerkId" TEXT NOT NULL,
  "email" TEXT NOT NULL,
  "firstName" TEXT,
  "lastName" TEXT,
  "studioName" TEXT,
  "plan" "Plan" NOT NULL DEFAULT 'FREE_TRIAL',
  "lessonsThisMonth" INTEGER NOT NULL DEFAULT 0,
  "lessonsResetAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updatedAt" TIMESTAMP(3) NOT NULL,
  
  CONSTRAINT "users_pkey" PRIMARY KEY ("id")
);

CREATE UNIQUE INDEX "users_clerkId_key" ON "users"("clerkId");
CREATE UNIQUE INDEX "users_email_key" ON "users"("email");
CREATE INDEX "idx_users_clerkId" ON "users"("clerkId");
CREATE INDEX "idx_users_email" ON "users"("email");

-- Students table
CREATE TABLE "students" (
  "id" TEXT NOT NULL DEFAULT gen_random_uuid()::text,
  "userId" TEXT NOT NULL,
  "firstName" VARCHAR(100) NOT NULL,
  "lastName" VARCHAR(100) NOT NULL,
  "email" VARCHAR(255),
  "parentFirstName" VARCHAR(100),
  "parentLastName" VARCHAR(100),
  "parentEmail" VARCHAR(255) NOT NULL,
  "instrument" "Instrument" NOT NULL,
  "skillLevel" "SkillLevel" NOT NULL,
  "lessonDay" "LessonDay",
  "lessonTime" VARCHAR(5),
  "notes" TEXT,
  "deletedAt" TIMESTAMP(3),
  "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updatedAt" TIMESTAMP(3) NOT NULL,
  
  CONSTRAINT "students_pkey" PRIMARY KEY ("id"),
  CONSTRAINT "students_userId_fkey" FOREIGN KEY ("userId") 
    REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE INDEX "idx_students_userId" ON "students"("userId");
CREATE INDEX "idx_students_userId_deletedAt" ON "students"("userId", "deletedAt");
CREATE INDEX "idx_students_parentEmail" ON "students"("parentEmail");

-- Lessons table
CREATE TABLE "lessons" (
  "id" TEXT NOT NULL DEFAULT gen_random_uuid()::text,
  "studentId" TEXT NOT NULL,
  "userId" TEXT NOT NULL,
  "audioUrl" VARCHAR(500),
  "audioLength" INTEGER,
  "audioSize" INTEGER,
  "status" "LessonStatus" NOT NULL DEFAULT 'CREATED',
  "errorMessage" TEXT,
  "uploadedAt" TIMESTAMP(3),
  "transcribedAt" TIMESTAMP(3),
  "generatedAt" TIMESTAMP(3),
  "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updatedAt" TIMESTAMP(3) NOT NULL,
  
  CONSTRAINT "lessons_pkey" PRIMARY KEY ("id"),
  CONSTRAINT "lessons_studentId_fkey" FOREIGN KEY ("studentId")
    REFERENCES "students"("id") ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT "lessons_userId_fkey" FOREIGN KEY ("userId")
    REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE INDEX "idx_lessons_userId" ON "lessons"("userId");
CREATE INDEX "idx_lessons_studentId" ON "lessons"("studentId");
CREATE INDEX "idx_lessons_userId_status" ON "lessons"("userId", "status");
CREATE INDEX "idx_lessons_createdAt" ON "lessons"("createdAt" DESC);

-- Transcripts table
CREATE TABLE "transcripts" (
  "id" TEXT NOT NULL DEFAULT gen_random_uuid()::text,
  "lessonId" TEXT NOT NULL,
  "fullText" TEXT NOT NULL,
  "segments" JSONB NOT NULL,
  "wordCount" INTEGER NOT NULL,
  "language" VARCHAR(10) NOT NULL DEFAULT 'en',
  "modelUsed" VARCHAR(50),
  "processingTime" INTEGER,
  "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  
  CONSTRAINT "transcripts_pkey" PRIMARY KEY ("id"),
  CONSTRAINT "transcripts_lessonId_fkey" FOREIGN KEY ("lessonId")
    REFERENCES "lessons"("id") ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE UNIQUE INDEX "transcripts_lessonId_key" ON "transcripts"("lessonId");
CREATE INDEX "idx_transcripts_lessonId" ON "transcripts"("lessonId");

-- Outputs table
CREATE TABLE "outputs" (
  "id" TEXT NOT NULL DEFAULT gen_random_uuid()::text,
  "lessonId" TEXT NOT NULL,
  "type" "OutputType" NOT NULL,
  "content" TEXT NOT NULL,
  "editedContent" TEXT,
  "sentAt" TIMESTAMP(3),
  "sentTo" VARCHAR(255),
  "sentVia" VARCHAR(50),
  "modelUsed" VARCHAR(50),
  "promptTokens" INTEGER,
  "completionTokens" INTEGER,
  "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updatedAt" TIMESTAMP(3) NOT NULL,
  
  CONSTRAINT "outputs_pkey" PRIMARY KEY ("id"),
  CONSTRAINT "outputs_lessonId_fkey" FOREIGN KEY ("lessonId")
    REFERENCES "lessons"("id") ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE UNIQUE INDEX "outputs_lessonId_type_key" ON "outputs"("lessonId", "type");
CREATE INDEX "idx_outputs_lessonId" ON "outputs"("lessonId");
CREATE INDEX "idx_outputs_type" ON "outputs"("type");

-- Settings table
CREATE TABLE "settings" (
  "id" TEXT NOT NULL DEFAULT gen_random_uuid()::text,
  "userId" TEXT NOT NULL,
  "notifications" JSONB NOT NULL DEFAULT '{"emailOnComplete":true,"pushOnComplete":true}',
  "defaults" JSONB NOT NULL DEFAULT '{"practiceDaysPerWeek":7,"practiceMinutesPerDay":30}',
  "preferences" JSONB NOT NULL DEFAULT '{"timezone":"America/New_York","language":"en"}',
  "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "updatedAt" TIMESTAMP(3) NOT NULL,
  
  CONSTRAINT "settings_pkey" PRIMARY KEY ("id"),
  CONSTRAINT "settings_userId_fkey" FOREIGN KEY ("userId")
    REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE UNIQUE INDEX "settings_userId_key" ON "settings"("userId");

-- Audit logs table
CREATE TABLE "audit_logs" (
  "id" TEXT NOT NULL DEFAULT gen_random_uuid()::text,
  "userId" TEXT NOT NULL,
  "action" VARCHAR(100) NOT NULL,
  "entityType" VARCHAR(50) NOT NULL,
  "entityId" VARCHAR(100) NOT NULL,
  "metadata" JSONB,
  "ipAddress" VARCHAR(45),
  "userAgent" VARCHAR(500),
  "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  
  CONSTRAINT "audit_logs_pkey" PRIMARY KEY ("id"),
  CONSTRAINT "audit_logs_userId_fkey" FOREIGN KEY ("userId")
    REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE INDEX "idx_audit_logs_userId" ON "audit_logs"("userId");
CREATE INDEX "idx_audit_logs_entity" ON "audit_logs"("entityType", "entityId");
CREATE INDEX "idx_audit_logs_action" ON "audit_logs"("action");
CREATE INDEX "idx_audit_logs_createdAt" ON "audit_logs"("createdAt" DESC);

-- Trigger for updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW."updatedAt" = CURRENT_TIMESTAMP;
  RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON "users"
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_students_updated_at BEFORE UPDATE ON "students"
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_lessons_updated_at BEFORE UPDATE ON "lessons"
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_outputs_updated_at BEFORE UPDATE ON "outputs"
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_settings_updated_at BEFORE UPDATE ON "settings"
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 4.2 Full-Text Search Migration

```sql
-- migrations/002_full_text_search.sql

-- Add full-text search to transcripts
ALTER TABLE "transcripts" ADD COLUMN "searchVector" tsvector;

CREATE INDEX "idx_transcripts_search" ON "transcripts" USING GIN("searchVector");

-- Function to update search vector
CREATE OR REPLACE FUNCTION update_transcript_search_vector()
RETURNS TRIGGER AS $$
BEGIN
  NEW."searchVector" = to_tsvector('english', NEW."fullText");
  RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_transcript_search
  BEFORE INSERT OR UPDATE OF "fullText" ON "transcripts"
  FOR EACH ROW EXECUTE FUNCTION update_transcript_search_vector();

-- Update existing records
UPDATE "transcripts" SET "searchVector" = to_tsvector('english', "fullText");
```

---

## 5. TypeScript Types

```typescript
// packages/shared/src/types/database.ts

// ============================================================================
// ENUMS
// ============================================================================

export enum Plan {
  FREE_TRIAL = 'FREE_TRIAL',
  SOLO = 'SOLO',
  STUDIO = 'STUDIO',
  ENTERPRISE = 'ENTERPRISE',
}

export enum Instrument {
  PIANO = 'PIANO',
  VIOLIN = 'VIOLIN',
  VIOLA = 'VIOLA',
  CELLO = 'CELLO',
  GUITAR = 'GUITAR',
  BASS = 'BASS',
  VOICE = 'VOICE',
  DRUMS = 'DRUMS',
  FLUTE = 'FLUTE',
  CLARINET = 'CLARINET',
  SAXOPHONE = 'SAXOPHONE',
  TRUMPET = 'TRUMPET',
  TROMBONE = 'TROMBONE',
  FRENCH_HORN = 'FRENCH_HORN',
  OBOE = 'OBOE',
  BASSOON = 'BASSOON',
  HARP = 'HARP',
  OTHER = 'OTHER',
}

export enum SkillLevel {
  BEGINNER = 'BEGINNER',
  EARLY_INTERMEDIATE = 'EARLY_INTERMEDIATE',
  INTERMEDIATE = 'INTERMEDIATE',
  LATE_INTERMEDIATE = 'LATE_INTERMEDIATE',
  ADVANCED = 'ADVANCED',
  PROFESSIONAL = 'PROFESSIONAL',
}

export enum LessonDay {
  MONDAY = 'MONDAY',
  TUESDAY = 'TUESDAY',
  WEDNESDAY = 'WEDNESDAY',
  THURSDAY = 'THURSDAY',
  FRIDAY = 'FRIDAY',
  SATURDAY = 'SATURDAY',
  SUNDAY = 'SUNDAY',
}

export enum LessonStatus {
  CREATED = 'CREATED',
  RECORDING = 'RECORDING',
  UPLOADING = 'UPLOADING',
  TRANSCRIBING = 'TRANSCRIBING',
  GENERATING = 'GENERATING',
  COMPLETED = 'COMPLETED',
  FAILED = 'FAILED',
}

export enum OutputType {
  STUDENT_RECAP = 'STUDENT_RECAP',
  PRACTICE_PLAN = 'PRACTICE_PLAN',
  PARENT_EMAIL = 'PARENT_EMAIL',
}

// ============================================================================
// BASE INTERFACES
// ============================================================================

export interface User {
  id: string;
  clerkId: string;
  email: string;
  firstName: string | null;
  lastName: string | null;
  studioName: string | null;
  plan: Plan;
  lessonsThisMonth: number;
  lessonsResetAt: Date;
  createdAt: Date;
  updatedAt: Date;
}

export interface Student {
  id: string;
  userId: string;
  firstName: string;
  lastName: string;
  email: string | null;
  parentFirstName: string | null;
  parentLastName: string | null;
  parentEmail: string;
  instrument: Instrument;
  skillLevel: SkillLevel;
  lessonDay: LessonDay | null;
  lessonTime: string | null;
  notes: string | null;
  deletedAt: Date | null;
  createdAt: Date;
  updatedAt: Date;
}

export interface Lesson {
  id: string;
  studentId: string;
  userId: string;
  audioUrl: string | null;
  audioLength: number | null;
  audioSize: number | null;
  status: LessonStatus;
  errorMessage: string | null;
  uploadedAt: Date | null;
  transcribedAt: Date | null;
  generatedAt: Date | null;
  createdAt: Date;
  updatedAt: Date;
}

export interface TranscriptSegment {
  start: number;
  end: number;
  text: string;
  speaker?: 'teacher' | 'student';
}

export interface Transcript {
  id: string;
  lessonId: string;
  fullText: string;
  segments: TranscriptSegment[];
  wordCount: number;
  language: string;
  modelUsed: string | null;
  processingTime: number | null;
  createdAt: Date;
}

export interface Output {
  id: string;
  lessonId: string;
  type: OutputType;
  content: string;
  editedContent: string | null;
  sentAt: Date | null;
  sentTo: string | null;
  sentVia: string | null;
  modelUsed: string | null;
  promptTokens: number | null;
  completionTokens: number | null;
  createdAt: Date;
  updatedAt: Date;
}

export interface NotificationSettings {
  emailOnComplete: boolean;
  pushOnComplete: boolean;
}

export interface DefaultSettings {
  practiceDaysPerWeek: number;
  practiceMinutesPerDay: number;
  emailTemplate?: string;
}

export interface UserPreferences {
  timezone: string;
  language: string;
  dateFormat?: string;
}

export interface Settings {
  id: string;
  userId: string;
  notifications: NotificationSettings;
  defaults: DefaultSettings;
  preferences: UserPreferences;
  createdAt: Date;
  updatedAt: Date;
}

export interface AuditLog {
  id: string;
  userId: string;
  action: string;
  entityType: string;
  entityId: string;
  metadata: Record<string, unknown> | null;
  ipAddress: string | null;
  userAgent: string | null;
  createdAt: Date;
}

// ============================================================================
// EXTENDED INTERFACES (with relations)
// ============================================================================

export interface StudentWithStats extends Student {
  lessonCount: number;
  lastLessonAt: Date | null;
}

export interface LessonWithRelations extends Lesson {
  student: Pick<Student, 'id' | 'firstName' | 'lastName' | 'instrument' | 'skillLevel'>;
  transcript?: Transcript;
  outputs: Output[];
}

export interface UserWithUsage extends User {
  usage: {
    lessonsThisMonth: number;
    lessonsLimit: number;
    resetDate: Date;
  };
}

// ============================================================================
// INPUT TYPES
// ============================================================================

export interface CreateStudentInput {
  firstName: string;
  lastName: string;
  email?: string;
  parentFirstName?: string;
  parentLastName?: string;
  parentEmail: string;
  instrument: Instrument;
  skillLevel: SkillLevel;
  lessonDay?: LessonDay;
  lessonTime?: string;
  notes?: string;
}

export interface UpdateStudentInput {
  firstName?: string;
  lastName?: string;
  email?: string;
  parentFirstName?: string;
  parentLastName?: string;
  parentEmail?: string;
  instrument?: Instrument;
  skillLevel?: SkillLevel;
  lessonDay?: LessonDay | null;
  lessonTime?: string | null;
  notes?: string | null;
}

export interface CreateLessonInput {
  studentId: string;
}

export interface UpdateOutputInput {
  editedContent: string;
}
```

---

## 6. Seed Data

```typescript
// prisma/seed.ts

import { PrismaClient, Plan, Instrument, SkillLevel, LessonDay } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
  // Create demo user
  const user = await prisma.user.upsert({
    where: { email: 'demo@notebynote.com' },
    update: {},
    create: {
      clerkId: 'demo_clerk_id',
      email: 'demo@notebynote.com',
      firstName: 'Demo',
      lastName: 'Teacher',
      studioName: 'Demo Music Studio',
      plan: Plan.SOLO,
      settings: {
        create: {
          notifications: { emailOnComplete: true, pushOnComplete: true },
          defaults: { practiceDaysPerWeek: 7, practiceMinutesPerDay: 30 },
          preferences: { timezone: 'America/New_York', language: 'en' },
        },
      },
    },
  });

  // Create demo students
  const students = await Promise.all([
    prisma.student.create({
      data: {
        userId: user.id,
        firstName: 'Emma',
        lastName: 'Wilson',
        parentFirstName: 'Sarah',
        parentLastName: 'Wilson',
        parentEmail: 'sarah.wilson@example.com',
        instrument: Instrument.PIANO,
        skillLevel: SkillLevel.INTERMEDIATE,
        lessonDay: LessonDay.WEDNESDAY,
        lessonTime: '16:00',
        notes: 'Working on ABRSM Grade 5. Excellent sight-reading skills.',
      },
    }),
    prisma.student.create({
      data: {
        userId: user.id,
        firstName: 'James',
        lastName: 'Chen',
        parentFirstName: 'Michael',
        parentLastName: 'Chen',
        parentEmail: 'michael.chen@example.com',
        instrument: Instrument.VIOLIN,
        skillLevel: SkillLevel.BEGINNER,
        lessonDay: LessonDay.THURSDAY,
        lessonTime: '15:00',
        notes: 'Started lessons 2 months ago. Very enthusiastic.',
      },
    }),
    prisma.student.create({
      data: {
        userId: user.id,
        firstName: 'Olivia',
        lastName: 'Martinez',
        parentFirstName: 'Maria',
        parentLastName: 'Martinez',
        parentEmail: 'maria.martinez@example.com',
        instrument: Instrument.GUITAR,
        skillLevel: SkillLevel.ADVANCED,
        lessonDay: LessonDay.FRIDAY,
        lessonTime: '17:00',
        notes: 'Preparing for conservatory auditions.',
      },
    }),
  ]);

  console.log('Seeded database with:');
  console.log(`- 1 user: ${user.email}`);
  console.log(`- ${students.length} students`);
}

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
```

---

## 7. Query Examples

```typescript
// Common database queries for reference

// Get all students for a user (excluding soft-deleted)
const students = await prisma.student.findMany({
  where: {
    userId: user.id,
    deletedAt: null,
  },
  orderBy: { firstName: 'asc' },
});

// Get student with lesson count
const studentWithStats = await prisma.student.findUnique({
  where: { id: studentId },
  include: {
    _count: {
      select: { lessons: true },
    },
  },
});

// Get lessons with related data
const lessons = await prisma.lesson.findMany({
  where: { userId: user.id },
  include: {
    student: {
      select: {
        id: true,
        firstName: true,
        lastName: true,
        instrument: true,
      },
    },
    transcript: true,
    outputs: true,
  },
  orderBy: { createdAt: 'desc' },
  take: 20,
});

// Full-text search in transcripts
const searchResults = await prisma.$queryRaw`
  SELECT t.*, l."studentId"
  FROM "transcripts" t
  JOIN "lessons" l ON t."lessonId" = l.id
  WHERE l."userId" = ${userId}
  AND t."searchVector" @@ plainto_tsquery('english', ${searchQuery})
  ORDER BY ts_rank(t."searchVector", plainto_tsquery('english', ${searchQuery})) DESC
  LIMIT 10
`;

// Get dashboard summary
const [studentCount, lessonStats] = await prisma.$transaction([
  prisma.student.count({
    where: { userId: user.id, deletedAt: null },
  }),
  prisma.lesson.groupBy({
    by: ['status'],
    where: { userId: user.id },
    _count: true,
  }),
]);
```

---

This database schema provides a solid foundation for the Note By Note MVP with proper normalization, indexing, and scalability considerations.


</exampleEpsilon>